<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2020-11-30T09:42:06.482Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AKS の送信トラフィック - Load Balancer SKU と SNAT オプション</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-load-balancer-sku-and-snat-options/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-load-balancer-sku-and-snat-options/</id>
    <published>2020-11-22T21:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.482Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure テクニカル サポート チームの桐井です。</p><p>Azure Kubernetes Service (AKS) にデプロイされた Pod からインターネットへの送信トラフィックでは、 Azure VM で外部接続をする場合と同様に、仮想ネットワークのプライベート IP アドレスからグローバル IP アドレスへの SNAT が必要です。 AKS 上のアプリケーションから外部の連携サービスへアクセスするというシナリオで、リソース グループ内に存在するパブリック IP アドレスのうちどれが送信元の IP アドレスとして使用されるのか、疑問に思われた方もいらっしゃるのではないかと思います。</p><p>Azure では外部接続の SNAT オプションを複数提供しており、 AKS ではクラスター作成時に選択した Load Balancer の SKU によって、使用される SNAT オプションが異なることがございます。この記事では、送信トラフィックに Azure Load Balancer が使用されている [^1] ことを前提に、 AKS の外部接続で使用される SNAT オプションについて、関係する Azure リソースの構成とともにご紹介いたします。</p><a id="more"></a><p>[^1]: 送信接続のために Azure Load Balancer ではなく、 User Defined Routing (UDR) を使用して、独自のゲートウェイ、ファイアウォールまたはプロキシを使用する構成もございます。詳細につきましては「<a href="https://docs.microsoft.com/ja-jp/azure/aks/egress-outboundtype" target="_blank" rel="noopener">ユーザー定義ルートを使用してクラスターのエグレスをカスタマイズする</a>」をご参照ください。</p><hr><h2 id="AKS-で使用される-Load-Balancer-SKU-と-SNAT-オプション"><a href="#AKS-で使用される-Load-Balancer-SKU-と-SNAT-オプション" class="headerlink" title="AKS で使用される Load Balancer SKU と SNAT オプション"></a>AKS で使用される Load Balancer SKU と SNAT オプション</h2><p>AKS では、 Azure Load Balancer の <strong>Standard SKU</strong> と <strong>Basic SKU</strong> の両方がサポートされています。 Load Balancer の SKU は、クラスター作成時のオプションで指定可能で、既定では Standard SKU が選択されます。</p><p>外部接続で使用される SNAT オプションを、クラスター作成時に選択した Load Balancer の SKU 、および <a href="https://kubernetes.io/ja/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Kubernetes Service</a> の作成状況ごとにまとめると、下記の表のようになります。 SNAT オプションに記載のシナリオは、下記 Azure Load Balancer のドキュメントに記載のシナリオと対応することを示します。</p><blockquote><p>Azure Load Balancer ドキュメント<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener">アウトバウンド接続での SNAT の使用</a></p></blockquote><p>Standard SKU を選択した場合は、クラスター作成と同時に Load Balancer リソースも作成されますが、 Basic SKU では <a href="https://kubernetes.io/ja/docs/concepts/services-networking/service/#loadbalancer" target="_blank" rel="noopener">Load Balancer タイプの Service</a> を作成するまで Load Balancer リソースは構成されないという点に注意が必要です。</p><table><thead><tr><th>Load Balancer SKU /<br>K8s Service の有無</th><th>SNAT オプション</th><th>SNAT アドレスに使用される IP アドレス</th></tr></thead><tbody><tr><td><strong>Standard</strong></td><td>外部 Load Balancer の送信規則による SNAT<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-virtual-machine-without-public-ip-and-behind-standard-public-load-balancer" target="_blank" rel="noopener">※シナリオ2</a></td><td>送信規則のフロントエンド IP アドレス</td></tr><tr><td><strong>Basic</strong> /<br>Service (LoadBalancer) が<strong>作成されていない</strong></td><td>Azure 既定の SNAT<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-3-virtual-machine-without-public-ip-and-behind-basic-load-balancer" target="_blank" rel="noopener">※シナリオ3</a></td><td>ランダムに割り当てられる IP アドレス</td></tr><tr><td><strong>Basic</strong> /<br>Service (LoadBalancer) が<strong>作成済み</strong></td><td>外部 Load Balancer の負荷分散規則による SNAT<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-virtual-machine-without-public-ip-and-behind-standard-public-load-balancer" target="_blank" rel="noopener">※シナリオ2</a></td><td>負荷分散規則のフロントエンド IP アドレス</td></tr></tbody></table><p>それでは Standard / Basic SKU それぞれを選択した AKS クラスターで、どのように SNAT が構成されるのか、実際に作成された Azure リソースをみながら確認していきましょう。 Pod からインターネットへ通信を行った際の送信元 IP アドレスの検証には、送信元のグローバル IP アドレスを確認できるサービス <a href="http://www.ifconfig.io/" target="_blank" rel="noopener">ifconfig.io</a> を使用します。</p><p>また、 Azure で提供される SNAT オプションにつきまして、弊社ネットワーク エンジニアによる解説記事がございます。どの SNAT オプションが使用されるか、状況別に判定するフローチャートがございますので、本記事とあわせてご参考にいただけますと幸いでございます。</p><blockquote><p>Japan Azure IaaS Core Support Blog<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/">Azure VM の外部接続 (SNAT) オプション まとめ</a></p></blockquote><h3 id="Standard-SKU-の場合"><a href="#Standard-SKU-の場合" class="headerlink" title="Standard SKU の場合"></a>Standard SKU の場合</h3><p>Standard SKU を使用した場合では、 AKS クラスターから送信されたトラフィックは Load Balancer の<strong>送信規則に従い SNAT</strong> されます。Pod からインターネットへの通信では、<strong>送信規則に割り当てられたフロントエンド IP アドレス</strong> が送信元のアドレスとなります。</p><blockquote><p>AKS ドキュメント<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/load-balancer-standard" target="_blank" rel="noopener">Azure Kubernetes Service (AKS) でパブリック Standard Load Balancer を使用する</a></p></blockquote><p>Standard SKU を選択しクラスターを作成すると、以下の画像のようにノード リソース グループの中に ロード バランサー および Public IP Address リソースが作成されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options01.png" alt="Standard SKU を使用し AKS クラスターを作成した場合のノード リソース グループ (MC_*) 内の様子"></p><p>ロード バランサー の送信規則には aksOutboundRule というルールが設定されており、一緒に作成された Public IP Address がフロントエンド IP アドレスとして指定されています。クラスターの送信トラフィックはこの送信規則にもとづいて SNAT されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options02.png" alt="ロード バランサー kubernetes のフロントエンド IP 構成と送信規則"></p><p>実際にクラスター上の Pod から通信を行うと、送信元のグローバル IP アドレスとして、送信規則のフロントエンドに割り当てられた IP アドレスが使用されていることが確認できます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options03.png" alt="Pod 内からインターネットへの通信で使用されている送信元 IP アドレスを確認"></p><h3 id="Basic-SKU-の場合"><a href="#Basic-SKU-の場合" class="headerlink" title="Basic SKU の場合"></a>Basic SKU の場合</h3><p>Basic SKU を使用した AKS クラスターでは、 LoadBalancer タイプの Service の有無によって、使用される SNAT オプションが異なり、送信元の IP アドレスの割り当て方法も変化します。</p><ul><li>LoadBalancer タイプの Service が作成されていない場合<ul><li>エージェント ノードの VMSS は、どの外部 Load Balancer のバックエンドにも存在しないため、 <strong>Azure 既定の SNAT</strong> により<strong>ランダムに割り当てられたパブリック IP</strong> が使用されます</li></ul></li><li>LoadBalancer タイプの Service を作成した場合<ul><li>ロード バランサー および Public IP Address リソースが作成され、<strong>負荷分散規則に割り当てられたフロントエンド IP アドレスで SNAT</strong> されます</li></ul></li></ul><blockquote><p>AKS ドキュメント<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/egress" target="_blank" rel="noopener">Azure Kubernetes Service (AKS) で Basic SKU ロード バランサーと共に、エグレス トラフィックに静的パブリック IP アドレスを使用する</a></p></blockquote><p>上記の動作について、文章だけではイメージしづらいと思いますので、ここではリソースのライフサイクルに沿って順に解説いたします。</p><h4 id="1-AKS-クラスターを作成した直後"><a href="#1-AKS-クラスターを作成した直後" class="headerlink" title="(1) AKS クラスターを作成した直後"></a>(1) AKS クラスターを作成した直後</h4><p>ノード リソース グループの中には、ロード バランサー および Public IP Address リソースは存在しません。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options04.png" alt="Basic SKU を使用し AKS クラスターを作成した場合のノード リソース グループ (MC_*) 内の様子"></p><p>この段階では、エージェント ノードの VMSS は、どの Load Balancer のメンバーではなく、外部接続では Azure 既定の SNAT が使用されます。SNAT に使用される IP アドレスは、 VM が存在する Azure リージョン内で使用されるグローバル IP アドレスの中から、未使用のアドレスがランダムに割り当てられます。 Pod から通信を行った場合も、ノード (VM) と同じ SNAT 構成が使用されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options05.png" alt="Load Balancer Service が存在しない場合: Azure 既定の SNAT が使用される"></p><p>Azure 既定の SNAT では、 VM / VMSS が再デプロイされると、割り当て済みの IP アドレスは解放され、新しいパブリック IP アドレスに変動します。 そのため、アプリケーションの接続先で IP アドレスによる通信制限を行っている場合、 IP アドレスの変動によりアクセスができなくなる恐れがありますのでご注意ください。</p><blockquote><p>詳細につきましてはこちらの記事もご参照ください<br>Japan Azure IaaS Core Support Blog<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/#Azure-%E6%97%A2%E5%AE%9A%E3%81%AE-SNAT">Azure VM の外部接続 (SNAT) オプション まとめ 「Azure 既定の SNAT」</a></p></blockquote><h4 id="2-Load-Balancer-Service-を作成した後"><a href="#2-Load-Balancer-Service-を作成した後" class="headerlink" title="(2) Load Balancer Service を作成した後"></a>(2) Load Balancer Service を作成した後</h4><p>AKS クラスターに <code>type: LoadBalancer</code> の Kubernetes Service を作成すると、自動的に ロード バランサー および Public IP Address リソースが作成されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options06.png" alt="Service を作成すると ロード バランサー / Public IP Address リソースが作成される"></p><p>エージェント ノードの VMSS がバックエンド プールとして割り当てられます。また、負荷分散規則が構成され、フロントエンド IP アドレスには、同時に作成された Public IP Address が割り当てられます。</p><p>Load Balancer が構成されると、クラスターの送信トラフィックは負荷分散規則にもとづいて SNAT されるようになります。 SNAT アドレスには、フロントエンド IP アドレスとして割り当てられた IP アドレスが使用されます。実際に Pod から通信を試すと、送信元の グローバル IP アドレスが Service の External-IP として表示されている IP アドレスと一致することが確認できます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options07.png" alt="Load Balancer の負荷分散規則により SNAT される。送信元 IP アドレスは Service の External-IP と一致する"></p><p>2 つ目以降の Service をデプロイした場合は、最初に割り当てられた IP アドレスが引き続き SNAT アドレスとして使用されます。例えば <code>Service A</code> 、 <code>Service B</code> という順番で Service を作成した場合、SNAT IP アドレスには <code>Service A</code> で割り当てられたパブリック IP アドレスが使用されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options08.png" alt="複数の Service を作成した場合は、最初に割り当てられた External-IP が SNAT アドレスとして使用される"></p><h4 id="3-Load-Balancer-Service-をすべて削除した後"><a href="#3-Load-Balancer-Service-をすべて削除した後" class="headerlink" title="(3) Load Balancer Service をすべて削除した後"></a>(3) Load Balancer Service をすべて削除した後</h4><p>すべての Load Balancer Service が削除されると、 ロード バランサー および Public IP Address リソースはノード リソース グループから自動的に削除されます。</p><p>上記の「<a href="#1-AKS-クラスターを作成した直後">(1) クラスターを作成した直後</a>」と同じ構成に戻ります。その後の Pod からの通信では、 Azure 既定の SNAT によってランダムに割り当てられたパブリック IP アドレスが送信元の IP アドレスとして使用されます。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>この記事では、 AKS の外部接続で使用される SNAT オプションについて Load Balancer の構成を踏まえて解説いたしました。</p><p>今回ご紹介しました Load Balancer のように、 AKS では Kubernetes の操作を介して、各種 Azure リソースが自動的に構成されます。動作の詳細や注意点について、対象の Azure サービスのドキュメントや、 VM の使用を想定した公開情報が参考になることもございますので、ぜひご参照いただけたらと思います。</p><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは！ Azure テクニカル サポート チームの桐井です。&lt;/p&gt;
&lt;p&gt;Azure Kubernetes Service (AKS) にデプロイされた Pod からインターネットへの送信トラフィックでは、 Azure VM で外部接続をする場合と同様に、仮想ネットワークのプライベート IP アドレスからグローバル IP アドレスへの SNAT が必要です。 AKS 上のアプリケーションから外部の連携サービスへアクセスするというシナリオで、リソース グループ内に存在するパブリック IP アドレスのうちどれが送信元の IP アドレスとして使用されるのか、疑問に思われた方もいらっしゃるのではないかと思います。&lt;/p&gt;
&lt;p&gt;Azure では外部接続の SNAT オプションを複数提供しており、 AKS ではクラスター作成時に選択した Load Balancer の SKU によって、使用される SNAT オプションが異なることがございます。この記事では、送信トラフィックに Azure Load Balancer が使用されている [^1] ことを前提に、 AKS の外部接続で使用される SNAT オプションについて、関係する Azure リソースの構成とともにご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
      <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>一時ディスクのドライブ文字が変わる</title>
    <link href="https://jpaztech.github.io/blog/vm/drive-letter-changed-2/"/>
    <id>https://jpaztech.github.io/blog/vm/drive-letter-changed-2/</id>
    <published>2020-11-06T03:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.518Z</updated>
    
    <content type="html"><![CDATA[<p><span style="color:red;"><strong>Update: 11/6</strong> (Last: 8/27)</span></p><p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>Azure Windows VM では、規定で一時ディスクにドライブ文字 D が割り当てられますが、<br>お客様の中には、アプリケーションの仕様上、データ ドライブを D ドライブと設定しなければならない場合があります。<br>その場合には、下記公開情報の手順にて一時ディスクのドライブ文字を変更いただけます。</p><a id="more"></a><ul><li>Windows VM のデータ ドライブとしての D: ドライブの使用<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/change-drive-letter" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/change-drive-letter</a></li></ul><p>しかしながら、一時ディスクのドライブ文字を D から変更いただいている場合、VM の停止 / 起動など物理ホスト サーバーの移動いただいた際に、一時ディスクのドライブ文字が変更される場合があります。</p><hr><h2 id="■-問題の動作につきまして"><a href="#■-問題の動作につきまして" class="headerlink" title="■ 問題の動作につきまして"></a>■ 問題の動作につきまして</h2><p>物理ホストの移動するタイミングにて、一時ディスクのドライブ文字が変更される動作は、下記のタイミング・条件によりごく稀に発生する場合があります。</p><ul><li><p><strong>タイミング:</strong><br>VM の停止 (割り当て解除) / 起動、再デプロイ、サイズ変更、ASR で対向リージョンにフェールオーバーを行ったなど、物理ホストサーバ移動後の VM の起動時</p></li><li><p><strong>条件:</strong><br>データ ドライブのドライブ文字 (例えば D) に対して、一時ディスクのドライブ文字が T など、ドライブ文字間が空いているアルファベットをご設定いただいている</p></li><li><p><strong>変更点:</strong><br>一時ディスクのドライブ文字が、データ ドライブのドライブ文字に連続したドライブ文字に変更される<br>(例えば、データ ドライブ文字が D の時に一時ディスクのドライブ文字 が E に変更される)</p></li><li><p><strong>発生頻度:</strong><br><s>ごく稀</p></li></ul><p>結論から申し上げますと、本動作は、現行の Azure の想定された起こりうる動作でございます。<br>すでに内部にて Azure の動作の改善点として確認されており、現在対処の準備を進めておりますが、現行の動作からの変更ということで長期にわたる可能性があり、直近での改善は困難であると想定されます。</s></p><p><span style="color:red;">本動作につきましては Azure 基盤側にて順次改善が展開されております。<br>改善に伴い、物理ホストの移動が発生した場合、改善が適用された状態の物理ホストから一時ディスクがアタッチされるため、ゲスト OS 内で保持している改善が適用される前の物理ホストからアタッチされた一時ディスクの情報と、改善が適用された後の一時ディスクの情報に差異があった場合に、ドライブ文字が変更される場合がございます。</span></p><p><span style="color:red;">1 度一時ディスクのドライブ文字が変更される場合がございますが、改善適用後に物理ホストの移動を伴う操作 (割り当て解除状態からの起動、再デプロイ、サイズ変更など) をご実施いただいた後であれば、本事象は発生しないことが期待されます。</span></p><hr><h2 id="■-問題の動作による影響につきまして"><a href="#■-問題の動作による影響につきまして" class="headerlink" title="■ 問題の動作による影響につきまして"></a>■ 問題の動作による影響につきまして</h2><p>Azure Marketplace イメージから作成した Windows VM では、規定で pagefile.sys<br>(仮想メモリ / ページング ファイル) が一時ディスクにシステム管理サイズで設定されております。</p><p>一時ディスクに pagefile.sys をご設定いただいている状況で、一時ディスクのドライブ文字が変更された場合、C ドライブに pagefile.sys が設定・配置されます。<br>そのため、ご利用状況によって pagefile.sys が拡張された際に、C ドライブの容量を圧迫することがございます。 </p><hr><h2 id="■-対処策につきまして"><a href="#■-対処策につきまして" class="headerlink" title="■ 対処策につきまして"></a>■ 対処策につきまして</h2><p>現在、本動作につきましては、下記 2 つの方法が対処策となります。</p><ol><li>一時ディスクを既定値である D ドライブで運用いただく。</li><li>OS 起動時に一時ディスクのドライブ文字を確認し、変更されている場合には再度ドライブ文字をご変更いただく。<br>pagefile.sys を一時ディスクにご設定いただいている場合には、そちらも併せてご変更いただく (要再起動)。</li></ol><p>対処策 1 につきましては、ご利用いただくアプリケーションの要件でデータ ドライブのドライブ文字を D にしなければならないといった制約がない場合にご検討ください。</p><p>対処策 2 につきましては、手動変更ではなく、タスクスケジューラにて登録した PowerShell スクリプトを OS 起動時に実行する方法 (スタートアップ スクリプト) になります。<br>具体的なサンプル スクリプトと、タスクスケジューラによるスクリプト実行設定を下記にご紹介いたします。</p><p><span style="color:red;">追記：<br>上述の通り、1 度一時ディスクのドライブ文字が変更される場合がございますが、改善適用後に物理ホストの移動を伴う操作をご実施いただいた後であれば、本事象は発生しないことが期待されます。</span><br><span style="color:red;">そのため、一時ディスクのドライブ文字が意図せず変更された場合には、手動でドライブ文字ならびにページングファイルのご設定を修正いただき、その後は静観いただけますと幸いでございます。</span></p><h3 id="□-サンプル-スクリプト"><a href="#□-サンプル-スクリプト" class="headerlink" title="□ サンプル スクリプト"></a>□ サンプル スクリプト</h3><p>本サンプル スクリプトは、ドライブ文字の設定状況を確認し、一時ディスクのドライブ文字が変更されている場合にはドライブ文字および pagefile.sys の設定を変更する処理を行う PowerShell スクリプトになります。<br>一時ディスクを <span style="color:red;"> <strong>T ドライブ</strong> </span>としておりますので、お客様にて必要に応じてご変更ください。</p><p>※ 一時ディスクのドライブ文字が変更されていない場合には、特に設定変更の処理は実施されません。<br>※ 本スクリプトが実行された際には、<span style="color:red;"><strong>ゲスト OS の再起動</strong> </span>が実施されます。</p><p>なお、お客様環境に導入いただく際には、十分な検証作業をご実施ください。</p><blockquote><p><strong>免責事項</strong></p><p>本サンプルスクリプトは、サンプルとして提供されるものであり、製品の実運用環境で使用されることを前提に提供されるものではありません。</p><p>本サンプルコードおよびそれに関連するあらゆる情報は、「現状のまま」で提供されるものであり、商品性や特定の目的への適合性に関する黙示の保証も含め、明示・黙示を問わずいかなる保証も付されるものではありません。</p><p>マイクロソフトは、お客様に対し、本サンプルコードを使用および改変するための非排他的かつ無償の権利ならびに本サンプルコードをオブジェクトコードの形式で複製および頒布するための非排他的かつ無償の権利を許諾します。</p><p>但し、お客様は、（１）本サンプルコードが組み込まれたお客様のソフトウェア製品のマーケティングのためにマイクロソフトの会社名、ロゴまたは、商標を用いないこと、（２）本サンプルコードが組み込まれたお客様のソフトウェア製品に有効な著作権表示をすること、および（３）本サンプルコードの使用または頒布から生じるあらゆる損害 （弁護士費用を含む）に関する請求または訴訟について、マイクロソフトおよびマイクロソフトの取引業者に対し補償し、損害を与えないことに同意するものとします。</p></blockquote><figure class="highlight powershell"><figcaption><span>SampleScript.ps1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一時ディスクのラベル</span></span><br><span class="line"><span class="variable">$DriveLabel</span>=<span class="string">"Temporary Storage"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#現在の一時ディスクのドライブ文字</span></span><br><span class="line"><span class="variable">$DriveLetter</span>=<span class="built_in">Get-Volume</span> | where FileSystemLabel <span class="operator">-match</span> <span class="variable">$DriveLabel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#変更したい一時ディスクのドライブ文字</span></span><br><span class="line"><span class="variable">$NewDriveLetter</span>=<span class="string">"T"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#現在存在するドライブ文字</span></span><br><span class="line"><span class="variable">$AllLetter</span>=<span class="built_in">Get-Partition</span> | select DriveLetter</span><br><span class="line"></span><br><span class="line"><span class="comment">#pagefile の設定情報があるレジストリ パス</span></span><br><span class="line"><span class="variable">$RegistryPath</span>=<span class="string">"Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Memory Management"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pagefile の設定: T ドライブにシステム管理サイズで pagefile.sys を設置</span></span><br><span class="line"><span class="variable">$NewValue</span>=<span class="string">"T:\pagefile.sys 0 0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ドライブの存在判定 (現在 T ドライブが存在しているか)</span></span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable">$AllLetter</span>.DriveLetter <span class="operator">-contains</span> <span class="variable">$NewDriveLetter</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#存在しない場合</span></span><br><span class="line">    <span class="comment">#現在の一時ディスクのドライブ文字を T ドライブに再設定</span></span><br><span class="line">    <span class="built_in">Set-Partition</span> <span class="literal">-Driveletter</span> <span class="variable">$DriveLetter</span>.DriveLetter <span class="literal">-NewDriveLetter</span> <span class="variable">$NewDriveLetter</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#設定後、T ドライブに改めて pagefile.sys 設定</span></span><br><span class="line">    <span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="variable">$RegistryPath</span> <span class="literal">-Name</span> PagingFiles <span class="literal">-Value</span> <span class="variable">$NewValue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#OS 再起動</span></span><br><span class="line">    <span class="built_in">Restart-Computer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="□-タスクスケジューラの設定"><a href="#□-タスクスケジューラの設定" class="headerlink" title="□ タスクスケジューラの設定"></a>□ タスクスケジューラの設定</h3><p>タスクスケジューラは以下のようにご設定いただけますと、OS 起動時にスクリプトを実行することが可能となります。<br>上記サンプル スクリプトをお客様のご利用状況に合わせてご変更いただき (例えば、一時ディスクのドライブ文字を適宜ご変更いただくなど)、タスクスケジューラにご設定ください。</p><p>1) SampleScript.txt をSampleScript.ps1 に変更します。</p><p>2) [サーバー マネージャー] - [ツール] - [タスク スケジューラ] から<br>   [タスクの作成] をクリックします。</p><p>3) [全般] タブにて以下の設定を実施します。</p><blockquote><p>名前 : 任意でご設定ください<br>タスク実行時に使うユーザー アカウント : 管理者権限ユーザ<br>ユーザーがログオンしているかどうかにかかわらず実行する : 有効<br>最上位の特権で実行する : 有効</p></blockquote><p>4) [トリガー] - [新規] にてタスクの開始に [スタートアップ時] を選択し、[OK] をクリックします。</p><p>5) [操作] - [新規] にて [プログラムの開始] が選択されている事を確認し、以下を設定後、[OK] を押下して設定を反映させます。</p><blockquote><p>プログラム/スクリプト : C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe<br>引数の追加 : &lt;SampleScript.ps1 のパス&gt;\SampleScript.ps1</p></blockquote><p>※ パスワードを要求されましたら、対象ユーザー (管理者) のパスワードを入力します。</p><br>本稿が皆様のお役に立てれば幸いです。<hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;&lt;strong&gt;Update: 11/6&lt;/strong&gt; (Last: 8/27)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;Azure Windows VM では、規定で一時ディスクにドライブ文字 D が割り当てられますが、&lt;br&gt;お客様の中には、アプリケーションの仕様上、データ ドライブを D ドライブと設定しなければならない場合があります。&lt;br&gt;その場合には、下記公開情報の手順にて一時ディスクのドライブ文字を変更いただけます。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Drive Letter" scheme="https://jpaztech.github.io/blog/tags/Drive-Letter/"/>
    
  </entry>
  
  <entry>
    <title>VM の再作成により可用性ゾーンを変更する (PowerShell 編)</title>
    <link href="https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/"/>
    <id>https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/</id>
    <published>2020-11-02T06:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.502Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの菅澤です。</p><p>Azure VM では、一部リージョンのみとはなりますが可用性ゾーンをサポートしています。</p><ul><li>Azure での Availability Zones をサポートしているリージョン<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region</a></li></ul><p>ただ、可用性ゾーンを利用した VM を作成したい場合には、これに利用するディスクも可用性ゾーンを利用している必要があり、一般に仮想マシンを新規デプロイする場合にのみこの利用有無を設定できます。</p><a id="more"></a><p>しかし、運用をしている中で可用性ゾーンへ組み入れる必要が発生したり、逆に、可用性ゾーンに組み入れられていると一部機能が対応しないため、可用性ゾーンから外したいというご要望が出てくることがあるかと思います。</p><p>本稿では、こうしたご要望にお応えするために、可用性ゾーンへ含まれない VM を可用性ゾーンに組み入れる、可用性ゾーンに含まれる VM を可用性ゾーンから外す方法について、Azure PowerShell のサンプルを用いてそれぞれご案内いたします。</p><h2 id="■-本手順を利用する前提条件"><a href="#■-本手順を利用する前提条件" class="headerlink" title="■ 本手順を利用する前提条件"></a>■ 本手順を利用する前提条件</h2><p>本手順では、管理ディスクを利用していることを前提としてご案内いたします。<br>Azure PowerShell か実行可能な環境、もしくは Azure CloudShell をご利用いただける環境から実行してください。</p><h2 id="■-手順の流れについて"><a href="#■-手順の流れについて" class="headerlink" title="■ 手順の流れについて"></a>■ 手順の流れについて</h2><p>可用性ゾーンへ含まれない VM を可用性ゾーンに組み入れる、可用性ゾーンに含まれる VM を可用性ゾーンから外すのいずれの場合でも以下の流れにて作業を行います。</p><ol><li>仮想マシンを停止する。</li><li>仮想マシンのスナップショットを取得する。</li><li>仮想マシンのスナップショットから仮想マシンを作成する。</li><li>作成されたスナップショット、およびもともと利用されていたリソースを削除する。</li></ol><h2 id="■-可用性ゾーンを設定したい場合"><a href="#■-可用性ゾーンを設定したい場合" class="headerlink" title="■ 可用性ゾーンを設定したい場合"></a>■ 可用性ゾーンを設定したい場合</h2><p>まず、設定変更を行いたい仮想マシンを停止してください。</p><p>停止が完了したら、現在利用しているディスクのスナップショットを取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名 ( japaneast など )</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"NonAz"</span> <span class="comment"># 仮想マシン名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>  <span class="comment"># スナップショット名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要###</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショットを作成</span></span><br><span class="line"><span class="variable">$snapshot</span> =  <span class="built_in">New-AzSnapshotConfig</span> <span class="literal">-SourceResourceId</span> <span class="variable">$vm</span>.StorageProfile.OsDisk.ManagedDisk.Id <span class="literal">-Location</span> <span class="variable">$Location</span> <span class="literal">-CreateOption</span> copy</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzSnapshot</span> <span class="literal">-Snapshot</span> <span class="variable">$snapshot</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span></span><br></pre></td></tr></table></figure><p>次に、上記で取得したスナップショットをもとに VM を作成します。</p><p>パブリック IP アドレスは、通常可用性ゾーンに含まれない VM では Basic SKU が利用されますが、可用性ゾーンでパブリック IP アドレスを利用する場合には Standard SKU かつ静的な割り当てが必要となりますのでご注意ください。</p><ul><li>パブリック IP アドレス<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/public-ip-addresses" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-network/public-ip-addresses</a></li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"NonAz"</span> <span class="comment"># 元の VM の仮想マシン名</span></span><br><span class="line"><span class="variable">$ZoneNo</span> = <span class="number">1</span> <span class="comment"># ゾーン番号 ( 1 or 2 or 3 )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必要に応じて変更してください</span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>　<span class="comment"># スナップショット名</span></span><br><span class="line"><span class="variable">$osDiskName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-AZ"</span>  <span class="comment"># 新しい VM の OS ディスク名</span></span><br><span class="line"><span class="variable">$virtualMachineName</span> = <span class="variable">$vmName</span> + <span class="string">"AZ"</span> <span class="comment"># 新しい VM 名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要ですが、 VM の Config を作成にある Windows / Linux の部分のみご確認ください ###</span></span><br><span class="line"><span class="comment"># 以下は元 VM と同じものを自動的に選択しています</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span>  <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"><span class="variable">$Subnet</span> =  (<span class="built_in">Get-AzNetworkInterface</span> <span class="literal">-ResourceID</span> <span class="variable">$vm</span>.NetworkProfile.NetworkInterfaces.Id).IpConfigurations.subnet.Id <span class="comment"># サブネット情報</span></span><br><span class="line"><span class="variable">$virtualMachineSize</span> = <span class="variable">$vm</span>.HardwareProfile.VmSize <span class="comment"># VM サイズ </span></span><br><span class="line"><span class="variable">$DiskType</span> = (<span class="built_in">Get-AzDisk</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span>  <span class="variable">$vm</span>.StorageProfile.OsDisk.Name).Sku.Name <span class="comment"># ディスクの種類</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショット情報を取得</span></span><br><span class="line"><span class="variable">$snapshot</span> = <span class="built_in">Get-AzSnapshot</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ディスクを作成</span></span><br><span class="line"><span class="variable">$diskConfig</span> = <span class="built_in">New-AzDiskConfig</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SourceResourceId</span> <span class="variable">$snapshot</span>.Id <span class="literal">-CreateOption</span> Copy <span class="literal">-Zone</span> <span class="variable">$ZoneNo</span> <span class="literal">-AccountType</span> <span class="variable">$DiskType</span></span><br><span class="line"><span class="variable">$disk</span> = <span class="built_in">New-AzDisk</span> <span class="literal">-Disk</span> <span class="variable">$diskConfig</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span> <span class="variable">$osDiskName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VM の Config を作成　( -Windows となっている部分は、Linux VM の場合には -Linux に変えてください )</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">New-AzVMConfig</span> <span class="literal">-VMName</span> <span class="variable">$virtualMachineName</span> <span class="literal">-VMSize</span> <span class="variable">$virtualMachineSize</span> <span class="literal">-Zone</span> <span class="variable">$ZoneNo</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Set-AzVMOSDisk</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ManagedDiskId</span> <span class="variable">$disk</span>.Id <span class="literal">-CreateOption</span> Attach <span class="literal">-Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># public IP および NIC を作成</span></span><br><span class="line"><span class="variable">$publicIp</span> = <span class="built_in">New-AzPublicIpAddress</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'-AZ_ip'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-AllocationMethod</span> <span class="keyword">Static</span> <span class="literal">-Zone</span> <span class="variable">$ZoneNo</span> <span class="literal">-Sku</span> Standard</span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzNetworkInterface</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'-AZ_nic'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SubnetId</span> <span class="variable">$subnet</span> <span class="literal">-PublicIpAddressId</span> <span class="variable">$publicIp</span>.Id </span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Add-AzVMNetworkInterface</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-Id</span> <span class="variable">$nic</span>.Id</span><br><span class="line"></span><br><span class="line"><span class="comment"># VM を作成</span></span><br><span class="line"><span class="built_in">New-AzVM</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location</span><br></pre></td></tr></table></figure><p>上記で作成された VM が動作するようでしたらば、もともと利用していたリソースおよび、本手順で作成したスナップショットを削除し、手順は完了となります。</p><h2 id="■-可用性ゾーンの設定を削除したい場合"><a href="#■-可用性ゾーンの設定を削除したい場合" class="headerlink" title="■ 可用性ゾーンの設定を削除したい場合"></a>■ 可用性ゾーンの設定を削除したい場合</h2><p>まず、現在利用しているディスクのスナップショットを取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名 ( japaneast など )</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"Az"</span> <span class="comment"># 仮想マシン名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必要に応じて変更してください</span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>  <span class="comment"># スナップショット名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要###</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span>  <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショットを作成</span></span><br><span class="line"><span class="variable">$snapshot</span> =  <span class="built_in">New-AzSnapshotConfig</span> <span class="literal">-SourceResourceId</span> <span class="variable">$vm</span>.StorageProfile.OsDisk.ManagedDisk.Id <span class="literal">-Location</span> <span class="variable">$Location</span> <span class="literal">-CreateOption</span> copy</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzSnapshot</span> <span class="literal">-Snapshot</span> <span class="variable">$snapshot</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span></span><br></pre></td></tr></table></figure><p>次に、上記で取得したスナップショットをもとに VM を作成します。</p><p>パブリック IP アドレスは、通常可用性ゾーンに含まれない VM とするため、Basic SKU としています。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"Az"</span> <span class="comment"># 元の VM の仮想マシン名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必要に応じて変更してください</span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>　<span class="comment"># スナップショット名</span></span><br><span class="line"><span class="variable">$osDiskName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk_NonAz"</span>  <span class="comment"># 新しい VM の OS ディスク名</span></span><br><span class="line"><span class="variable">$virtualMachineName</span> = <span class="variable">$vmName</span> + <span class="string">"NonAZ"</span> <span class="comment"># 新しい VM 名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要ですが、 VM の Config を作成にある Windows / Linux の部分のみご確認ください ###</span></span><br><span class="line"><span class="comment"># 以下は元 VM と同じものを自動的に選択しています</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"><span class="variable">$Subnet</span> =  (<span class="built_in">Get-AzNetworkInterface</span> <span class="literal">-ResourceID</span> <span class="variable">$vm</span>.NetworkProfile.NetworkInterfaces.Id).IpConfigurations.subnet.Id <span class="comment"># サブネット情報</span></span><br><span class="line"><span class="variable">$virtualMachineSize</span> = <span class="variable">$vm</span>.HardwareProfile.VmSize <span class="comment"># VM サイズ </span></span><br><span class="line"><span class="variable">$DiskType</span> = (<span class="built_in">Get-AzDisk</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span>  <span class="variable">$vm</span>.StorageProfile.OsDisk.Name).Sku.Name <span class="comment"># ディスクの種類</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショット情報を取得</span></span><br><span class="line"><span class="variable">$snapshot</span> = <span class="built_in">Get-AzSnapshot</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ディスクを作成</span></span><br><span class="line"><span class="variable">$diskConfig</span> = <span class="built_in">New-AzDiskConfig</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SourceResourceId</span> <span class="variable">$snapshot</span>.Id <span class="literal">-CreateOption</span> Copy <span class="literal">-AccountType</span> <span class="variable">$DiskType</span></span><br><span class="line"><span class="variable">$disk</span> = <span class="built_in">New-AzDisk</span> <span class="literal">-Disk</span> <span class="variable">$diskConfig</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span> <span class="variable">$osDiskName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VM の Config を作成　( -Windows となっている部分は、Linux VM の場合には -Linux に変えてください )</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">New-AzVMConfig</span> <span class="literal">-VMName</span> <span class="variable">$virtualMachineName</span> <span class="literal">-VMSize</span> <span class="variable">$virtualMachineSize</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Set-AzVMOSDisk</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ManagedDiskId</span> <span class="variable">$disk</span>.Id <span class="literal">-CreateOption</span> Attach <span class="literal">-Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># public IP および NIC を作成</span></span><br><span class="line"><span class="variable">$publicIp</span> = <span class="built_in">New-AzPublicIpAddress</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'NonAZ_ip'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-AllocationMethod</span> Dynamic <span class="literal">-Sku</span> Basic</span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzNetworkInterface</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'NonAZ_nic'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SubnetId</span> <span class="variable">$subnet</span> <span class="literal">-PublicIpAddressId</span> <span class="variable">$publicIp</span>.Id </span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Add-AzVMNetworkInterface</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-Id</span> <span class="variable">$nic</span>.Id</span><br><span class="line"></span><br><span class="line"><span class="comment"># VM を作成</span></span><br><span class="line"><span class="built_in">New-AzVM</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location</span><br></pre></td></tr></table></figure><p>上記で作成された VM が動作するようでしたらば、もともと利用していたリソースおよび、本手順で作成したスナップショットを削除し、手順は完了となります。</p><h2 id="■-参考"><a href="#■-参考" class="headerlink" title="■ 参考"></a>■ 参考</h2><p>本ドキュメントの作成に当たっては、以下の資料を参考としておりますので、よろしければこちらもご確認をいただけますと幸いです。</p><ul><li><p>スナップショットの作成<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk</a></p></li><li><p>PowerShell でスナップショットから仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/scripts/virtual-machines-windows-powershell-sample-create-vm-from-snapshot" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/scripts/virtual-machines-windows-powershell-sample-create-vm-from-snapshot</a></p></li></ul><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの菅澤です。&lt;/p&gt;
&lt;p&gt;Azure VM では、一部リージョンのみとはなりますが可用性ゾーンをサポートしています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Azure での Availability Zones をサポートしているリージョン&lt;br&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ただ、可用性ゾーンを利用した VM を作成したい場合には、これに利用するディスクも可用性ゾーンを利用している必要があり、一般に仮想マシンを新規デプロイする場合にのみこの利用有無を設定できます。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Sample Script" scheme="https://jpaztech.github.io/blog/tags/Sample-Script/"/>
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Availability Zone" scheme="https://jpaztech.github.io/blog/tags/Availability-Zone/"/>
    
      <category term="Azure PowerShell" scheme="https://jpaztech.github.io/blog/tags/Azure-PowerShell/"/>
    
  </entry>
  
  <entry>
    <title>TLS 証明書の更新に関するアナウンスの補足説明</title>
    <link href="https://jpaztech.github.io/blog/network/tls-certificate-update-2020/"/>
    <id>https://jpaztech.github.io/blog/network/tls-certificate-update-2020/</id>
    <published>2020-10-22T03:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.498Z</updated>
    
    <content type="html"><![CDATA[<p>※ 2020 年 10 月 22 日更新: Windows のルート証明書に関する FAQ を追記しました。</p><p>こんにちは、Azure テクニカル サポート チームの飯塚です。</p><p>現在、Microsoft Azure では以下の公開資料のとおり、TLS 証明書の更新についてのアナウンスメントを行っております。</p><ul><li><a href="https://docs.microsoft.com/en-us/azure/security/fundamentals/tls-certificate-changes" target="_blank" rel="noopener">Azure TLS certificate changes</a></li></ul><p>更新の内容やそれに伴う影響、また殆どのお客様に対しては影響がないということについても、上記の公開資料にてご説明させていただいております。しかし、現在のところ資料が英語版のみの公開となっており、わかりづらい可能性があるかと思いますので、本ブログ記事にて補足説明をさせていただきます。</p><p>以下の内容が参考になれば幸いです。</p><a id="more"></a><h2 id="通知の背景"><a href="#通知の背景" class="headerlink" title="通知の背景"></a>通知の背景</h2><p>Microsoft Azure ではさまざまなサービスにおいて、クライアントからのセキュアなアクセスを実現するため、TLS (HTTPS) を用いたエンドポイントの公開を行っています。Azure のパブリック サービスに対して、https:// で始まる URL でアクセスする際、TLS が利用されています。</p><p>クライアントから TLS で Azure サービスにアクセスする際、TLS のネゴシエーションの過程で、Azure 側からサーバー証明書が提示され、クライアントがその正当性を検証する動作が行われます。これは Azure に限らず、TLS を用いたアクセスで広く一般的に行われている動作です。</p><p>現在、Azure の各パブリック サービスにおいて、このサーバー証明書を新しいものに更新する対応を行っています。当然、新しいサーバー証明書も公的に信頼されている証明書ですので、証明書の更新後も大半のクライアントでは特に対応の必要は生じず、引き続きサービスへのアクセスが可能です。</p><p>しかし、ごくまれに、クライアント側で信頼するサーバー証明書を限定している場合などがあり、そのような構成をとっているお客様においては、対応の必要が生じます。</p><p>そのような場合に備えて、サーバー証明書の更新があることと、その更新内容をアナウンスするに至っています。</p><h2 id="証明書更新の内容"><a href="#証明書更新の内容" class="headerlink" title="証明書更新の内容"></a>証明書更新の内容</h2><p>現在、Azure のほとんどのサービスでは、以下のルート証明機関から発行されたサーバー証明書を利用しています。</p><table><thead><tr><th>コモン ネーム</th><th>拇印 (SHA1)</th></tr></thead><tbody><tr><td><a href="https://cacerts.digicert.com/BaltimoreCyberTrustRoot.crt" target="_blank" rel="noopener">Baltimore CyberTrust Root</a></td><td>d4de20d05e66fc53fe1a50882c78db2852cae474</td></tr></tbody></table><p>今後、以下のいずれかのルート証明機関から発行された証明書に置き換えられていきます。</p><table><thead><tr><th>コモン ネーム</th><th>拇印 (SHA1)</th></tr></thead><tbody><tr><td><a href="https://cacerts.digicert.com/DigiCertGlobalRootG2.crt" target="_blank" rel="noopener">DigiCert Global Root G2</a></td><td>df3c24f9bfd666761b268073fe06d1cc8d4f82a4</td></tr><tr><td><a href="https://cacerts.digicert.com/DigiCertGlobalRootCA.crt" target="_blank" rel="noopener">DigiCert Global Root CA</a></td><td>a8985d3a65e5e5c4b2d7d66d40c6dd2fb19c5436</td></tr><tr><td><a href="https://cacerts.digicert.com/BaltimoreCyberTrustRoot.crt" target="_blank" rel="noopener">Baltimore CyberTrust Root</a></td><td>d4de20d05e66fc53fe1a50882c78db2852cae474</td></tr><tr><td><a href="https://www.d-trust.net/cgi-bin/D-TRUST_Root_Class_3_CA_2_2009.crt" target="_blank" rel="noopener">D-TRUST Root Class 3 CA 2 2009</a></td><td>58e8abb0361533fb80f79b1b6d29d3ff8d5f00f0</td></tr><tr><td><a href="https://www.microsoft.com/pkiops/certs/Microsoft%20RSA%20Root%20Certificate%20Authority%202017.crt" target="_blank" rel="noopener">Microsoft RSA Root Certificate Authority 2017</a></td><td>73a5e64a3bff8316ff0edccc618a906e4eae4d74</td></tr><tr><td><a href="https://www.microsoft.com/pkiops/certs/Microsoft%20EV%20ECC%20Root%20Certificate%20Authority%202017.crt" target="_blank" rel="noopener">Microsoft EV ECC Root Certificate Authority 2017</a></td><td>6b1937abfd64e1e40daf2262a27857c015d6228d</td></tr></tbody></table><h2 id="想定される影響"><a href="#想定される影響" class="headerlink" title="想定される影響"></a>想定される影響</h2><p>冒頭に記載しましたように、特別な制御を行っていない一般的なクライアントの場合、証明書が公的に信頼されているものであれば、サーバー証明書が新しいものに変わっても、引き続きサービスへのアクセスが継続可能です。このため、ほとんどのお客様においては、今回の更新による影響は特に想定されません。</p><p>影響が生じるケースとしては、以下のようなものが考えられます。</p><h3 id="1-サーバー証明書が変わる場合に、その証明書を信頼対象に加える必要があるようなアプリケーションをご利用の場合"><a href="#1-サーバー証明書が変わる場合に、その証明書を信頼対象に加える必要があるようなアプリケーションをご利用の場合" class="headerlink" title="1. サーバー証明書が変わる場合に、その証明書を信頼対象に加える必要があるようなアプリケーションをご利用の場合"></a>1. サーバー証明書が変わる場合に、その証明書を信頼対象に加える必要があるようなアプリケーションをご利用の場合</h3><p>もし、信頼する証明書を決め打ちでリスト化しているようなアプリケーションがある場合は、新しい証明書をリストに加えるような措置を行わないと、影響を受ける可能性があります。</p><p>たとえば、アプリケーションが影響を受けるかどうかを確認する方法として、ソースコードがある場合は、アプリケーションのソース コードを対象に、<a href="https://www.microsoft.com/pki/mscorp/cps/default.htm" target="_blank" rel="noopener">現在の中間証明書</a>のコモン ネームや拇印が含まれるかどうかを検索するといったものが考えられます。</p><p>もし、アプリケーションがサードパーティ製のものであれば、必要に応じてアプリケーションの開発ベンダーに確認いただければと思います。</p><h3 id="2-OS-レベルでルート証明書を信頼していない場合"><a href="#2-OS-レベルでルート証明書を信頼していない場合" class="headerlink" title="2. OS レベルでルート証明書を信頼していない場合"></a>2. OS レベルでルート証明書を信頼していない場合</h3><p>クライアントがサーバー証明書を信頼するかどうかを判断する基準として、(OS とは独立した証明書管理を行うアプリケーションでない限り) クライアントの OS がもつ、信頼されたルート証明書のリスト情報が利用されます。</p><p>公開資料では、以下のとおり OS ごとの注意点についても言及しています (便宜上、Java の実行環境についても本項で言及しています)。</p><ul><li><p>Windows: 通常の環境であれば、信頼すべきルート証明書は自動的に更新され、今回更新される新しい証明書 (上記) も信頼対象となります。しかし、ネットワークから切り離して (Windows Update が行われない環境で) Windows を利用しているような場合は、ルート証明書の自動更新が行われず、上記の証明書が信頼対象にならないことがあります。Windows Update によるルート証明書の更新が行われないような環境で、Azure のパブリック サービスにアクセスしている場合は、手動で証明書を信頼対象に追加する対応が必要になることがあります。</p></li><li><p>Linux: /etc/ssl/certs への証明書の追加が必要になる場合があります。詳細はご利用のディストリビューションのドキュメントを参照してください。</p></li><li><p>Java: 上記の新しいルート証明書が信頼されていることを確認してください。</p></li><li><p>Android: ご利用の Android バージョンのドキュメントを参照してください。</p></li></ul><h3 id="3-新しいサーバー証明書の-CRL-配布ポイントや-OCSP-へのアクセスができないような、ファイアウォールやプロキシーのルールが設定されている場合"><a href="#3-新しいサーバー証明書の-CRL-配布ポイントや-OCSP-へのアクセスができないような、ファイアウォールやプロキシーのルールが設定されている場合" class="headerlink" title="3. 新しいサーバー証明書の CRL 配布ポイントや OCSP へのアクセスができないような、ファイアウォールやプロキシーのルールが設定されている場合"></a>3. 新しいサーバー証明書の CRL 配布ポイントや OCSP へのアクセスができないような、ファイアウォールやプロキシーのルールが設定されている場合</h3><p>クライアントが証明書の信頼性を検証する動作の中で、証明書の失効確認という動作が発生します。これは、サーバーから提示されたサーバー証明書が、証明機関によって失効されたものでないことを確認するプロセスです。証明書の失効確認ができない場合、クライアントはサーバーが正しいものかどうかが判断できず、エラーになるなどの影響が想定されます。</p><p>証明書の失効確認にあたっては、クライアントから CRL 配布ポイントや OCSP へアクセスができる必要があります。具体的には、以下の CRL 配布ポイントや OCSP へのアクセスが必要になります。</p><ul><li><a href="http://crl3.digicert.com" target="_blank" rel="noopener">http://crl3.digicert.com</a></li><li><a href="http://crl4.digicert.com" target="_blank" rel="noopener">http://crl4.digicert.com</a></li><li><a href="http://ocsp.digicert.com" target="_blank" rel="noopener">http://ocsp.digicert.com</a></li><li><a href="http://www.d-trust.net" target="_blank" rel="noopener">http://www.d-trust.net</a></li><li><a href="http://root-c3-ca2-2009.ocsp.d-trust.net" target="_blank" rel="noopener">http://root-c3-ca2-2009.ocsp.d-trust.net</a></li><li><a href="http://crl.microsoft.com" target="_blank" rel="noopener">http://crl.microsoft.com</a></li><li><a href="http://oneocsp.microsoft.com" target="_blank" rel="noopener">http://oneocsp.microsoft.com</a></li><li><a href="http://ocsp.msocsp.com" target="_blank" rel="noopener">http://ocsp.msocsp.com</a></li></ul><p>もしファイアウォールやプロキシーで URL 単位のフィルタリングを行っているような場合は、上記へのアクセスができるようになっていることをご確認ください。</p><h2 id="証明書変更のスケジュール"><a href="#証明書変更のスケジュール" class="headerlink" title="証明書変更のスケジュール"></a>証明書変更のスケジュール</h2><ul><li>Azure Active Directory: 2020 年 7 月 7 日から更新を開始しています。</li><li>その他既存のエンドポイント: 2020 年 8 月 13 日から - 同年 10 月 26 日にかけて証明書の更新を進めています。</li><li>新規のエンドポイント: 新しい証明書が利用されます。</li></ul><p>最終的に、2021 年 2 月 15 日までには従来のルート証明書は利用されなくなることが予定されております。</p><p>なお、Azure IoT Hub および DPS、Storage については引き続き従来のルート証明書が利用されるものの、中間証明書が変わることが予定されています。詳細は、IoT Hub および DPS については<a href="https://techcommunity.microsoft.com/t5/internet-of-things/azure-iot-tls-changes-are-coming-and-why-you-should-care/ba-p/1658456" target="_blank" rel="noopener">こちら</a>を、Storage については<a href="https://techcommunity.microsoft.com/t5/azure-storage/azure-storage-tls-changes-are-coming-and-why-you-care/ba-p/1705518" target="_blank" rel="noopener">こちら</a>をご確認ください。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p><strong>Q. Application Gateway や Azure Front Door、Azure CDN、仮想マシンなどに対して、自分で証明機関から取得したサーバー証明書を適用している場合などは影響を受けるか？</strong></p><p>A. 特に影響は生じません。今回影響が発生するのは、Azure 側で発行・管理されているサーバー証明書のみです。</p><p><strong>Q. Windows における証明書ストアの「信頼されたルート証明機関」に、更新後のルート証明書の一部が含まれていないように見えます。このままだと、証明書の検証に失敗してアクセスができない状況になりますか？</strong></p><p>A. 「D-TRUST Root Class 3 CA 2 2009」「Microsoft RSA Root Certificate Authority 2017」「Microsoft EV ECC Root Certificate Authority 2017」などについて、一部の Windows において「信頼されたルート証明機関」に含まれていない、ということからお問い合わせをいただくことがあります。Windows においては、これらのルート証明書は、ルート証明書更新プログラムにより自動的にインストールされます。このため、現時点でルート証明書がインストールされていなくても問題ありません。</p><p>Windows では、TLS 通信の中でサーバーから提示された証明書の検証を行う過程で、その証明書のルート証明書がインストールされていない場合は、「ルート証明書更新プログラム」によって自動的にルート証明書が取得・インストールされる動作があります。ルート証明書更新プログラムによってインストールされるのは、あらかじめ信頼対象と定められた証明書のみですが、上記の証明書は、いずれも信頼対象になっています。</p><p>たとえば、Windows 8 / Windows Server 2012 以降の場合、以下で公開されている、信頼されたルート証明書のリストにアクセスして、証明書をインストールする処理がバックグラウンドで行われます。</p><ul><li><a href="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab" target="_blank" rel="noopener">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab</a></li></ul><p>このため、今の時点でルート証明書がインストールされていなくても、必要になったタイミングで自動的に取得・インストールされ、TLS の通信が成立することが想定されます。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;※ 2020 年 10 月 22 日更新: Windows のルート証明書に関する FAQ を追記しました。&lt;/p&gt;
&lt;p&gt;こんにちは、Azure テクニカル サポート チームの飯塚です。&lt;/p&gt;
&lt;p&gt;現在、Microsoft Azure では以下の公開資料のとおり、TLS 証明書の更新についてのアナウンスメントを行っております。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/security/fundamentals/tls-certificate-changes&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Azure TLS certificate changes&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更新の内容やそれに伴う影響、また殆どのお客様に対しては影響がないということについても、上記の公開資料にてご説明させていただいております。しかし、現在のところ資料が英語版のみの公開となっており、わかりづらい可能性があるかと思いますので、本ブログ記事にて補足説明をさせていただきます。&lt;/p&gt;
&lt;p&gt;以下の内容が参考になれば幸いです。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Certificate" scheme="https://jpaztech.github.io/blog/tags/Certificate/"/>
    
  </entry>
  
  <entry>
    <title>VPN Gateway よくあるお問合せ - FAQ</title>
    <link href="https://jpaztech.github.io/blog/network/vpngw-FAQ1/"/>
    <id>https://jpaztech.github.io/blog/network/vpngw-FAQ1/</id>
    <published>2020-10-01T13:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.502Z</updated>
    
    <content type="html"><![CDATA[<p>Azure VPN Gateway に関して、たびたびお問合せ頂く内容をご紹介させていただきます。  </p><h3 id="メンテナンスの事前通知"><a href="#メンテナンスの事前通知" class="headerlink" title="メンテナンスの事前通知"></a>メンテナンスの事前通知</h3><p>VPN Gateway ではサービスを健全に運用するため定期的(月に 1, 2 回程度 )のメンテナンスを実施いたします。<br>メンテナンスでは数十秒程度の通信断が発生することがございますが、メンテナンスの <strong>事前通知は行っておりません</strong>  </p><h3 id="事後にメンテナンス有無を確認する方法"><a href="#事後にメンテナンス有無を確認する方法" class="headerlink" title="事後にメンテナンス有無を確認する方法"></a>事後にメンテナンス有無を確認する方法</h3><p>メンテナンス実施時に診断ログにメンテナンス実行を示すイベントが記録されます。<br>ログを確認することで、過去に発生した IPsec セッションの断がメンテナンスによるものかを確認することが可能です。<br>複数種類のメンテナンスがあり、全メンテナンスでログが出力されるわけではございません。<br>ログ上、メンテナンスとして記録されていない、意図せぬ申告なサービス断が発生した場合には Azure サポートにて調査をいたしますので、ケースオープンをしてお問い合わせ下さい。  </p><h1 id="Site-to-Site-に関する-FAQ"><a href="#Site-to-Site-に関する-FAQ" class="headerlink" title="Site-to-Site に関する FAQ"></a>Site-to-Site に関する FAQ</h1><h3 id="VPN-Gateway-で静的パブリック-IP-アドレスを使う方法"><a href="#VPN-Gateway-で静的パブリック-IP-アドレスを使う方法" class="headerlink" title="VPN Gateway で静的パブリック IP アドレスを使う方法"></a>VPN Gateway で静的パブリック IP アドレスを使う方法</h3><p>かねてより VPN Gateway に静的パブリック IP アドレスを割り当てたいというご要望を頂いておりましたが対応しておりませんでした。<br>2020年9月現在でも、VpnGwX 等の通常の VPN Gateway SKU では静的 IP アドレスを使用することはできませんが、<strong>ゾーン冗長 SKU VpnGwXAZ</strong> を選択いただくことで実現が可能です。  </p><p>非ゾーン冗長 SKU （VpnGwX ）から ゾーン冗長 VpnGwX SKU への変更には、VPN Gateway の再作成が必要となるため、VPN Gateway のアドレス変更が発生いたします。  </p><h3 id="VPN-Gateway-をトランジットした通信"><a href="#VPN-Gateway-をトランジットした通信" class="headerlink" title="VPN Gateway をトランジットした通信"></a>VPN Gateway をトランジットした通信</h3><p>VPN Gateway では Site-to-Site VPN 経由で接続された複数のサイト間の通信を行うことが可能です。<br>この場合、 サイト と Azure 間の接続には必ず <strong>BGP</strong> が必要になります。<br>スタティック構成( BGP を使用しない構成 )での VPN Gateway トランジット構成はサポートされませんのでご注意下さい。  </p><p><img src="/blog/network/vpngw-FAQ1/vpngw-transit.png" alt=""></p><h3 id="VPN-Gateway-ExpressRoute-共存環境のデザイン"><a href="#VPN-Gateway-ExpressRoute-共存環境のデザイン" class="headerlink" title="VPN Gateway, ExpressRoute 共存環境のデザイン"></a>VPN Gateway, ExpressRoute 共存環境のデザイン</h3><p>同一 VNET 内に ExpressRoute と VPN Gateway を配置することが可能です。<br>しかし、VPN Gateway Site-to-Site 接続で接続された拠点 A と ExpressRoute 接続された拠点 B 間は、Azure 経由で通信を行うことはできません (<strong>共存環境では GW 間のトランジット通信はできません</strong>)  </p><p><img src="/blog/network/vpngw-FAQ1/vpngw-er-coexist.png" alt=""></p><h1 id="Point-to-Site-に関する-FAQ"><a href="#Point-to-Site-に関する-FAQ" class="headerlink" title="Point-to-Site に関する FAQ"></a>Point-to-Site に関する FAQ</h1><h3 id="Azure-VPN-Client-のインストール方法"><a href="#Azure-VPN-Client-のインストール方法" class="headerlink" title="Azure VPN Client のインストール方法"></a>Azure VPN Client のインストール方法</h3><p>Azure VPN Client をローカルファイルにダウンロードし、 PC にインストールしたいというご相談をいただきますが、 Azure VPN Client は ユニバーサル Windows プラットフォームアプリケーションとして開発しているため、必ず <strong>Microsoft Store からのインストールが必要</strong> です。  </p><h3 id="VPN-クライアントを使用する際の管理者権限"><a href="#VPN-クライアントを使用する際の管理者権限" class="headerlink" title="VPN クライアントを使用する際の管理者権限"></a>VPN クライアントを使用する際の管理者権限</h3><p>Windows クライアントの Point-To-Site 接続では、3種類の VPN クライアント アプリケーションをサポートしております。各クライアントの使用にあたり以下のタイミングで管理者権限( Administrator )が必要となります。  </p><p>admin 権限が必要な処理</p><table><thead><tr><th>クライアントの種類</th><th>クライアント app インストール時</th><th>VPN 接続時</th></tr></thead><tbody><tr><td>Windows 標準の VPN クライアント (SSTP, IKE)</td><td>標準インストール</td><td>必要</td></tr><tr><td>OpenVPN クライアント( OpenVPN )</td><td>必要</td><td><strong>不要</strong></td></tr><tr><td>Azure VPN クライアント( OpenVPN )</td><td><strong>不要</strong></td><td><strong>不要</strong></td></tr></tbody></table><p>VPN 接続する際に使用するユーザアカウントに管理者権限が付与できない場合、 OpenVPN クライアント、もしくは Azure VPN クライアントを使用することで問題を回避できることがあります。  </p><h3 id="P2S-クライアントにおけるフルトンネル設定の可否"><a href="#P2S-クライアントにおけるフルトンネル設定の可否" class="headerlink" title="P2S クライアントにおけるフルトンネル設定の可否"></a>P2S クライアントにおけるフルトンネル設定の可否</h3><p>一般的に VPN クライアントが、全トラフィックを VPN 経由で行う設定をフルトンネル、一部トラフィックのみ VPN 経由で行う設定をスプリットトンネルと呼ばれておりますが、 Azure VPN Gateway 接続では <strong>スプリットトンネルのみサポート</strong> します。<br>もしフルトンネルで Azure VNET と接続する必要がある場合には、サードパーティ製の NVA をご使用下さい。  </p><h3 id="P2S-経由でのインターネット、-Azure-PaaS-サービスへのアクセス"><a href="#P2S-経由でのインターネット、-Azure-PaaS-サービスへのアクセス" class="headerlink" title="P2S 経由でのインターネット、 Azure PaaS サービスへのアクセス"></a>P2S 経由でのインターネット、 Azure PaaS サービスへのアクセス</h3><p>P2S クライアントは Azure VPN Gateway を経由させて、インターネット, PaaS サービスにダイレクトにアクセスすることはできません。  </p><p>もし、P2S クライアントから Azure VPN Gateway 経由でインターネットアクセスする場合には、 Azure 上に Proxy サーバを構築し、 Proxy を経由させることでインターネットにアクセスさせる必要がございます。  </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Azure VPN Gateway に関して、たびたびお問合せ頂く内容をご紹介させていただきます。  &lt;/p&gt;
&lt;h3 id=&quot;メンテナンスの事前通知&quot;&gt;&lt;a href=&quot;#メンテナンスの事前通知&quot; class=&quot;headerlink&quot; title=&quot;メンテナンスの事前通知
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
      <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway の散発的な 502 エラー</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-502error/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-502error/</id>
    <published>2020-09-28T08:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.486Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チーム檜山です。</p><p>今回は Application Gateway 経由で Web サイトへアクセスしている際にまれに 502 エラーが発生するという事象についてよくある事例を記載させていただきます。</p><hr><p>まれに 502 エラーが発生するという事象についてよくある事例としては以下がございます。</p><p>     <li><a href="#backend-keepalive"><strong>バックエンドの Web サーバーにて HTTP KeepAlive が有効化されている</strong></a></li></p><p></p><p>     <li><a href="#backend-issue"><strong>一時的な要因でバックエンドが TCP セッションを切断している</strong></a></li></p><p></p><p>以下のブログにも記載されておりますが、Application Gateway が HTTP Status 502 を返す理由はいくつかございます。散発的に発生するような場合は本稿に記載した内容も一度ご確認いただけますと幸いです。</p><ul><li><a href="https://jpaztech.github.io/blog/archive/application-gateway-502-error-info/">Application Gateway における 502 Error について</a></li></ul><p><span id="backend-keepalive"></span></p><h2 id="バックエンドの-Web-サーバーにて-HTTP-KeepAlive-が有効化されている"><a href="#バックエンドの-Web-サーバーにて-HTTP-KeepAlive-が有効化されている" class="headerlink" title="バックエンドの Web サーバーにて HTTP KeepAlive が有効化されている"></a><a href="#backend-keepalive">バックエンドの Web サーバーにて HTTP KeepAlive が有効化されている</a></h2><p>HTTP KeepAlive は複数の HTTP のリクエストで TCP のセッションを使いまわし、通信を効率化するために利用されますが、Web サーバーにて HTTP KeepAlive が有効化されている場合に TCP の通信状況によってはまれに HTTP のリクエストが破棄されてしまうような事象が発生します。</p><p>以下のパケットは Chrome と Apache (HTTP KeepAlive : Timeout 5 秒) で動作を確認した際のパケットです。(<strong>※HTTP KeepAlive 動作確認のため、Application Gateway は利用しておりません</strong>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">167.220.223.186 がクライアント (Chrome)</span><br><span class="line">10.0.1.4 が Web サーバー (Apache)</span><br></pre></td></tr></table></figure><p>No 97 で Web サーバーがレスポンスを返した 5 秒後にタイムアウトを迎え、FIN/ACK [No 99] を送りますが、そのタイミングでクライアントが HTTP リクエスト [No 100] を実施したため、そのリクエストについてはレスポンスが返らずに TCP セッションがクローズされていることを確認できます。</p><p><img src="./capture.png" alt=""></p><p>上記のような クライアント - Web サーバー間のシナリオの場合、クライアント側に  502 エラーが記録されることはなく、ブラウザの動作によっては再接続で自動復旧する場合があります。</p><p>一方で、これと同様の事象が Application Gateway - バックエンドの Web サーバー間で発生した場合に Application Gateway は クライアントに 502 エラーを返す動作となります。(下図参照)</p><p><img src="./AppGW502error.png" alt=""></p><p>そのため、散発的に 502 エラーが発生する場合、以下の点についてご確認いただけますでしょうか。</p><ul><li>HTTP KeepAlive が Web サーバーで有効化されていた場合、無効化し、事象が改善するか</li><li>HTTP KeepAlive の無効化が難しい場合、KeepAlive のタイムアウトを数分程度に長くして事象が緩和されるか</li></ul><p>一般的に HTTP KeepAlive によりエラーが発生する場合、クライアント側のタイムアウトより、サーバー側のタイムアウトを長くすることで対応可能となります。</p><p><strong> Application Gateway V1 </strong> の場合、Application Gateway - バックエンド間で Application Gateway がクライアントとして動作する場合の HTTP KeepAlive のタイムアウトは固定で定まっておりません。<br>そのため、300 秒等の長い時間を設定いただき、502 エラーが緩和されるかをご確認いただくか、HTTP KeepAlive を無効化することをご検討ください。</p><p><strong> Application Gateway V2 </strong> の場合、Application Gateway - バックエンド間で Application Gateway がクライアントとして動作する場合の HTTP KeepAlive のタイムアウトは 60 秒となることが確認できております。そのため、Web サーバー側で 90 秒や 120 秒といったタイムアウトを設定いただき、動作をご確認いただけますと幸いです。</p><p><span id="backend-issue"></span></p><h2 id="一時的な要因でバックエンドが-TCP-セッションを切断している"><a href="#一時的な要因でバックエンドが-TCP-セッションを切断している" class="headerlink" title="一時的な要因でバックエンドが TCP セッションを切断している"></a><a href="#backend-issue">一時的な要因でバックエンドが TCP セッションを切断している</a></h2><p>HTTP KeepAlive の問題ではない場合は一時的な要因でバックエンドが TCP セッションを切断している可能性もございます。</p><p>再現の頻度によっては調査が難しくなる場合がございますが、高頻度で再現する場合や時間帯が決まっている場合は以下もご確認ください。</p><h3 id="バックエンドの-Web-サーバーにてパケットキャプチャを取得し、以下を確認"><a href="#バックエンドの-Web-サーバーにてパケットキャプチャを取得し、以下を確認" class="headerlink" title="バックエンドの Web サーバーにてパケットキャプチャを取得し、以下を確認"></a>バックエンドの Web サーバーにてパケットキャプチャを取得し、以下を確認</h3><ul><li>Application Gateway からリクエストが届いているか</li><li>Application Gateway のアクセスログと照らし合わせ、該当の 502 エラーのリクエストに対して、レスポンスを返しているか</li></ul><h3 id="Application-Gateway-非経由でアクセスし、以下を確認"><a href="#Application-Gateway-非経由でアクセスし、以下を確認" class="headerlink" title="Application Gateway 非経由でアクセスし、以下を確認"></a>Application Gateway 非経由でアクセスし、以下を確認</h3><ul><li>遅延等なくレスポンスが返ってくるか</li></ul><p>ただし、Application Gateway - バックエンド間が HTTPS であった場合は暗号化されているため、パケットの詳細が確認できず調査が難航する場合がございますため、バックエンドへのアクセスを一時的に HTTP に変更し、調査を行うこともご検討ください。</p><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="クライアント-Application-Gatweay-間の-Application-Gateway-側の-HTTP-KeepAlive-のタイムアウトはいくつですか。"><a href="#クライアント-Application-Gatweay-間の-Application-Gateway-側の-HTTP-KeepAlive-のタイムアウトはいくつですか。" class="headerlink" title="クライアント - Application Gatweay 間の Application Gateway 側の HTTP KeepAlive のタイムアウトはいくつですか。"></a>クライアント - Application Gatweay 間の Application Gateway 側の HTTP KeepAlive のタイムアウトはいくつですか。</h4><p>V1 SKU の場合 120 秒、V2 SKU の場合 75 秒です。この値は固定値で変更することはできません。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-faq#what-are-the-settings-for-keep-alive-timeout-and-tcp-idle-timeout" target="_blank" rel="noopener">キープアライブ タイムアウトと TCP アイドル タイムアウトの設定はどのようになっていますか?</a></p><h4 id="Application-Gateway-で-HTTP-KeepAlive-を無効化する方法はありますか。"><a href="#Application-Gateway-で-HTTP-KeepAlive-を無効化する方法はありますか。" class="headerlink" title="Application Gateway で HTTP KeepAlive を無効化する方法はありますか。"></a>Application Gateway で HTTP KeepAlive を無効化する方法はありますか。</h4><p>以下のような構成の時、HTTP KeepAlive はクライアント - Application Gateway 間 (1) と、Application Gateway - バックエンド (2) の 2 つの間で利用される可能性があります。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">クライアント --(1)-- Application Gateway --(2)-- バックエンド</span><br></pre></td></tr></table></figure><p>(1),(2) ともに Application Gateway にて HTTP KeepAlive を無効化する方法はありませんので、無効化する場合はクライアントまたはバックエンドにて無効化する必要があります。</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Application Gateway のトラブルシューティングについては以下にも情報がございますので、ご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502" target="_blank" rel="noopener">Application Gateway での無効なゲートウェイによるエラーのトラブルシューティング</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting" target="_blank" rel="noopener">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポート チーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Application Gateway 経由で Web サイトへアクセスしている際にまれに 502 エラーが発生するという事象についてよくある事例を記載させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;ま
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ApplicationGateway" scheme="https://jpaztech.github.io/blog/tags/ApplicationGateway/"/>
    
      <category term="502" scheme="https://jpaztech.github.io/blog/tags/502/"/>
    
      <category term="Error" scheme="https://jpaztech.github.io/blog/tags/Error/"/>
    
  </entry>
  
  <entry>
    <title>VPN Gateway サービスにおける Azure テクニカル サポートの対応範囲</title>
    <link href="https://jpaztech.github.io/blog/network/vpngw-support-policy/"/>
    <id>https://jpaztech.github.io/blog/network/vpngw-support-policy/</id>
    <published>2020-09-23T13:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.502Z</updated>
    
    <content type="html"><![CDATA[<p>昨今のリモートワークへの移行などを背景に VPN に関するサポートへのお問い合わせも増加しております。<br>Azure VPN Gateway におきまして、サポートを効率的にご利用頂くための支援可能なシナリオについてご案内します。</p><h2 id="1-1-S2S-が接続できない、もしくは-接続が不安定な場合-障害からの復旧"><a href="#1-1-S2S-が接続できない、もしくは-接続が不安定な場合-障害からの復旧" class="headerlink" title="1.1 S2S が接続できない、もしくは 接続が不安定な場合 (障害からの復旧)"></a>1.1 S2S が接続できない、もしくは 接続が不安定な場合 (障害からの復旧)</h2><p><strong>運用稼働中の VPN 接続に障害が発生しトラフィックロスが発生している場合</strong><br>スタンダード以上のサポート契約があり重大なサービス影響が発生している場合には、緊急対応をいたしますので ケース重要度 A でお問合せ下さい。サービス復旧重視でのご支援をいたします。<br>構築中の案件に際しては、プロジェクト重要度に関わらずケース重要度 A では承ることができません。</p><ul><li>ご参考 サポートケースのケース重要度設定について<br><a href="https://azure.microsoft.com/ja-jp/support/plans/response/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/support/plans/response/</a>  </li></ul><p><strong>商用サービス稼働前(構築中)、もしくは運用稼働中ではあるが冗長が取れており実サービス影響がでていない場合</strong><br>トラブル解決のご支援をいたしますので、ケース重要度 B / C でお問合せください。<br>Azure VPN Gateway の観点で、設定の確認、 IKE によるネゴシエーションで問題がないか調査をいたします。<br>オンプレミス GW 観点での調査が必要な場合には、オンプレミス GW 観点での調査をお願いすることがございます。<br>その際にはお客様よりGW デバイスベンダー サポートへお問合せ下さい。  </p><h2 id="1-2-S2S-が一時的に切断したが、現在復旧している場合"><a href="#1-2-S2S-が一時的に切断したが、現在復旧している場合" class="headerlink" title="1.2 S2S が一時的に切断したが、現在復旧している場合"></a>1.2 S2S が一時的に切断したが、現在復旧している場合</h2><p>VPN Gateway との接続はインターネットを使用するため回線状況によって通信影響が発生することや、VPN Gateway はリソースの状態を最適に保つため、定期的にメンテナンスを実施しており、そのタイミングで数十秒程度の通信断が発生することもございます。<br>一時的な数十秒程度の通信断の後、正常動作をしている場合にはしばらくの間、正常性監視をしていただきますようお願いいたします。<br>通信断が頻繁(一日に数回)発生している場合には、なんらかの問題が発生していることが考えられますため、重要度 B もしくは C でお問合せ下さい。  </p><h2 id="1-3-障害原因調査について"><a href="#1-3-障害原因調査について" class="headerlink" title="1.3 障害原因調査について"></a>1.3 障害原因調査について</h2><p>原因調査は開発チームで実施するため、ご報告まで 1, 2 週間程度かかることがございます。<br>原因追及に関して緊急対応( 重要度 A )のご要望にはお応えすることができません。<br>また、VPN Gateway SLA( 99.95% ＝月の概算でトータル20分程度) を超えない、極めて軽微な通信影響( 再発性のない、60 秒未満の通信断 )については、原則として原因調査を承ることができません。</p><h2 id="1-4-接続実績のない-GW-デバイスをご使用の場合"><a href="#1-4-接続実績のない-GW-デバイスをご使用の場合" class="headerlink" title="1.4 接続実績のない GW デバイスをご使用の場合"></a>1.4 接続実績のない GW デバイスをご使用の場合</h2><p>IPsec では接続および、その設定の組み合わせにより接続性に問題が発生することがございます。<br>弊社ではGW デバイスベンダーに協力で接続試験を実施し、接続性が確認されたデバイスは検証済デバイスとして以下のリストに纏めてます。<br>一方で接続実績のない GW デバイスでもご使用頂ける可能性はございますが、 Azure サポートでは GW デバイスの設定、トラブルシューティングなどのご支援をすることができません。問題解決が必要な場合には GW デバイスベンダー サポートへ お問合せ下さい。  </p><ul><li>検証済みの VPN デバイスとデバイス構成ガイド<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-about-vpn-devices#validated-vpn-devices-and-device-configuration-guides" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-about-vpn-devices#validated-vpn-devices-and-device-configuration-guides</a><br><strong>未検証デバイスを使用した接続不具合が多く発生しております。Azure サポートでは不要なトラブルを回避するため、検証済デバイスのご使用を強く推奨しております。</strong>  </li></ul><h1 id="2-P2S-接続に関するご支援"><a href="#2-P2S-接続に関するご支援" class="headerlink" title="2.    P2S 接続に関するご支援"></a>2.    P2S 接続に関するご支援</h1><h2 id="2-1-P2S-の接続に関する問題"><a href="#2-1-P2S-の接続に関する問題" class="headerlink" title="2.1 P2S の接続に関する問題"></a>2.1 P2S の接続に関する問題</h2><p>VPN Gateway の観点で問題解決のご支援をいたします。<br>P2S 接続では複数のクライアントアプリケーションがあり、それぞれご支援できる内容が以下のように異なります。</p><p><strong>SSTP, IKEv2: Windows 標準クライアント</strong><br>Azure サポートではクライアント設定のご支援が可能です。<br>クライアント、もしくは環境固有の問題により、Windows 観点での調査が必要になる際には、プレミアサポート契約がある場合のみ、 Windows サポートチームが問題解決のご支援をいたします(有償レイバーを消費します)<br>Azure プロフェッショナル サポート契約 (Developer/Standard/Professional Direct) においてはオンプレミス デバイスの調査は行えません。</p><p><strong>IKEv2: オープンソース  Strong Swanクライアント( Linux、MacOS 等)</strong><br>Azure サポートでは Azure ドキュメントベースでのクライアント設定のご支援が可能です。<br>クライアント側の問題調査は、オープンソースコミュニティをご活用いただき、お客様ご自身で解決をする必要がございます。  </p><p><strong>IKEv2: MacOS 標準クライアント・iOS 標準クライアント</strong><br>Azure サポートでは Azure ドキュメントベースでのクライアント設定のご支援が可能です。<br>クライアント側の問題調査はベンダーサポート窓口にご相談ください。  </p><p><strong>OpenVPN: オープンソース OpenVPN クライアント</strong><br>Azure サポートでは Azure ドキュメントベースでのクライアント設定のご支援が可能です。<br>クライアント側の問題調査は、オープンソースコミュニティをご活用いただき、お客様ご自身で解決をする必要がございます。  </p><p><strong>OpenVPN: Azure VPN クライアント( Windows )</strong><br>Azure サポートにてクライアント設定、トラブルシューティングのご支援が可能です。<br>     クライアント、もしくは環境固有の問題により、Windows 観点での調査が必要になる際には、プレミアサポート契約がある場合のみ、 Windows サポートチームが問題解決のご支援をいたします(有償レイバーを消費します)<br>Azure プロフェッショナル サポート契約 (Developer/Standard/Professional Direct) においてはオンプレミス デバイスの調査は行えません。  </p><h1 id="3-接続品質-安定性、パフォーマンス-に関するご支援"><a href="#3-接続品質-安定性、パフォーマンス-に関するご支援" class="headerlink" title="3.    接続品質 ( 安定性、パフォーマンス ) に関するご支援"></a>3.    接続品質 ( 安定性、パフォーマンス ) に関するご支援</h1><p>Azure VPN Gateway はインターネットを使用した VPN 接続であるため、パフォーマンス、接続の安定を保証しているサービスではございません。以下の VPN Gateway SKU の性能指標がございますが、これらは VPN Gateway の最大パフォーマンスとなり、実際のパフォーマンスはオンプレミス GW とのインターネット接続品質に依存いたします。  </p><ul><li>VPN Gateway SKU 性能<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-about-vpngateways#gateway-skus-by-tunnel-connection-and-throughput" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-about-vpngateways#gateway-skus-by-tunnel-connection-and-throughput</a>  </li></ul><p>VPN Gateway 接続で想定性能がでない場合、 VPN Gateway リソース、弊社バックボーン状態を確認し、弊社設備内でパフォーマンスに影響する問題の有無について確認をいたします。<br>弊社設備内に問題がなく、インターネット接続品質問題の可能性がある場合にはお客様へプロバイダ調査を依頼をすることがございます。  </p><h1 id="4-VPN-Gateway-の仕様動作に関するご支援"><a href="#4-VPN-Gateway-の仕様動作に関するご支援" class="headerlink" title="4. VPN Gateway の仕様動作に関するご支援"></a>4. VPN Gateway の仕様動作に関するご支援</h1><p>仕様動作に関する調査は、Professional Direct、もしくは Premier サポートの アドバイザリ サポートとして承ります。<br>Professional Direct の場合、公開されている技術情報の範囲でご案内いたします。<br>Premier の場合には非公開情報を含め、仕様確認が必要となっている背景に応じて公開可能な範囲でご案内をいたします。  </p><h1 id="5．サービスデザインに関するご支援"><a href="#5．サービスデザインに関するご支援" class="headerlink" title="5．サービスデザインに関するご支援"></a>5．サービスデザインに関するご支援</h1><p>サービスデザインに関するご相談は Professional Direct、もしくは Premier サポートの アドバイザリ サポートとして承ります。<br>Professional Direct の場合、公開されている技術情報から、Premier の場合にはお客様構成に応じたご案内をいたします。    </p><ul><li>Azure サービス内でのデザインご支援となります。サードパーティ製品を含む場合のご相談には Azure サポートとしては承ることができません。また、 Windows などの有償サポート製品を含む場合には、事前にその旨をお伝えいたします。  </li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;昨今のリモートワークへの移行などを背景に VPN に関するサポートへのお問い合わせも増加しております。&lt;br&gt;Azure VPN Gateway におきまして、サポートを効率的にご利用頂くための支援可能なシナリオについてご案内します。&lt;/p&gt;
&lt;h2 id=&quot;1-1-S2S
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>ExpressRoute の Monthly Prefix Updates に関して</title>
    <link href="https://jpaztech.github.io/blog/network/ExpressRoutePrefixRollout/"/>
    <id>https://jpaztech.github.io/blog/network/ExpressRoutePrefixRollout/</id>
    <published>2020-08-28T05:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.486Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートの宇田です。</p><p>今回は月次で行われている Public / Microsoft Peering の経路更新のメンテナンスについてご紹介します。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>ExpressRoute 回線に紐づく Azure サブスクリプションでは、Service Health にて概ね月に一度の頻度で「Important Information Regarding Your ExpressRoute Service」といったタイトルの通知が行われております。こちらの内容について、技術サポートまでお問い合わせいただく事が多いため、今回は改めてブログでも詳細や影響についてご紹介いたします。</p><h3 id="通知メールの例"><a href="#通知メールの例" class="headerlink" title="通知メールの例"></a>通知メールの例</h3><p>(本文中の TRACKING ID や日時、経路数はその都度異なります)</p><p><img src="/blog/network/ExpressRoutePrefixRollout/ExpressRoutePrefixRollout1.png" alt="通知メールのサンプル"></p><h2 id="本通知の内容について"><a href="#本通知の内容について" class="headerlink" title="本通知の内容について"></a>本通知の内容について</h2><p>Public / Microsoft Peering をご利用の場合、弊社側からプロバイダー様やお客様のルーターに対し、BGP で Azure (および Office 365 等) で使用される Public IP の経路情報を広報しています。(下図参照)</p><p>Azure や Office 365 で利用される Public IP は、Azure リージョンの追加や、各リージョンの Public IP アドレスの利用状況 (需給バランス) に応じて追加・変更が生じるため、ExpressRoute の Public / Microsoft Peering で広報される経路情報にも随時変更が生じることになります。</p><p>Service Health での通知は、そうした経路情報の変更が発生することを念のためお知らせするものとご認識いただければと思います。</p><p><img src="/blog/network/ExpressRoutePrefixRollout/ExpressRoutePrefixRollout2.png" alt="Microsoft 側から広報される経路情報"></p><h2 id="影響有無について"><a href="#影響有無について" class="headerlink" title="影響有無について"></a>影響有無について</h2><p>弊社側から広報する経路に変更が生じても、基本的にはお客様側で特別の作業は必要なく、ExpressRoute 経由の通信に影響は生じません。</p><p>ただし、プロバイダー様やお客様側のルーターにおいて、事前に定義してある経路情報しか受け取らないようなルートフィルター (ACL 等) の設定を明示的に行われている場合には、変更後の経路を受け取れなくなる可能性がございますのでお心当たりのあるお客様は十分ご留意ください。(こうした設定を行われているお客様は僅かと認識しておりますが、もしご心配な場合にはご契約いただいているプロバイダー様やお客様側のルーターで Reject している経路がないかを念のためご確認いただければと思います。)</p><p>なお、Private Peering のみをご利用のお客様にも本通知が飛ぶことがありますが、Public / Microsoft Peering をご利用のお客様を対象としたものになりますので、Private Peering のみ利用されている場合は無視していただいて問題ありません。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>今回ご紹介した Prefix Update のメンテナンスは、ここ最近で始まったわけではなく、数年前から月次で実施されているものになります。したがって、冒頭に載せたようなメンテナンスの通知メールを受領したとしても、基本的には全く焦る必要はありません。上記の内容を正しくご理解いただいた上で、「毎月恒例のやつだな」と思っていただければ幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。Azure サポートの宇田です。&lt;/p&gt;
&lt;p&gt;今回は月次で行われている Public / Microsoft Peering の経路更新のメンテナンスについてご紹介します。&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;he
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
      <category term="Public Peering" scheme="https://jpaztech.github.io/blog/tags/Public-Peering/"/>
    
      <category term="Microsoft Peering" scheme="https://jpaztech.github.io/blog/tags/Microsoft-Peering/"/>
    
      <category term="Maintenance" scheme="https://jpaztech.github.io/blog/tags/Maintenance/"/>
    
  </entry>
  
  <entry>
    <title>Bastion のサブネットに 適用する NSG の設定例</title>
    <link href="https://jpaztech.github.io/blog/network/bastion-nsg/"/>
    <id>https://jpaztech.github.io/blog/network/bastion-nsg/</id>
    <published>2020-08-11T05:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.490Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの薄井です。<br>今回は Bastion のサブネットに関連付けることのできる NSG についてご紹介します。</p><p>よく Bastion のサブネットへのアクセスに制限をかけたいといったお問い合わせをいただきます。Bastion のサブネットに適用する NSG の設定については<a href="https://docs.microsoft.com/ja-jp/azure/bastion/bastion-nsg" target="_blank" rel="noopener">公式ドキュメント</a>に、NSG の既定の規則をそのまま利用した場合の説明がございます。<br>本記事では、既定の規則を全て拒否した場合の設定例を画像とともにご紹介いたします。</p><a id="more"></a><h2 id="受信セキュリティ規則"><a href="#受信セキュリティ規則" class="headerlink" title="受信セキュリティ規則"></a>受信セキュリティ規則</h2><p>以下に掲載しております画像の例では、優先度 120 番にて Bastion にアクセスするクライアントのグローバル IP アドレスのみを許可している例となります。優先度 4096 番に全てを拒否するルールを入れて既定のルールを拒否しています。<br>受信セキュリティ規則では以下のルールが必須となります。</p><ul><li>GatewayManager から任意の宛先への HTTPS（TCP ポート 443）の許可</li><li>AzureLoadBalancer から任意の宛先への TCP の許可</li><li>Bastion に接続するクライアントの IP アドレスから任意の宛先への HTTPS（TCP ポート 443）の許可。</li></ul><p><img src="/blog/network/bastion-nsg/bastion_nsg_in.png" alt="受信セキュリティ規則の設定例"></p><h2 id="送信セキュリティ規則"><a href="#送信セキュリティ規則" class="headerlink" title="送信セキュリティ規則"></a>送信セキュリティ規則</h2><p>以下に掲載しております画像の例では、必須となるルールのみを許可している例となります。優先度 4096 番に全てを拒否するルールを入れて既定のルールを拒否しています。<br>送信セキュリティ規則では以下のルールが必須となります。</p><ul><li>任意の送信元から VirtualNetwork への SSH と RDP (TCP ポート 22 と TCP ポート 3389) の許可。どちらか一方のプロトコルしか使わないような場合でも両方必要となります。</li><li>任意の送信元から AzureCloud への HTTPS（TCP ポート 443）の許可</li><li>任意の送信元から Internet への HTTP (TCP ポート 80) の許可。Bastion のセッション情報の管理に使用されます。</li></ul><p><img src="/blog/network/bastion-nsg/bastion_nsg_out.png" alt="送信セキュリティ規則の設定例"></p><h2 id="VM-および-VM-のサブネットの-NSG-の受信セキュリティ規則"><a href="#VM-および-VM-のサブネットの-NSG-の受信セキュリティ規則" class="headerlink" title="VM および VM のサブネットの NSG の受信セキュリティ規則"></a>VM および VM のサブネットの NSG の受信セキュリティ規則</h2><p>Bastion の接続先となる VM および VM のサブネットに NSG を設定する場合は、VM 側の NSG の受信セキュリティ規則において、Bastion のサブネットから VM のサブネットへの SSH もしくは RDP (TCP ポート 22 もしくは TCP ポート 3389) の許可をするルールが必要となります。</p><p>以下に掲載しております画像の例では、優先度 100 番の規則において Bastion のサブネットから Windows の VM に接続するために RDP（TCP ポート 3389)  宛の接続を許可した例となります。</p><p>Bastion から Linux の VM に接続をする場合には SSH（TCP ポート 22）宛の接続の許可が必要となります。</p><p><img src="/blog/network/bastion-nsg/vm_nsg_in.png" alt="VM の NSG の受信セキュリティ規則の設定例"></p><p>送信セキュリティ規則は特に必要な設定はございません。</p><h2 id="その他の-Bastion-に関連する情報"><a href="#その他の-Bastion-に関連する情報" class="headerlink" title="その他の Bastion に関連する情報"></a>その他の Bastion に関連する情報</h2><p>Bastion のサブネットに関連づける NSG について関連する情報が以下のページにあります。<br>併せてご参考いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/bastion/bastion-nsg" target="_blank" rel="noopener">NSG アクセスと Azure Bastion を使用する</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの薄井です。&lt;br&gt;今回は Bastion のサブネットに関連付けることのできる NSG についてご紹介します。&lt;/p&gt;
&lt;p&gt;よく Bastion のサブネットへのアクセスに制限をかけたいといったお問い合わせをいただきます。Bastion のサブネットに適用する NSG の設定については&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/bastion/bastion-nsg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;公式ドキュメント&lt;/a&gt;に、NSG の既定の規則をそのまま利用した場合の説明がございます。&lt;br&gt;本記事では、既定の規則を全て拒否した場合の設定例を画像とともにご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Bastion" scheme="https://jpaztech.github.io/blog/tags/Bastion/"/>
    
      <category term="NSG" scheme="https://jpaztech.github.io/blog/tags/NSG/"/>
    
  </entry>
  
  <entry>
    <title>証明書の失効に関するアドバイザリ PVKM-5T8 の補足情報</title>
    <link href="https://jpaztech.github.io/blog/network/20200716-net/"/>
    <id>https://jpaztech.github.io/blog/network/20200716-net/</id>
    <published>2020-07-16T00:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.486Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの飯塚です。</p><p>先日、一部の証明書の失効に伴う影響についてのアドバイザリを、以下の URL にて公開するとともに、影響を受ける可能性があるサービスをご利用いただいているお客様に、追跡 ID: PVKM-5T8 でセキュリティ アドバイザリの通知を行いました。</p><a id="more"></a><p><a href="https://azure.microsoft.com/en-us/updates/certificateauthorityrevocation/" target="_blank" rel="noopener">Revocation of non-compliant Certificate Authorities potentially impacting customer’s Azure service(s).</a></p><p>内容や対応については上記の URL で公開されているとおりですが、英語での案内ということもあり、わかりづらい可能性がございましたので、日本語での補足記事をご用意させていただきました。以下のとおりご案内いたします。</p><h2 id="通知の背景"><a href="#通知の背景" class="headerlink" title="通知の背景"></a>通知の背景</h2><p>最近、CA ブラウザー フォーラム (*1) のメンバーによって、DigiCert 社の一部の中間認証局において、その管理、運用上、本来満たすべき要件の一部が満たされていないという内容が報告されました。これを受けて、該当の中間認証局より発行された証明書を失効させる措置が行われました。失効措置の対象となる証明書を利用している場合、証明書を再度取得して、失効対象の証明書と置き換える措置を行う必要があります。</p><p>対象となる認証局の情報などを含むレポートの詳細は、こちらにまとまっています。</p><ul><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1649951" target="_blank" rel="noopener">DigiCert: Incorrect OCSP Delegated Responder Certificate</a></li><li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1650910" target="_blank" rel="noopener">DigiCert: Inconsistent EV audits</a></li></ul><p>この問題自体は認証局の問題であり、Microsoft Azure と直接関係のあるものではありません。しかし、Azure では一部のサービスにおいて、お客様が取得した証明書を持ち込んで利用するケースがあります。そのようなケースにおいて予期せずサービス影響が生じないよう、注意喚起のために、念のため弊社からも通知をさせていただきました。</p><p>(*1) CA ブラウザー フォーラムについては、<a href="(https://www.nic.ad.jp/ja/basics/terms/ca_browser_forum.html)">JPNIC のウェブサイト</a>にてわかりやすく説明されています。</p><h2 id="影響を受ける可能性のあるサービス"><a href="#影響を受ける可能性のあるサービス" class="headerlink" title="影響を受ける可能性のあるサービス"></a>影響を受ける可能性のあるサービス</h2><p>お客様が証明書を持ち込んで適用する可能性のあるサービスとして、Azure では以下を把握しております。これらのサービスに対して、お客様が取得した証明書を持ち込んで適用している場合は、影響を受ける可能性があります。</p><p>API Management; Application Gateway; App Service; Azure Active Directory Domain Services; Azure Front Door Service; CDN</p><h2 id="利用している証明書が失効対象かどうかの確認"><a href="#利用している証明書が失効対象かどうかの確認" class="headerlink" title="利用している証明書が失効対象かどうかの確認"></a>利用している証明書が失効対象かどうかの確認</h2><p>影響を受ける中間認証局の情報は、以下の DigiCert 社の資料にまとまっております。</p><ul><li><a href="https://knowledge.digicert.com/alerts/DigiCert-ICA-Replacement" target="_blank" rel="noopener">DigiCert ICA Replacement</a></li></ul><p>資料には、以下の中間認証局が対象という情報がまとまっています。これらの認証局から発行された証明書を利用している場合、それらは失効措置の対象となります。</p><ul><li>DigiCert Global CA G2</li><li>GeoTrust TLS RSA CA G1</li><li>Thawte TLS RSA CA G1</li><li>Secure Site CA</li><li>NCC Group Secure Server CA G2</li><li>TERENA SSL High Assurance CA 3</li></ul><p>対象かどうかの判断ができない場合は、念のため証明書の発行を受けた認証局にお問い合わせいただくことをお勧めいたします。なお、対象は EV 証明書のみという情報も記載がありますので、その他 (OV や DV) についても対象外と考えることができます。</p><h2 id="必要な対処手順"><a href="#必要な対処手順" class="headerlink" title="必要な対処手順"></a>必要な対処手順</h2><p>もし、失効対象の証明書を Azure の各サービスに適用・利用している場合、認証局より証明書を再取得いただくとともに、それぞれのサービスにおいて証明書の入れ替えが必要になります。それぞれのサービスにおける証明書の入れ替え手順について、以下の資料でご案内させていただいておりますので、もし対象の場合は、内容をご確認のうえ、証明書の入れ替えを実施いただければと思います。</p><p>なお、DigiCert 社のアナウンスでは、7 月 11 日までに対象の証明書については入れ替えを行うようにという案内がありますが、厳密な失効のスケジュールについては、認証局にお問い合わせいただけますようお願いいたします。</p><h3 id="API-Management"><a href="#API-Management" class="headerlink" title="API Management"></a>API Management</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/api-management/api-management-howto-ca-certificates" target="_blank" rel="noopener">Azure API Management でカスタム CA 証明書を追加する方法</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/api-management/configure-custom-domain#use-the-azure-portal-to-set-a-custom-domain-name" target="_blank" rel="noopener">カスタム ドメイン名の構成 - Azure ポータルを使用してカスタム ドメイン名を設定する</a></p><h3 id="Application-Gateway"><a href="#Application-Gateway" class="headerlink" title="Application Gateway"></a>Application Gateway</h3><p><a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-faq#my-ev-certificate-is-issued-by-digicert-and-my-intermediate-certificate-has-been-revoked-how-do-i-renew-my-certificate-on-application-gateway" target="_blank" rel="noopener">My EV certificate is issued by DigiCert and my intermediate certificate has been revoked. How do I renew my certificate on Application Gateway?</a> (現状英語版のみの提供となります)</p><h3 id="App-Service"><a href="#App-Service" class="headerlink" title="App Service"></a>App Service</h3><p><a href="https://azure.github.io/AppService/2020/07/14/Cert-Revoke.html" target="_blank" rel="noopener">Certificate Authorities revoking non-compliant certificates, potentially impacting your App Service</a> (現状英語版のみの提供となります)</p><h3 id="Azure-CDN"><a href="#Azure-CDN" class="headerlink" title="Azure CDN"></a>Azure CDN</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-2-enable-https-with-your-own-certificate#tlsssl-certificates" target="_blank" rel="noopener">チュートリアル:Azure CDN カスタム ドメインで HTTPS を構成する - TLS/SSL 証明書</a></p><h3 id="Azure-Front-Door"><a href="#Azure-Front-Door" class="headerlink" title="Azure Front Door"></a>Azure Front Door</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-custom-domain-https" target="_blank" rel="noopener">チュートリアル:Front Door カスタム ドメインで HTTPS を構成する</a></p><h3 id="Azure-AD-アプリケーション-プロキシ"><a href="#Azure-AD-アプリケーション-プロキシ" class="headerlink" title="Azure AD アプリケーション プロキシ"></a>Azure AD アプリケーション プロキシ</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/application-proxy-configure-custom-domain#set-up-and-use-custom-domains" target="_blank" rel="noopener">Azure AD アプリケーション プロキシでカスタム ドメインを構成する - カスタム ドメインを設定して使用する</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの飯塚です。&lt;/p&gt;
&lt;p&gt;先日、一部の証明書の失効に伴う影響についてのアドバイザリを、以下の URL にて公開するとともに、影響を受ける可能性があるサービスをご利用いただいているお客様に、追跡 ID: PVKM-5T8 でセキュリティ アドバイザリの通知を行いました。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Azure CDN の特徴やよくあるお問い合わせ、トラブル シューティングの紹介</title>
    <link href="https://jpaztech.github.io/blog/network/cdn-common/"/>
    <id>https://jpaztech.github.io/blog/network/cdn-common/</id>
    <published>2020-07-15T00:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.494Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム箕輪です。</p><p>Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。<br>Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しています。<br>本ブログは Azure CDN における共通的な事項をまとめたブログとなります。</p><a id="more"></a> <p>各 SKU の特徴や、各 SKU における情報採取の手順については、以下のブログでまとめていますのでご参照ください。</p><ul><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/">Azure CDN の各 SKU の特徴、トラブルシューティングの紹介</a></li></ul><p>本ブログでは、Azure CDN の共通的な機能として、以下の項目についてご案内しています。</p><ul><li>Azure CDN の特徴</li><li>Azure CDN のよくあるお問合せ</li><li>構築・設定変更時のエラーのトラブルシューティング</li><li>接続エラーなどが発生した際のトラブルシューティング</li></ul><br><p><span id="feature-of-azure-cdn"></span></p><h2 id="Azure-CDN-の特徴"><a href="#Azure-CDN-の特徴" class="headerlink" title="Azure CDN の特徴"></a><a href="#feature-of-azure-cdn">Azure CDN の特徴</a></h2><p>Azure CDN は 3 社の CDN プロバイダー (Microsoft / Verizon / Akamai)  で CDN サービスを提供しています。<br>各社の CDN プラットフォームによりご利用いただける機能が異なり、各 SKU の比較は <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-features" target="_blank" rel="noopener">弊社公開情報</a> でご案内しています。<br>Azure CDN の 4 つの SKU で共通して利用できる機能について、弊社公開情報のリンクとあわせてご紹介します。</p><ul><li>固定費用がかからない、転送量に応じた課金体系<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/cdn/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/pricing/details/cdn/</a></li><li>任意のリソース名でプロファイルとエンドポイントが構成でき、既定のエンドポイントは HTTPS に対応<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-create-new-endpoint" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-create-new-endpoint</a></li><li>お客様に管理された任意のドメイン (カスタムドメイン) を利用可能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-map-content-to-custom-domain" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-map-content-to-custom-domain</a></li><li>Azure CDN で管理された無料の SSL 証明書を用いたカスタムドメインの HTTPS 接続を提供<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-1-default-enable-https-with-a-cdn-managed-certificate" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-custom-ssl?tabs=option-1-default-enable-https-with-a-cdn-managed-certificate</a></li><li>キャッシュされたコンテンツのキャッシュ消去 (Purge)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-purge-endpoint" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-purge-endpoint</a></li><li>コンテンツのキャッシュ期間の設定<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-caching-rules" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-caching-rules</a></li><li>キャッシュされたコンテンツのファイル圧縮機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-improve-performance" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-improve-performance</a></li><li>リクエストやキャッシュ ヒット数などのログ確認機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-azure-diagnostic-logs" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-azure-diagnostic-logs</a></li><li>国/地域別のアクセス制御<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-restrict-access-by-country" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-restrict-access-by-country</a></li></ul><br><p><span id="qa-of-azure-cdn"></span></p><h2 id="Azure-CDN-のよくあるお問合せ"><a href="#Azure-CDN-のよくあるお問合せ" class="headerlink" title="Azure CDN のよくあるお問合せ"></a><a href="#qa-of-azure-cdn">Azure CDN のよくあるお問合せ</a></h2><p>Azure CDN において、お客様よりよくお問い合わせいただく内容についてご紹介いたします。</p><br><p><span id="q1"></span></p><h4 id="Azure-CDN-のリソースのリージョンを指定したい-Azure-CDN-のリソースを日本だけに固定したい"><a href="#Azure-CDN-のリソースのリージョンを指定したい-Azure-CDN-のリソースを日本だけに固定したい" class="headerlink" title="Azure CDN のリソースのリージョンを指定したい / Azure CDN のリソースを日本だけに固定したい"></a><a href="#q1">Azure CDN のリソースのリージョンを指定したい / Azure CDN のリソースを日本だけに固定したい</a></h4><p>Azure CDN では、世界中で構成された CDN の POP からサービスを提供しており、リージョン単位でのサービス提供はしていません。<br>Azure CDN のプロファイルを構成される場合、既定では global というリージョンでリソースが構成され、特定のリージョンだけにお客様の構成情報を適応するといった機能はありません。<br>Azure CDN の構成方法によっては Azure CDN のリージョンが global 以外となる場合がありますが、いずれのリージョンであっても動作や機能に違いはありません。</p><p>接続制限という観点で特定のリージョンを指定されたい場合は、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-restrict-access-by-country" target="_blank" rel="noopener">国/地域別の Azure CDN コンテンツの制限</a> の機能をご検討ください。</p><br><p><span id="q2"></span></p><h4 id="Azure-CDN-から更新されたコンテンツが配信されない"><a href="#Azure-CDN-から更新されたコンテンツが配信されない" class="headerlink" title="Azure CDN から更新されたコンテンツが配信されない"></a><a href="#q2">Azure CDN から更新されたコンテンツが配信されない</a></h4><p>Azure CDN はクライアント (ユーザー) からの要求 URL に対して、CDN 上でキャッシュされたコンテンツがあれば CDN から応答し、キャッシュされたコンテンツが無い場合やキャッシュの有効期間が過ぎている場合は、配信元に対象のコンテンツを取得した上で、クライアント (ユーザー) に応答する動作となります。</p><p>配信元のコンテンツを更新されたにもかかわらず、Azure CDN から更新される前のコンテンツが応答される場合は、Azure CDN 上のキャッシュを消去 (Purge) いただくことで、Azure CDN はクライアント (ユーザー) からの要求 URL に対して、配信元に更新されたコンテンツを取得し、クライアント (ユーザー)  に応答します。</p><br><p><span id="q3"></span></p><h4 id="Azure-CDN-を利用した際に発生する費用の考え方について"><a href="#Azure-CDN-を利用した際に発生する費用の考え方について" class="headerlink" title="Azure CDN を利用した際に発生する費用の考え方について"></a><a href="#q3">Azure CDN を利用した際に発生する費用の考え方について</a></h4><p>Azure CDN おいて発生する費用の考え方については、以下の弊社公開情報にてご案内しています。<br>実際に発生する費用や、お客様の固有のご環境における費用のご質問についてご確認されたい場合は、課金の観点で弊社サポート担当までお問い合わせください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing</a></p><br><p><span id="q4"></span></p><h4 id="新規でエンドポイントを設定したがエラーになる"><a href="#新規でエンドポイントを設定したがエラーになる" class="headerlink" title="新規でエンドポイントを設定したがエラーになる"></a><a href="#q4">新規でエンドポイントを設定したがエラーになる</a></h4><p>Azure CDN は世界中で構成された CDN の POP から CDN サービスを提供しているため、世界中で一意のリソース名で構成される必要があります。<br>設定されたいエンドポイント名が既に利用されている場合はエラーとなり設定ができないため、別のエンドポイント名をご利用ください。<br>(Azure CDN のプロファイル名は任意のリソース名を設定できます。)</p><p>設定されたいエンドポイント名が利用可能かは、<a href="https://docs.microsoft.com/en-us/rest/api/cdn/checknameavailability" target="_blank" rel="noopener">こちらの REST API</a> によりご確認いただけます。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"contoso-cdn"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"Microsoft.Cdn/Profiles/Endpoints"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(contoso-cdn をお客様のご利用されたいリソース名に置き換えて Body に入力し、REST API を実行してください)</span><br></pre></td></tr></table></figure><br><p><span id="q5"></span></p><h4 id="カスタムドメインを別のエンドポイントに移行したい"><a href="#カスタムドメインを別のエンドポイントに移行したい" class="headerlink" title="カスタムドメインを別のエンドポイントに移行したい"></a><a href="#q5">カスタムドメインを別のエンドポイントに移行したい</a></h4><p>Azure CDN のエンドポイントに設定されたカスタムドメインの設定を維持したままエンドポイントの変更はできません。<br>カスタムドメインを別のエンドポイントに移行する場合、既存のカスタムドメインの設定を削除いただいた上で移行する必要があります。</p><br><p><span id="q6"></span></p><h4 id="CORS-に対応する方法を知りたい"><a href="#CORS-に対応する方法を知りたい" class="headerlink" title="CORS に対応する方法を知りたい"></a><a href="#q6">CORS に対応する方法を知りたい</a></h4><p>HTTP ヘッダの CORS (クロス オリジン リソース共有) の利用方法については、以下の弊社公開上でご案内しています。<br>CORS の設定後、意図した動作とならない場合は、一度キャッシュ消去 (Purge) を実行いただき、動作をご確認ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-cors" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-cors</a> </p><br><p><span id="q7"></span></p><h4 id="独自の証明書を利用したカスタムドメインの-HTTPS-有効化について"><a href="#独自の証明書を利用したカスタムドメインの-HTTPS-有効化について" class="headerlink" title="独自の証明書を利用したカスタムドメインの HTTPS 有効化について"></a><a href="#q7">独自の証明書を利用したカスタムドメインの HTTPS 有効化について</a></h4><p>カスタムドメインの HTTPS 有効化において、Azure CDN で管理された証明書 (DigiCert 社の証明書) 以外に、独自の証明書 (お客様に準備いただいた証明書) がご利用できます。<br>独自の証明書がご利用いただけるのは Standard Microsoft と Standard Verizon、Premium Verizon となります。<br>Standard Akamai では独自の証明書はご利用いただけず、Let’s Encrypt の証明書で HTTPS 接続が利用できます。<br>独自の証明書をご利用いただく際は、Azure CDN のリソースが構成された同じサブスクリプションに Azure Key Vault リソースを構成いただき、証明書をアップロードする必要があります。</p><p>なお、Standard Microsoft では <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-troubleshoot-allowed-ca" target="_blank" rel="noopener">特定の認証局 (CA) で発行された証明書</a> をご利用いただく必要があります。<br>Standard Verizon、Premium Verizon においては、任意の認証局 (CA) で発行された証明書が利用できますが、自己署名証明書は利用できず、また Azure Key Vault にアップロードいただく証明書には認証局 (CA) の中間証明書を含めるように構成する必要があります。<br>以下の openssl コマンドで、中間 CA 証明書を含んだ PFX 形式の証明書を構成できますのでご参照ください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> PublicSSLcert.cer -inkey PrivateKey.key -certfile IntermediateCAcert.cer -out PFXcert.pfx</span><br><span class="line"> </span><br><span class="line">* PublicSSLcert.cer : 認証局 (CA) より発行された SSL 証明書</span><br><span class="line">* PrivateKey.key : 認証局 (CA) に送付した CSR を構成された際の秘密鍵</span><br><span class="line">* IntermediateCAcert.cer : 認証局 (CA) の中間 CA 証明書</span><br><span class="line">* PFXcert.pfx : openssl コマンドにより出力される PFX 形式のファイル</span><br></pre></td></tr></table></figure><br><p><span id="q8"></span></p><h4 id="Azure-CDN-で利用されている-IP-リストが知りたい"><a href="#Azure-CDN-で利用されている-IP-リストが知りたい" class="headerlink" title="Azure CDN で利用されている IP リストが知りたい"></a><a href="#q8">Azure CDN で利用されている IP リストが知りたい</a></h4><p>Azure CDN で利用されている IP リストは、以下の弊社公開情報にて公開しています。<br>Standard Akamai においては、公開された IP リストはありません。<br>配信元 (オリジン) で Azure CDN からの接続を IP リストで制限されたい場合は、Standard Microsoft、Standard Verizon、Premium Verizon をご利用ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-pop-list-api" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-pop-list-api</a></p><br><p><span id="q9"></span></p><h4 id="配信元-オリジン-に-HTTPS-だけ接続するようにしたい"><a href="#配信元-オリジン-に-HTTPS-だけ接続するようにしたい" class="headerlink" title="配信元 (オリジン) に HTTPS だけ接続するようにしたい"></a><a href="#q9">配信元 (オリジン) に HTTPS だけ接続するようにしたい</a></h4><p>Azure CDN の動作として、クライアント (ユーザー) からの要求プロトコルを用いて配信元 (オリジン) に接続する動作となります。<br>クライアント (ユーザー) が HTTP で要求 URL を送信した場合、Azure CDN は配信元 (オリジン) に HTTP でコンテンツを取得します。</p><p>クライアント (ユーザー) からの HTTP の要求 URL を HTTPS にリダイレクトしたい場合、Standard Microsoft と Premium Verizon で提供しているルール エンジンを利用いただく必要があります。<br>Standard Akamai や Standard Verizon はルール エンジンが利用できないため、HTTPS リダイレクトは構成できません。<br>HTTPS リダイレクトを構成する方法は、以下の弊社公開情報でご案内しておりますのでご参照ください。<br>なお、Azure CDN のエンドポイントの設定で、HTTP を受け入れプロトコルとして許可していない場合、HTTPS へのリダイレクトは動作しない点はご注意ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-storage-custom-domain-https#http-to-https-redirection" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-storage-custom-domain-https#http-to-https-redirection</a></p><br><p><span id="q10"></span></p><h4 id="Azure-CDN-で認証機能を利用したい"><a href="#Azure-CDN-で認証機能を利用したい" class="headerlink" title="Azure CDN で認証機能を利用したい"></a><a href="#q10">Azure CDN で認証機能を利用したい</a></h4><p>Premium Verizon では <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-token-auth" target="_blank" rel="noopener">トークン認証</a> の機能を提供しておりますが、それ以外の認証機能 (基本認証、クライアント認証など) は Azure CDN では提供していません。<br>配信元 (オリジン) として Azure Storage をご利用されている環境では、Azure Storage の SAS (Shared Access Signature) の機能を利用し、以下の公開情報でご案内しておりますのでご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-sas-storage-support" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-sas-storage-support</a></p><br><p><span id="q11"></span></p><h4 id="Azure-CDN-で対象の-URL-がキャッシュされているかを確認したい"><a href="#Azure-CDN-で対象の-URL-がキャッシュされているかを確認したい" class="headerlink" title="Azure CDN で対象の URL がキャッシュされているかを確認したい"></a><a href="#q11">Azure CDN で対象の URL がキャッシュされているかを確認したい</a></h4><p>Azure ポータルなどの機能で、対象の URL のコンテンツが CDN 上にキャッシュされているかを確認する機能はありませんが、対象の URL への応答における HTTP ヘッダを確認することで、CDN 上に対象の URL のコンテンツがキャッシュされているかを確認できます。<br>確認方法として、HTTP ヘッダの x-cache が HIT や TCP_HIT となっている場合、Azure CDN 上でキャッシュされたコンテンツが応答されている状態となります。</p><p>HTTP ヘッダの x-cache の確認方法としては、<a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザにおけるネットワーク トレース (F12) </a> で、対象 URL の HTTP の x-cache の応答ヘッダを確認いただくか、以下の curl コマンドの結果で x-cache を確認できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -H https://contoso-cdn.azureedge.net/xxx/xxx</span><br><span class="line"></span><br><span class="line">(http や https 以降を対象の URL に置き換えて実行ください)</span><br></pre></td></tr></table></figure><p>Standard Akamai では、Web プラウザでは HTTP ヘッダの x-cache を確認できないため、以下の curl コマンドでご確認ください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"Pragma: akamai-x-cache-on"</span> \</span><br><span class="line">-IXGET https://contoso-cdn.azureedge.net/xxx/xxx</span><br><span class="line"></span><br><span class="line">(http や https 以降を対象の URL に置き換えて実行ください)</span><br></pre></td></tr></table></figure><br><p><span id="troubleshooting-changing-settings"></span></p><h2 id="構築・設定変更時のエラーのトラブルシューティング"><a href="#構築・設定変更時のエラーのトラブルシューティング" class="headerlink" title="構築・設定変更時のエラーのトラブルシューティング"></a><a href="#troubleshooting-changing-settings">構築・設定変更時のエラーのトラブルシューティング</a></h2><p>Azure CDN を新規で構築されている場合、または設定変更後に Azure CDN を介してコンテンツが取得できなくなった場合は以下をお試しください。</p><br><p><span id="troubleshooting-1"></span></p><h4 id="Azure-CDN-を新規で構築した場合"><a href="#Azure-CDN-を新規で構築した場合" class="headerlink" title="Azure CDN を新規で構築した場合"></a><a href="#troubleshooting-1">Azure CDN を新規で構築した場合</a></h4><p>Azure CDN を新規で構築された場合、世界中にある POP に構成情報を展開するため、新規でリソースを構成いただいた後に反映までしばらくお時間を要します。<br>Azure CDN の SKU によって以下の通り反映に要する時間が異なります。<br>特に Verizon SKU をご利用いただいているご環境においては設定の反映に 90 分はお時間を要し、90 分以内に動作を確認されても想定された動作とならない可能性があります。<br>その場合は、90 分お待ちいただいた上で動作をご確認ください。</p><p>　Standard Microsoft : 10 分<br>　Standard Verizon / Premium Verizon : 90 分<br>　Standard Akamai : 1 分</p><br><p><span id="troubleshooting-2"></span></p><h4 id="DNS-関連の変更をした場合"><a href="#DNS-関連の変更をした場合" class="headerlink" title="DNS 関連の変更をした場合"></a><a href="#troubleshooting-2">DNS 関連の変更をした場合</a></h4><p>DNS 関連の変更などをした場合、一般的に DNS の設定の反映にはしばらく時間を要するため、設定直後に確認された際には意図した結果とならない可能性があります。<br>例えば DNS の参照する先を変更した場合などは、クライアント環境においてキャッシュ DNS をクリアなどしてから状況が変わるかをお試しください。<br>また、<a href="https://digwebinterface.com/" target="_blank" rel="noopener">オンライン ツール</a> などをご利用いただき、DNS の最新の状況についてご確認ください。</p><br><p><span id="troubleshooting-3"></span></p><h4 id="Azure-CDN-の設定反映"><a href="#Azure-CDN-の設定反映" class="headerlink" title="Azure CDN の設定反映"></a><a href="#troubleshooting-3">Azure CDN の設定反映</a></h4><p>Azure CDN は世界中にある POP の CDN のリソースに変更された構成情報を展開するため、Azure ポータルなどで変更された内容が各 POP に反映されるまで時間を要します。<br>目安としては 10 分ほどお待ちいただき、変更された内容が適応されているかをご確認ください。<br>また、既に CDN 上にキャッシュなどがある場合、意図した動作とならない可能性があるため、各設定の反映を確認するためにキャッシュの消去 (Purge) を一度実施いただくことをお勧めいたします。</p><p>なお、設定変更後に時間を空けずに別の変更を設定された場合、設定の反映に齟齬が発生し、意図した設定が適応されない事象が発生する可能性があります。<br>そのため、各設定変更の後は少なくとも 10 分はお時間を空けてからお試しください。</p><p>また、カスタムドメインやエンドポイントの削除を伴う変更については、短時間で削除、再生成をするとエラーとなる可能性があります。<br>同じカスタムドメインやエンドポイント名をご利用される場合は、削除後に目安として 2 時間ほど時間を空けてから再生成ください。</p><br><p><span id="troubleshooting-connection-error"></span></p><h2 id="接続エラーなどが発生した際のトラブルシューティング"><a href="#接続エラーなどが発生した際のトラブルシューティング" class="headerlink" title="接続エラーなどが発生した際のトラブルシューティング"></a><a href="#troubleshooting-connection-error">接続エラーなどが発生した際のトラブルシューティング</a></h2><p>設定変更などを実施されていないご状況において、Azure CDN を介してコンテンツが取得できなくなった場合は以下をお試しください。</p><p><strong>0. エラー状況の確認</strong></p><p>Azure CDN を介して対象の URL において、ライアント (ユーザー) からコンテンツが取得できないエラーなどが発生した場合、<a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザのネットワーク トレース (F12) の機能</a> や curl を利用し、対象の URL の応答結果の確認をすることで、エラーの状況を確認することができます。</p><ul><li><p><strong>HTTP レスポンスが応答されない</strong> <br>クライアント (ユーザー) から Azure CDN までのネットワークにおいて DNS レイヤーや TCP レイヤーに障害などが発生し接続ができていない可能性があります。<br>Azure CDN はパブリック ネットワークから接続ができるため、異なるクライアント環境やネットワーク環境から接続が可能かをご確認ください。<br>特定のネットワークからのみ接続ができない場合、ネットワーク管理者にネットワーク状況などのご確認をご依頼ください。</p></li><li><p><strong>いずれかの HTTP レスポンスが応答される</strong> <br>Azure CDN か、Azure CDN と配信元 (オリジン) 間のネットワーク、または配信元 (オリジン) で障害などが発生している可能性があります。<br>次の手順で、Azure CDN と配信元 (オリジン) の被疑箇所を切り分けます。</p></li></ul><p><strong>1. 配信元の状況確認</strong> </p><p>配信元 (オリジン) のエンドポイント (URL) にアクセスし、想定されるコンテンツが取得できるかをご確認ください。<br>配信元 (オリジン) から想定されたコンテンツが取得できない場合、配信元 (オリジン) の障害などの影響により Azure CDN からコンテンツが応答できていない可能性があります。<br>配信元 (オリジン) から想定されたコンテンツが取得でき、Azure CDN からコンテンツが取得できない場合は、次の手順で被疑箇所を切り分けます。</p><p><strong>2. 配信元の証明書の状態を確認する</strong> </p><p>Azure CDN はクライアント (ユーザー) からプロトコルで配信元 (オリジン) に転送してコンテンツを取得します。<br>HTTPS 接続においては、Azure CDN や配信元 (オリジン) の HTTPS 接続のための SSL/TLS 証明書の有効期限切れなどによりエラーが発生する場合があります。<br>この場合、HTTP 接続で Azure CDN を介してコンテンツの取得が可能かをご確認ください。</p><p>TLS/SSL 証明書の状態については、以下の openssl コマンドを用いて確認することが可能です。<br>以下の openssl コマンドで証明書の有効期限切れなどが確認できた場合、証明書の状況をご確認ください。<br>証明書に問題がなく、引き続き Azure CDN からコンテンツが取得できない場合は、次の手順で改善されるかお試しください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Azure CDN へのTLS 接続確認]</span><br><span class="line">openssl s_client -connect &lt;Azure CDN のエンドポイント (xxx..azureedge.net)&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">[バックエンドへの TLS 接続確認]</span><br><span class="line">openssl s_client -connect &lt;バックエンドのパブリック IP アドレスや FQDN&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br></pre></td></tr></table></figure><p><strong>3. キャッシュ消去 (Purge)</strong> </p><p>Azure CDN 上でクライアント (ユーザー) からの要求 URL に対して意図しないコンテンツが CDN 上でキャッシュされて、エラーが応答されている可能性があります。<br>一度、キャッシュ消去 (Purge) を実施いただいた上で、クライアント (ユーザー) から Azure CDN に再接続し、エラー状況をご確認ください。</p><p><strong>4. 情報採取</strong></p><p>上記を実施いただき、事象が改善されない場合は、ご利用いただいている SKU に応じて情報取得をいただき、弊社サポート担当までお問い合わせください。</p><ul><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/#collect-information-standard-microsoft">Standard Microsoft においてエラー発生時にご提供いただきたい情報</a></li><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/#collect-information-standard-verizon-premium-verizon">Standard Verizon / Premium Verizon においてエラー発生時にご提供いただきたい情報</a></li><li><a href="https://jpaztech.github.io/blog/network/cdn-specific-sku/#collect-information-standard-akamai">Standard Akamai においてエラー発生時にご提供いただきたい情報</a></li></ul><br><p>本ブログが皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チーム箕輪です。&lt;/p&gt;
&lt;p&gt;Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。&lt;br&gt;Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しています。&lt;br&gt;本ブログは Azure CDN における共通的な事項をまとめたブログとなります。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
      <category term="Troubleshooting" scheme="https://jpaztech.github.io/blog/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>Azure CDN の各 SKU の特徴、トラブルシューティングの紹介</title>
    <link href="https://jpaztech.github.io/blog/network/cdn-specific-sku/"/>
    <id>https://jpaztech.github.io/blog/network/cdn-specific-sku/</id>
    <published>2020-07-15T00:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.494Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム箕輪です。</p><p>Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。<br>Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しております。<br>本ブログは Azure CDN で提供している 4 つの SKU の特徴や、各 SKU における情報採取手順などをまとめたブログとなります。</p><a id="more"></a> <p>Azure CDN における共通的な事項については、以下のブログでまとめておりますのでご参照ください。</p><ul><li><a href="https://jpaztech.github.io/blog/network/cdn-common/">Azure CDN の特徴やよくあるお問い合わせ、トラブル シューティングの紹介</a></li></ul><p>本ブログでは、Azure CDN の各 SKU の特徴についてご案内しております。</p><ul><li>Azure CDN における各 SKU の特徴</li><li>ルール エンジンの設定</li><li>エラー発生時の情報採取手順</li></ul><br><p><span id="feature-of-azure-cdn-sku"></span></p><h2 id="Azure-CDN-における各-SKU-の特徴"><a href="#Azure-CDN-における各-SKU-の特徴" class="headerlink" title="Azure CDN における各 SKU の特徴"></a><a href="#feature-of-azure-cdn-sku">Azure CDN における各 SKU の特徴</a></h2><p>Azure CDN における各 SKU の機能一覧については、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-features" target="_blank" rel="noopener">弊社公開情報</a> でご案内しております。<br>本ブログでは、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-features" target="_blank" rel="noopener">弊社公開情報</a> でご案内している内容をもとに、各 SKU の特徴について関連するドキュメントと紹介します。</p><br><p><span id="standard-microsoft"></span></p><h4 id="Standard-Microsoft"><a href="#Standard-Microsoft" class="headerlink" title="Standard Microsoft"></a><a href="#standard-microsoft">Standard Microsoft</a></h4><p>Standard Microsoft は、Microsoft のインフラストラクチャー上で構成された CDN プラットフォームを用いてサービスを提供しています。<br>Azure CDN の SKU としては最も新しく提供された SKU で、新規機能の追加などが随時行われております。<br>Azure CDN の中で、2020 年 7 月時点で唯一 WAF 機能を利用できる SKU となっており、配信元が Azure サービスであればデータ転送料の観点で他の SKU よりも優れています。<br>また、アクセス ログの取得の機能も実装されております。<br>動的コンテンツの最適化については <a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-overview" target="_blank" rel="noopener">Azure Front Door</a> で機能を提供しています。</p><ul><li>ルール エンジンによるカスタマイズ設定<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-reference</a></li><li>WAF 機能の追加 (プレビュー)<br><a href="https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview</a></li><li>アクセス ログの取得<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/enable-raw-logs" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/enable-raw-logs</a></li><li>独自証明書で指定の認証局 (CA) による制限<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-troubleshoot-allowed-ca" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-troubleshoot-allowed-ca</a></li><li>配信元 (オリジン) が Azure サービスの場合、配信元から CDN へのデータ転送が無料<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing#which-origin-services-are-eligible-for-free-data-transfer-with-azure-cdn-from-microsoft" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-billing#which-origin-services-are-eligible-for-free-data-transfer-with-azure-cdn-from-microsoft</a></li></ul><br><p><span id="standard-premium-verizon"></span></p><h4 id="Standard-Premium-Verizon"><a href="#Standard-Premium-Verizon" class="headerlink" title="Standard / Premium Verizon"></a><a href="#standard-premium-verizon">Standard / Premium Verizon</a></h4><p>Standard Verizon、Premium Verizon は Verizon Digital Media Services 社の CDN プラットフォームを用いて CDN サービスを提供しています。<br>Azure ポータルから Verizon のポータルに接続することで、CDN に関わるログをグラフ化して確認することができます。<br>Azure Media Service において、ストリーミング エンドポイントで CDN を用いた際に既定で選択される SKU であり、メディア ストリーミングの最適化に優れています。<br>Premium Verizon は他の SKU と価格が異なりますが、多機能のルール エンジンや詳細なレポートなどがご利用いただけます。</p><ul><li>任意の認証局 (CA) が発行した証明書を利用可能</li><li>キャッシュの事前読み込み機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-preload-endpoint" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-preload-endpoint</a></li><li>視覚化されたグラフ<br>(1) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-analyze-usage-patterns" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-analyze-usage-patterns</a><br>(2) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-custom-reports" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-custom-reports</a></li><li>メディア ストリーミングの最適化に優れている (Azure Media Service の既定の SKU)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-verizon" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-verizon</a></li><li>ルールエンジンによるカスタマイズ (Premium のみ)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference</a></li><li>詳細なレポート (Premium のみ)<br>(1) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-advanced-http-reports" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-advanced-http-reports</a><br>(2) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-stats" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-stats</a><br>(3) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-edge-performance" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-edge-performance</a><br>(4) <a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-alerts" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-real-time-alerts</a></li><li>トークン認証 (Premium のみ)<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-token-auth" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-token-auth</a></li></ul><br><p><span id="standard-akamai"></span></p><h4 id="Standard-Akamai"><a href="#Standard-Akamai" class="headerlink" title="Standard Akamai"></a><a href="#standard-akamai">Standard Akamai</a></h4><p>Standard Akamai は Akamai 社の CDN プラットフォームを用いて CDN サービスを提供しております。<br>Akamai 社は世界最大規模の CDN プラットフォームで CDN サービスを提供しており、動的なサイトの最適化に優れています。<br>なお、Akamai 社が提供している Akamai Control Center (旧 Luna Control Center) は Azure CDN ではご利用いただけません。</p><ul><li>キャッシュ消去 (Purge) や設定変更の反映が迅速</li><li>Let’s Encrypt を用いたカスタムドメインの HTTPS 有効化</li><li>動的なサイトの最適化機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-dynamic-site-acceleration" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-dynamic-site-acceleration</a></li><li>メディア ストリーミングの最適化機能<br><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-akamai" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/cdn/cdn-media-streaming-optimization#media-streaming-optimizations-for-azure-cdn-from-akamai</a></li></ul><br><p><span id="setting-of-rule-engine"></span></p><h2 id="ルール-エンジンの設定"><a href="#ルール-エンジンの設定" class="headerlink" title="ルール エンジンの設定"></a><a href="#setting-of-rule-engine">ルール エンジンの設定</a></h2><p>Azure CDN では 2020 年 7 月時点で Standard Microsoft と Premium Verizon でルール エンジンの機能を提供しています。<br>ルール エンジンは以下の項目においてカスタマイズが可能です。</p><ul><li>キャッシュ規則のカスタマイズ</li><li>クライアント (ユーザー) からの要求をリダイレクト</li><li>HTTP の要求ヘッダーや応答ヘッダーの変更</li><li>(Premium Verizon のみ) クライアント (ユーザー) からの要求を拒否 (403 で応答) する</li></ul><br><p><span id="setting-of-rule-engine-standard-microsoft"></span></p><h4 id="Standard-Microsoft-におけるルール-エンジンの設定"><a href="#Standard-Microsoft-におけるルール-エンジンの設定" class="headerlink" title="Standard Microsoft におけるルール エンジンの設定"></a><a href="#setting-of-rule-engine-standard-microsoft">Standard Microsoft におけるルール エンジンの設定</a></h4><p>Stnadard Microsoft のルール エンジンの設定は Azure ポータルから実施いただけます。<br>ルール エンジンの設定の考え方として、対象の通信を <strong>一致条件</strong> で指定し、対象の通信に対して実施したい <strong>アクション</strong> を設定することで動作します。<br>Standard Microsoft のルール エンジンの設定は、エンドポイント単位で管理、適応されております。</p><p>設定の一例として、Azure CDN はクライアント (ユーザー) から HTTP で接続された場合、配信元 (オリジン) に対して HTTP で接続します。<br>この通信経路をすべて HTTPS で暗号化されたいシナリオにおいて、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine" target="_blank" rel="noopener">ルール エンジンを利用した HTTPS リダイレクト</a> を設定することで、クライアント (ユーザー) から Azure CDN を介した通信経路がすべて HTTPS となります。<br>この設定においては、Azure CDN のエンドポイントで受け入れプロトコルを HTTP/HTTPS としていただく点と、カスタムドメインにおいては HTTPS 有効化を構成いただく必要がある点はご留意ください。</p><br><p><span id="troubleshooting-setting-of-rule-engine"></span></p><h4 id="Standard-Microsoft-におけるルール-エンジンの設定のトラブルシューティング"><a href="#Standard-Microsoft-におけるルール-エンジンの設定のトラブルシューティング" class="headerlink" title="Standard Microsoft におけるルール エンジンの設定のトラブルシューティング"></a><a href="#troubleshooting-setting-of-rule-engine">Standard Microsoft におけるルール エンジンの設定のトラブルシューティング</a></h4><p>設定を保存されたルール エンジンは、世界中の POP に適応するため、設定後の反映にはおおよそ 10 分ほど時間が掛かることが想定された動作となります。<br>そのため、設定後は少しお時間をあけてから設定の反映をご確認ください。<br>また、ルール エンジンの設定を反映する間に短時間で何度も設定を変更し保存した場合、設定情報が意図しない状態となる可能性があるため、設定を変更さえる場合はお時間を空けて実施ください。</p><p>設定後も意図した動作にならないなどご確認されたい事項がございましたら、以下の情報をもとに弊社サポート担当までお問い合わせください。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>ルール エンジンを設定したエンドポイント名</li><li>ルール エンジンの設定名</li><li>設定されたい要件の詳細</li></ul><br><p><span id="document-setting-of-rule-engine-standard-microsoft"></span></p><h4 id="Standard-Microsoft-のルール-エンジンに関する弊社公開情報"><a href="#Standard-Microsoft-のルール-エンジンに関する弊社公開情報" class="headerlink" title="Standard Microsoft のルール エンジンに関する弊社公開情報"></a><a href="#document-setting-of-rule-engine-standard-microsoft">Standard Microsoft のルール エンジンに関する弊社公開情報</a></h4><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-reference" target="_blank" rel="noopener">Azure CDN の Standard ルール エンジン リファレンス</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-match-conditions" target="_blank" rel="noopener">Azure CDN の Standard ルール エンジンの一致条件</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine-actions" target="_blank" rel="noopener">Azure CDN の Standard ルール エンジンでのアクション</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-standard-rules-engine" target="_blank" rel="noopener">Standard ルール エンジンの HTTPS リダイレクト設定</a></li></ul><br><p><span id="setting-of-rule-engine-premium-verizon"></span></p><h4 id="Premium-Verizon-におけるルール-エンジンの設定"><a href="#Premium-Verizon-におけるルール-エンジンの設定" class="headerlink" title="Premium Verizon におけるルール エンジンの設定"></a><a href="#setting-of-rule-engine-premium-verizon">Premium Verizon におけるルール エンジンの設定</a></h4><p>Premium Verizon のルール エンジンの設定は Azure ポータルからログインできる Verizon ポータルで実施いただけます。<br>概要としては、<a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference" target="_blank" rel="noopener">弊社公開情報</a> より確認いただけますが、ルール エンジンの設定の考え方として、対象の通信を <strong>一致条件</strong> で指定し、対象の通信に対して実施したい <strong>機能</strong> を設定することで動作します。<br>Premium Verizon のルール エンジンの設定は、プロファイル単位で管理されており、プロファイルのエンドポイントに対して設定を反映することができます。</p><p>Premium Verizon のルール エンジンは現在 v4 とよばれるバージョンで動作しており、ルール エンジンは <strong>ポリシー</strong> と呼ばれる単位で管理しています。<br><strong>ポリシー</strong> から新規でルール エンジンを設定いただくと <strong>Draft</strong> が構成されます。<br>設定された <strong>Draft</strong> から設定を適応される場合、<strong>Draft</strong> の <strong>Lock Draft as Policy</strong> を選択後、<strong>Deploy Request</strong> から <strong>Production</strong> を選択いただき、<strong>Create Deploy Request</strong> と進めていただければ、<strong>ポリシー</strong> で設定いただいたルール エンジンが適応されます。<br><strong>Create Deploy Request</strong> 後、ルール エンジンの設定は数分で完了いたしますが、実際の環境に適応されるまでは構成によりますが、少なくとも <strong>20 分</strong> はかかりますので、設定の反映を確認される場合はお時間を空けて動作をご確認ください。</p><br><p><span id="troubleshooting-setting-of-rule-engine-premium-verizon"></span></p><h4 id="Premium-Verizon-におけるルール-エンジンの設定のトラブルシューティング"><a href="#Premium-Verizon-におけるルール-エンジンの設定のトラブルシューティング" class="headerlink" title="Premium Verizon におけるルール エンジンの設定のトラブルシューティング"></a><a href="#troubleshooting-setting-of-rule-engine-premium-verizon">Premium Verizon におけるルール エンジンの設定のトラブルシューティング</a></h4><p>Premium Verizon のルール エンジンの設定においては、<strong>Lock Draft as Policy</strong> や <strong>Create Deploy Request</strong> において検証がされる動作となりますので、設定ができないパラメータなどがある場合は、設定時にエラー メッセージが表示される動作となります。<br><strong>Create Deploy Request</strong> を実施いただいた後も、エラー メッセージが表示されずに設定が完了し、お時間を空けてご確認いただいたにも関わらず想定された動作とならない場合、Verizon 社のエンジニアと設定状況について調査いたしますので、以下の情報をもとに弊社サポート担当までお問い合わせください。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>ルール エンジンを設定されたい CDN のエンドポイント名</li><li>ルール エンジン設定画面の右上に記載れた 5 桁の ID (Verizon Account ID)</li><li>設定されたルール エンジンの 画面キャプチャ</li><li>設定されたルール エンジンの XML 情報 (ルール エンジンの設定画面で確認いただけます)</li><li>設定されたい要件の詳細</li></ul><br><p><span id="document-setting-of-rule-engine-premium-verizon"></span></p><h4 id="Premium-Verizon-のルール-エンジンに関するドキュメント"><a href="#Premium-Verizon-のルール-エンジンに関するドキュメント" class="headerlink" title="Premium Verizon のルール エンジンに関するドキュメント"></a><a href="#document-setting-of-rule-engine-premium-verizon">Premium Verizon のルール エンジンに関するドキュメント</a></h4><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンのリファレンス</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference-conditional-expressions" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの条件式</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference-match-conditions" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの一致条件</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-verizon-premium-rules-engine-reference-features" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの機能</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/cdn/cdn-http-variables" target="_blank" rel="noopener">Azure CDN from Verizon Premium ルール エンジンの HTTP 変数</a></li></ul><br><p><span id="setting-of-waf"></span></p><h2 id="WAF-の設定"><a href="#WAF-の設定" class="headerlink" title="WAF の設定"></a><a href="#setting-of-waf">WAF の設定</a></h2><p>WAF の機能は 2020 年 7 月時点で Standard Microsoft においてプレビュー提供をしています。<br>WAF では OWASP のルール セットに準拠した Azure で管理されたルール セットの他に、カスタム規則でルールを設定することができます。<br>Standard Microsoft で構成されたエンドポイントに対して 1 つの WAF が関連付けできます。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview</a></p><p>2020 年 7月時点の動作として、WAF がエンドポイントに関連付けられた状態において、カスタム規則の変更は一部制限がかかる場合があります。<br>WAF のカスタム規則において意図した設定が追加できない場合は、一度エンドポイントとの関連付けを解除した上で設定の変更をお試しください。</p><br><p><span id="collect-information"></span></p><h2 id="エラー発生時の情報採取手順"><a href="#エラー発生時の情報採取手順" class="headerlink" title="エラー発生時の情報採取手順"></a><a href="#collect-information">エラー発生時の情報採取手順</a></h2><p>Azure CDN では Microsoft 以外に Verizon 社と Akamai 社の CDN プラットフォームで CDN サービスを提供していることから、事象に応じて各社と連携して調査を実施する必要があります。<br>SKU によって情報採取の手順が一部異なりますので、弊社サポート担当にお問い合わせいただく際に以下をご確認いただき、情報採取にご協力いただければ幸いです。</p><br><p><span id="collect-information-standard-microsoft"></span></p><h4 id="Standard-Microsoft-においてエラー発生時にご提供いただきたい情報"><a href="#Standard-Microsoft-においてエラー発生時にご提供いただきたい情報" class="headerlink" title="Standard Microsoft においてエラー発生時にご提供いただきたい情報"></a><a href="#collect-information-standard-microsoft">Standard Microsoft においてエラー発生時にご提供いただきたい情報</a></h4><p>Standard Microsoft では、CDN を介した通信における HTTP ヘッダの <strong>x-azure-ref</strong> が、サポート担当が Azure 基盤のログを確認するために必要な情報となります。<br>情報採取の際は以下の情報に加えて、事象が発生した際の HTTP ヘッダの <strong>x-azure-ref</strong> を取得いただき、お問合せ時にご共有いただけますと幸いです。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>Azure CDN のエンドポイント名</li><li>事象が発生している URL (FQDN) </li><li>事象の概要</li><li>HTTP ヘッダの x-azure-ref の結果 (画像ではなくテキスト ベースでご共有願います)</li></ul><p>HTTP ヘッダの <strong>x-azure-ref</strong> は以下の方法でご確認いただけます。</p><ol><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザにおけるネットワーク トレース (F12)</a> で確認する</li><li>curl コマンドで確認する。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -I  https://www.contoso.com/path/pic.png</span><br><span class="line"></span><br><span class="line">(https://www.contoso.com/path/pic.png の箇所は CDN にアクセスする際の URL に変えて実施ください)</span><br></pre></td></tr></table></figure><br><p><span id="collect-information-standard-verizon-premium-verizon"></span></p><h4 id="Standard-Verizon-Premium-Verizon-においてエラー発生時にご提供いただきたい情報"><a href="#Standard-Verizon-Premium-Verizon-においてエラー発生時にご提供いただきたい情報" class="headerlink" title="Standard Verizon / Premium Verizon においてエラー発生時にご提供いただきたい情報"></a><a href="#collect-information-standard-verizon-premium-verizon">Standard Verizon / Premium Verizon においてエラー発生時にご提供いただきたい情報</a></h4><p>Standard Verizon、Premium Verizon は Verizon 社の CDN プラットフォームでサービスを提供しているため、調査は Verizon 社のエンジニアと共同で実施いたします。<br>Verizon 社のエンジニアとスムーズに連携して調査をするため、情報採取の際は以下の情報をお問合せ時にご共有いただけますと幸いです。</p><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>Azure CDN のエンドポイント名</li><li>事象が発生している URL (FQDN) </li><li>事象の概要</li><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace" target="_blank" rel="noopener">Web プラウザにおけるネットワーク トレース (F12) の結果</a></li></ul><br><p><span id="collect-information-standard-akamai"></span></p><h4 id="Standard-Akamai-においてエラー発生時にご提供いただきたい情報"><a href="#Standard-Akamai-においてエラー発生時にご提供いただきたい情報" class="headerlink" title="Standard Akamai においてエラー発生時にご提供いただきたい情報"></a><a href="#collect-information-standard-akamai">Standard Akamai においてエラー発生時にご提供いただきたい情報</a></h4><p>Standard Akamai は Akamai 社の CDN プラットフォームでサービスを提供しているため、調査は Akamai 社のエンジニアと共同で実施いたします。<br>Standard Akamai では、CDN からエラーメッセージを応答された場合に、画面上に <strong>Reference</strong> と呼ばれるエラー コードが記載されます。<br>この  <strong>Reference</strong>  のエラー コードを元に調査することが可能となりますので、お問合せ時にご共有いただけますと幸いです。</p><p><img src="/blog/network/cdn-specific-sku/reference-error-code.png" alt="参考 : Reference のエラー コード">  </p><p>また、Standard Akamai では Web プラウザにおけるネットワーク トレース (F12) では十分な情報が取得できない場合があります。<br>そのため、Akamai 社のエンジニアとスムーズに連携して調査をするため、情報採取の際は以下の情報に加えて、以下の curl コマンドの実行結果をお問合せ時にご共有いただけますと幸いです。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -H \</span><br><span class="line"> <span class="string">"Pragma: akamai-x-cache-on, akamai-x-cache-remote-on, akamai-x-check-cacheable, akamai-x-get-cache-key, akamai-x-get-extracted-values, akamai-x-get-nonces, akamai-x-get-ssl-client-session-id, akamai-x-get-true-cache-key, akamai-x-serial-no"</span> \</span><br><span class="line"> -IXGET https://www.contoso.com/path/pic.png</span><br><span class="line"> </span><br><span class="line">(https://www.contoso.com/path/pic.png の箇所は CDN にアクセスする際の URL に変えて実施ください)</span><br></pre></td></tr></table></figure><p><strong>[ご提供いただきたい情報]</strong></p><ul><li>Azure CDN が構成されている 32 桁の サブスクリプションID</li><li>Azure CDN のプロファイル名</li><li>Azure CDN のエンドポイント名</li><li>事象が発生している URL (FQDN) </li><li>事象の概要</li><li>Reference のエラー コード(画像ではなくテキスト ベースでご共有願います)</li><li>以下の curl コマンドの実行結果</li></ul><br><p>本ブログが皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チーム箕輪です。&lt;/p&gt;
&lt;p&gt;Azure が提供している CDN サービスの Azure CDN において、ご利用いただける機能やよくあるお問合せ、各 SKU の特徴などを踏まえたトラブル シューティングの手順などをご紹介いたします。&lt;br&gt;Azure CDN は現在 4 つの SKU があり、3 社の CDN プロバイダー (Microsoft / Verizon / Akamai) で CDN サービスを提供しております。&lt;br&gt;本ブログは Azure CDN で提供している 4 つの SKU の特徴や、各 SKU における情報採取手順などをまとめたブログとなります。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="AzureCDN" scheme="https://jpaztech.github.io/blog/tags/AzureCDN/"/>
    
      <category term="Troubleshooting" scheme="https://jpaztech.github.io/blog/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>Windows ゲスト エージェント (WinGA) の再インストール方法</title>
    <link href="https://jpaztech.github.io/blog/vm/re-install-windows-azure-guest-agent/"/>
    <id>https://jpaztech.github.io/blog/vm/re-install-windows-azure-guest-agent/</id>
    <published>2020-06-26T08:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.518Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。</p><p>お問い合わせでご案内する頻度が多い、Windows ゲスト エージェント (WinGA) の再インストール方法をご案内いたします。<br>WinGAが正常に動作しなくなった場合に再インストールを行うことで正常動作に戻ることが多くあります。</p><p>今回は下記画像の3つのサービスを一旦削除し、インストールを行うシナリオとなります。</p><p><img src="/blog/vm/re-install-windows-azure-guest-agent/service.png" alt=""> </p><h2 id="再インストール方法"><a href="#再インストール方法" class="headerlink" title="再インストール方法"></a>再インストール方法</h2><ol><li><p>現在のWinGAをアンインストールします。<br> スタートを右クリックして、「Apps and Features」を選択します。<br> 下記のように「Windows Azure VM Agent」がインストールされている場合は「Uninstall」を選択してください。</p><p> <img src="/blog/vm/re-install-windows-azure-guest-agent/app-and-features.png" alt=""> </p><p> WinGAが最初からインストールされているイメージを使用した際は、「Windows Azure VM Agent」の表示はありませんのでこの操作は不要です。</p></li><li><p>管理者権限でコマンドプロンプトを起動します。</p></li><li><p>下記のコマンドでサービスを停止します。既に停止している場合は不要です。</p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> stop rdagent</span><br><span class="line"><span class="built_in">net</span> stop WindowsAzureGuestAgent</span><br><span class="line"><span class="built_in">net</span> stop WindowsAzureTelemetryService</span><br></pre></td></tr></table></figure></li><li><p>下記コマンドでサービスの削除を行います。</p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sc delete rdagent</span><br><span class="line">sc delete WindowsAzureGuestAgent</span><br><span class="line">sc delete WindowsAzureTelemetryService</span><br></pre></td></tr></table></figure></li><li><p>インストール前に不要ファイルの移動を行います。<br> “C:\WindowsAzure” 内に “OLD” というフォルダを作成します。<br> “C:\WindowsAzure” 内に “Packages” または “GuestAgent” というフォルダがあった場合は、作成した “OLD” フォルダに移動させてください。</p></li><li><p>下記リンクより最新のインストーラーをダウンロードします。<br> <a href="https://go.microsoft.com/fwlink/?LinkID=394789" target="_blank" rel="noopener">https://go.microsoft.com/fwlink/?LinkID=394789</a></p></li><li><p>ダウンロードしたインストーラーを “C:\VMAgentMSI” に配置します。</p></li><li><p>下記コマンドでインストールを実行します。<br> &lt;Version&gt;はインストーラーのファイル名のバージョンに合わせて書き換えて実行してください。  </p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec.exe /i c:\VMAgentMSI\WindowsAzureVmAgent.<span class="number">2</span>.<span class="number">7</span>.&lt;version&gt;.fre.msi /quiet /L*v c:\VMAgentMSI\msiexec.log</span><br></pre></td></tr></table></figure></li><li><p>これにてWinGAの再インストールは完了となります。<br> なお、サービスが起動するまでに1,2分程度かかる場合があります。<br> インストールが失敗した場合は “C:\VMAgentMSI\msiexec.log” の内容を参照してください。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;/p&gt;
&lt;p&gt;お問い合わせでご案内する頻度が多い、Windows ゲスト エージェント (WinGA) の再インストール方法をご案内いたします。&lt;br&gt;WinGAが正常に動作しなくなった場合に再インストールを
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>データ ディスクのドライブ文字が変わる</title>
    <link href="https://jpaztech.github.io/blog/vm/drive-letter-changed-1/"/>
    <id>https://jpaztech.github.io/blog/vm/drive-letter-changed-1/</id>
    <published>2020-06-25T08:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.502Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>オンプレミス環境の Hyper-V Guest を Azure 環境に移行した際や、Azure Windows VM を一般化 (sysprep) したイメージから複製 VM を作成したところ、割り当てられていたドライブ文字が以前の状態と変わったしまった、というお問い合わせをいただくことがありましたので、検証結果を交えてご説明させていただきます。</p><a id="more"></a><p>なお、移行手順に関しては下記ドキュメントに詳説されておりますので、こちらをご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image" target="_blank" rel="noopener">Azure にアップロードする Windows VHD または VHDX を準備する</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/upload-generalized-managed" target="_blank" rel="noopener">汎用化した VHD をアップロードして Azure で新しい VM を作成する</a></li></ul><hr><h2 id="■-ドライブ文字を割り当ての仕組み"><a href="#■-ドライブ文字を割り当ての仕組み" class="headerlink" title="■ ドライブ文字を割り当ての仕組み"></a>■ ドライブ文字を割り当ての仕組み</h2><p>※ ダイナミック ディスク構成による複数ディスクにまたがるボリュームにつきましては、レガシーな機能であり、Windows では非推奨となっておりますため、本稿ではベーシック ディスクについて説明しています。</p><p>はじめに、Windows によるドライブ文字の割り当ては、すべてレジストリキー <strong>HKLM¥SYSTEM¥MountedDevices</strong> に格納されます。<br>このレジストリ キーには、¥??¥Volume{GUID} という名前の値 (ボリューム名のエントリ) と、¥DosDevices¥C: のような名前の値があり、格納されるデータは、ディスク シグネチャとそのボリュームに関連する最初のパーティションの開始オフセットです。<br>どのディスクのどこから始まるパーティションのドライブ、という情報に対して、ドライブ文字が紐づけられているイメージになります。</p><p><img src="/blog/vm/drive-letter-changed-1/registry.png" alt=""></p><p>ドライブ文字の割り当てはマウント マネージャー (mountmgr.sys) が行っています。<br>マウント マネージャーが新しいボリュームに関する通知を受け取ると、新しいボリュームの GUID やディスク シグネチャを特定し、その情報をもとに MountedDevices レジストリ キーの内容が反映されている内部データベースを調べて、ドライブ文字の割り当てが含まれているかどうかを確認します。<br>このデータベースに新しいボリュームのエントリがない場合、マウント マネージャーは最初の未割り当てドライブ文字を採用して新規割り当てを定義し、それをデータベースに格納します。利用できるドライブ文字がない場合、ドライブ文字の割り当ては行われません。</p><hr><h2 id="■-いつドライブ文字が変わるのか"><a href="#■-いつドライブ文字が変わるのか" class="headerlink" title="■ いつドライブ文字が変わるのか"></a>■ いつドライブ文字が変わるのか</h2><h3 id="□-検証-1-Azure-Windows-VM-を-sysprep-し、複製-VM-を作成した場合"><a href="#□-検証-1-Azure-Windows-VM-を-sysprep-し、複製-VM-を作成した場合" class="headerlink" title="□ 検証 1: Azure Windows VM を sysprep し、複製 VM を作成した場合"></a>□ 検証 1: Azure Windows VM を sysprep し、複製 VM を作成した場合</h3><p><strong>&lt;検証概要&gt;</strong></p><p>本検証は、ドライブ文字の情報が sysprep の影響を受けることを確認した検証となります。<br>上述の通り、ドライブ文字の情報は <strong>HKLM¥SYSTEM¥MountedDevices</strong> に格納されていますので、sysprep 前後のレジストリの値を確認します。</p><p>具体的な手順は下記の通りです。</p><ol><li>[Azure Portal] Azure Windows VM にデータ ディスク 3 本をアタッチする</li><li>[ゲスト OS] VM に RDP 接続し、データ ディスクそれぞれに H、I、J ドライブを作成する</li><li>[ゲスト OS] 作成した VM に RDP 接続し、レジストリ値を確認する</li><li>[ゲスト OS] sysprep を実行して一般化を行う</li><li>[Azure Portal] 当該 VM の画面にて “キャプチャ” をクリックし、イメージ リソースを作成する</li><li>[Azure Portal] 作成したイメージ リソースから VM を作成する</li><li>[ゲスト OS] 作成した VM に RDP 接続し、レジストリ値を確認する</li></ol><p>手順につきましては、下記ドキュメントに詳説されておりますので、こちらをご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource" target="_blank" rel="noopener">Azure で一般化された VM の管理対象イメージを作成する</a></li></ul><p><strong>&lt;検証結果&gt;</strong><br>検証の結果、sysprep を実施すると今までのドライブ文字の情報は考慮されず、ディスクを読み込んだ順に新たにドライブ文字を割り当てることが確認できました。</p><p>レジストリに格納されている名前に対するデータ (ディスク シグネチャとパーティションの開始オフセット) より、sysprep 実施前後で同一のディスクがアタッチされていると OS には認識されておりますが、ドライブ文字との紐付け情報は残っていないことが確認できます。</p><p><strong>sysprep 実施前:</strong><br><img src="/blog/vm/drive-letter-changed-1/diskmanager-2.png" alt=""><br><img src="/blog/vm/drive-letter-changed-1/registry-2.png" alt=""></p><p><strong>sysprep 実施後再作成した VM にて:</strong><br>ドライブ先頭に付けた文字と実際に割り当てられた文字が違うことが確認いただけます。<br><img src="/blog/vm/drive-letter-changed-1/diskmanager-2aft.png" alt=""><br><img src="/blog/vm/drive-letter-changed-1/registry-2aft.png" alt=""></p><p><strong>&lt;まとめ&gt;</strong><br>そのため、Azure Windows VM のイメージから VM を作成する際には、必要に応じてドライブ文字の再設定をご実施ください。</p><h3 id="□-検証-2-オンプレミス環境の-Hyper-V-Guest-から-Azure-環境への移行した場合"><a href="#□-検証-2-オンプレミス環境の-Hyper-V-Guest-から-Azure-環境への移行した場合" class="headerlink" title="□ 検証 2: オンプレミス環境の Hyper-V Guest から Azure 環境への移行した場合"></a>□ 検証 2: オンプレミス環境の Hyper-V Guest から Azure 環境への移行した場合</h3><p><strong>&lt;検証概要&gt;</strong></p><p>本検証は、一般化を行なっていないオンプレミス環境の Hyper-V Guest　から Azure 環境への移行を実施した際に、ドライブ文字が変わるのかを確認します。</p><p>すべての Azure 仮想マシンでは、ページング ファイルやスワップ ファイルなどのデータのみを格納するための一時的なストレージ (一時ディスク) が割り当てされます。<br>Azure MarketPlace イメージをご利用の場合、一時ディスクは規定で D ドライブとなり、ページング ファイルはこの一時ディスクに設定されます。すでにデータ ディスクのドライブに D が使用されている場合には、一時ディスクのドライブ文字は D ドライブにはなりません。そのため、すでに D ドライブが設定されているオンプレミス環境を用意して確認を行います。</p><p>具体的な手順は下記の通りです。</p><ol><li>[Hyper-V Guest] システム ドライブ以外にディスクを 3 本アタッチし、D、E、F ドライブを作成する</li><li>[Hyper-V Guest] Azure に vhd ファイルをアプロードするための準備を行う (<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image" target="_blank" rel="noopener">手順</a>)</li><li>[Hyper-V Host] vhd ファイルを Azure ストレージ アカウントにアップロードする</li><li>[Azure Portal] vhd ファイルから管理ディスクを作成する</li><li>[Azure Portal] 作成した管理ディスクから VM を作成する</li><li>[ゲスト OS] 作成した VM に RDP 接続し、レジストリ値を確認する</li></ol><p><strong>&lt;検証結果&gt;</strong><br>検証の結果、Azure 環境にオンプレミス環境の VHD ファイルをアップロードして作成した仮想マシンでは、D、E、F ドライブは変わらず、移行前後で同一のディスクがアタッチされていると OS には認識されております。<br>Azure の一時ディスクについては、C 以降で使用済みのアルファベットを除いてもっとも若いアルファベットである G が割り当てられていることを確認いたしました。</p><p><strong>移行前:</strong><br><img src="/blog/vm/drive-letter-changed-1/registry-1.png" alt=""><br><strong>移行後:</strong><br><img src="/blog/vm/drive-letter-changed-1/registry-1aft.png" alt=""></p><hr><h2 id="■-まとめ"><a href="#■-まとめ" class="headerlink" title="■ まとめ"></a>■ まとめ</h2><p>上記検証と Windows の動作より、ボリュームに割り当てられたドライブ文字が変更されてしまうには、下記の 2 つのパターンが存在すると言えます。</p><blockquote><ul><li>sysprep を行い VM を一般化して、レジストリに該当ボリュームの情報がない場合</li><li>ディスクの情報が異なり、レジストリに該当ボリュームの情報がない場合</li></ul></blockquote><p>そのため、イメージから VM を作成いただいた後には改めてドライブ文字の設定をご検討ください。<br>また、意図せずドライブ文字が変更された場合には、ディスク自体の情報が変更されているか、レジストリに情報がないことが想定されますので、<strong>どんな操作を行った時にドライブ文字が変更されたか</strong>、<strong>ディスクは同一ディスクとして認識されているか</strong> をご確認ください。</p><p>本稿が皆様のお役に立てれば幸いです。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;オンプレミス環境の Hyper-V Guest を Azure 環境に移行した際や、Azure Windows VM を一般化 (sysprep) したイメージから複製 VM を作成したところ、割り当てられていたドライブ文字が以前の状態と変わったしまった、というお問い合わせをいただくことがありましたので、検証結果を交えてご説明させていただきます。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Drive Letter" scheme="https://jpaztech.github.io/blog/tags/Drive-Letter/"/>
    
  </entry>
  
  <entry>
    <title>Azure Linux VM の OS ディスク拡張方法</title>
    <link href="https://jpaztech.github.io/blog/vm/linux-expand-os-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/linux-expand-os-disk/</id>
    <published>2020-06-19T08:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.518Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの青山です。</p><p>Azure Marketplace のイメージからデプロイしたほとんどの Linux VM は、OS ディスクサイズが 30GB となります。VM の用途次第では、このサイズでは <code>/</code> 領域が不足することがあります。<br>そこで今回は OS ディスクの拡張方法、および、パーティション、ファイルシステムの拡張方法についてご案内します。</p><p>なお、データディスクの拡張については下記公式ドキュメントに詳細手順がありますので、こちらを参考にしてください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/expand-disks" target="_blank" rel="noopener">Azure CLI を使用して Linux VM の仮想ハード ディスクを拡張する</a></li></ul><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>作業前には必ず <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/tutorial-backup-vms" target="_blank" rel="noopener">バックアップ</a> を取得しておきましょう。</p><h2 id="Azure-ディスクの拡張"><a href="#Azure-ディスクの拡張" class="headerlink" title="Azure ディスクの拡張"></a>Azure ディスクの拡張</h2><p><a href="https://docs.microsoft.com/ja-jp/cli/azure/install-azure-cli?view=azure-cli-latest" target="_blank" rel="noopener">Azure CLI</a> で <code>az login</code> が完了していることを前提とします。<br>CLI をインストールしていない場合は、<a href="https://docs.microsoft.com/ja-jp/azure/cloud-shell/quickstart" target="_blank" rel="noopener">Azure Cloud Shell の Bash</a> を使うと便利です。</p><ol><li>環境に合わせて変数を設定します。<code>myResourceGroup</code> には VM のリソースグループ名、<code>myVmName</code> には VM のリソース名、<code>myOsDiskSize</code> には拡張後の OS ディスクサイズを指定しましょう。以下の例では 100GB に拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myResourceGroup=<span class="string">"contosogroup"</span></span><br><span class="line">myVmName=<span class="string">"contosovm"</span></span><br><span class="line">myOsDiskSize=<span class="string">"100"</span></span><br></pre></td></tr></table></figure></li><li>VM 実行中は接続されたディスクのサイズを変更できません。一度 VM を停止(割り当て解除)します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm deallocate --resource-group <span class="variable">$myResourceGroup</span> --name <span class="variable">$myVmName</span></span><br></pre></td></tr></table></figure></li><li>ディスクサイズを変更します。管理ディスクの場合は、<code>az disk update</code> でサイズ変更します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">osdiskid=$(az vm show --resource-group <span class="variable">$myResourceGroup</span> --name <span class="variable">$myVmName</span> --query storageProfile.osDisk.managedDisk.id -o tsv)</span><br><span class="line">az disk update --ids <span class="variable">$osdiskid</span> --size-gb <span class="variable">$myOsDiskSize</span></span><br></pre></td></tr></table></figure>非管理ディスクの場合は、<code>az vm update</code> でサイズ変更します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm update -n <span class="variable">$myVmName</span> -g <span class="variable">$myResourceGroup</span> --<span class="built_in">set</span> StorageProfile.OSDisk.DiskSizeGB=<span class="variable">$myOsDiskSize</span></span><br></pre></td></tr></table></figure></li><li>VM を起動します。Azure CLI での操作はここまでとなります。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm start --resource-group <span class="variable">$myResourceGroup</span> --name <span class="variable">$myVmName</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="ファイルシステムの拡張"><a href="#ファイルシステムの拡張" class="headerlink" title="ファイルシステムの拡張"></a>ファイルシステムの拡張</h2><p>Ubuntu など、cloud-init が予め有効なシステムでは、起動時に拡張が済んでいる場合があります。<br>ここでは、LVM 構成ではない RHEL7.6 でのコマンド例を紹介します。LVM 構成の場合は <a href="#ファイルシステムの拡張-LVM">ファイルシステムの拡張 (LVM)</a> を参照してください。</p><ol><li>VM に SSH 接続します。</li><li><code>lsblk</code> コマンドで拡張するパーティションを確認します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -p -o NAME,FSTYPE,SIZE,MOUNTPOINT</span><br></pre></td></tr></table></figure>以下の出力例では、<code>/</code> は <code>/dev/sda2</code> に 31.5G の xfs として作成されていることが確認できます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME        FSTYPE  SIZE MOUNTPOINT</span><br><span class="line">&#x2F;dev&#x2F;fd0              4K</span><br><span class="line">&#x2F;dev&#x2F;sda            100G</span><br><span class="line">|-&#x2F;dev&#x2F;sda1 xfs     500M &#x2F;boot</span><br><span class="line">&#96;-&#x2F;dev&#x2F;sda2 xfs    31.5G &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sdb              7G</span><br><span class="line">&#96;-&#x2F;dev&#x2F;sdb1 ext4      7G &#x2F;mnt&#x2F;resource</span><br></pre></td></tr></table></figure></li><li><code>yum</code> コマンドで、<code>cloud-utils-growpart</code> パッケージをインストールします。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y cloud-utils-growpart</span><br></pre></td></tr></table></figure></li><li><code>growpart</code> コマンドでパーティションを拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo growpart /dev/sda 2</span><br></pre></td></tr></table></figure></li><li>再度 <code>lsblk</code> コマンドを使い、<code>/dev/sda2</code> が拡張されたかを確認してみましょう。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -p /dev/sda2</span><br></pre></td></tr></table></figure>以下の出力例では、99.5G に拡張されたことが確認できます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">&#x2F;dev&#x2F;sda2   8:2    0 99.5G  0 part &#x2F;</span><br></pre></td></tr></table></figure></li><li>ファイルシステムを拡張します。xfs の場合は、<code>xfs_growfs</code>, ext4 の場合は、<code>resize2fs</code> コマンドを使います。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xfs_growfs /</span><br></pre></td></tr></table></figure>拡張されました。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meta-data&#x3D;&#x2F;dev&#x2F;sda2              isize&#x3D;512    agcount&#x3D;4, agsize&#x3D;2065088 blks</span><br><span class="line">         &#x3D;                       sectsz&#x3D;512   attr&#x3D;2, projid32bit&#x3D;1</span><br><span class="line">         &#x3D;                       crc&#x3D;1        finobt&#x3D;0 spinodes&#x3D;0</span><br><span class="line">data     &#x3D;                       bsize&#x3D;4096   blocks&#x3D;8260352, imaxpct&#x3D;25</span><br><span class="line">         &#x3D;                       sunit&#x3D;0      swidth&#x3D;0 blks</span><br><span class="line">naming   &#x3D;version 2              bsize&#x3D;4096   ascii-ci&#x3D;0 ftype&#x3D;1</span><br><span class="line">log      &#x3D;internal               bsize&#x3D;4096   blocks&#x3D;4033, version&#x3D;2</span><br><span class="line">         &#x3D;                       sectsz&#x3D;512   sunit&#x3D;0 blks, lazy-count&#x3D;1</span><br><span class="line">realtime &#x3D;none                   extsz&#x3D;4096   blocks&#x3D;0, rtextents&#x3D;0</span><br><span class="line">data blocks changed from 8260352 to 26086139</span><br></pre></td></tr></table></figure></li><li>最後に、<code>df</code> コマンドで <code>/</code> のサイズを確認してみましょう。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -hT /</span><br></pre></td></tr></table></figure>目的のサイズになっていれば無事成功です。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem     Type  Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;sda2      xfs   100G  2.8G   97G   3% &#x2F;</span><br></pre></td></tr></table></figure></li></ol><h2 id="ファイルシステムの拡張-LVM"><a href="#ファイルシステムの拡張-LVM" class="headerlink" title="ファイルシステムの拡張 (LVM)"></a>ファイルシステムの拡張 (LVM)</h2><p>ここでは、LVM 構成の RHEL8.2 でのコマンド例を紹介します。</p><ol><li>VM に SSH 接続します。</li><li><code>lsblk</code> コマンドで拡張するパーティションを確認します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -p -o NAME,FSTYPE,SIZE,MOUNTPOINT</span><br></pre></td></tr></table></figure>以下の出力例では、<code>/</code> としてマウントされている LV <code>rootlv</code> は <code>/dev/sda2</code> に作成されていることが確認できます。<br>ファイルシステムは xfs として作成されています。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                          FSTYPE       SIZE MOUNTPOINT</span><br><span class="line">&#x2F;dev&#x2F;sda                                   100G</span><br><span class="line">├─&#x2F;dev&#x2F;sda1                   xfs          500M &#x2F;boot</span><br><span class="line">├─&#x2F;dev&#x2F;sda2                   LVM2_member   63G</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-tmplv  xfs            2G &#x2F;tmp</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-usrlv  xfs           10G &#x2F;usr</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-homelv xfs            1G &#x2F;home</span><br><span class="line">│ ├─&#x2F;dev&#x2F;mapper&#x2F;rootvg-varlv  xfs            8G &#x2F;var</span><br><span class="line">│ └─&#x2F;dev&#x2F;mapper&#x2F;rootvg-rootlv xfs            2G &#x2F;</span><br><span class="line">├─&#x2F;dev&#x2F;sda14                                 4M</span><br><span class="line">└─&#x2F;dev&#x2F;sda15                  vfat         495M &#x2F;boot&#x2F;efi</span><br><span class="line">&#x2F;dev&#x2F;sdb                                     7G</span><br><span class="line">└─&#x2F;dev&#x2F;sdb1                   ext4           7G &#x2F;mnt</span><br></pre></td></tr></table></figure></li><li><code>yum</code> コマンドで、<code>cloud-utils-growpart</code> パッケージをインストールします。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y cloud-utils-growpart</span><br></pre></td></tr></table></figure></li><li><code>growpart</code> コマンドでパーティションを拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo growpart /dev/sda 2</span><br></pre></td></tr></table></figure></li><li><code>pvresize</code> コマンドで、PV を拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pvresize /dev/sda2</span><br></pre></td></tr></table></figure>成功すると、以下のような出力が得られます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Physical volume &quot;&#x2F;dev&#x2F;sda2&quot; changed</span><br><span class="line">1 physical volume(s) resized or updated &#x2F; 0 physical volume(s) not resized</span><br></pre></td></tr></table></figure></li><li><code>vgs</code> コマンドで <code>rootlv</code> の含まれている <code>rootvg</code> の領域が増えたか確認してみます。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vgs</span><br></pre></td></tr></table></figure>以下の出力例では 76.02 GB が使用可能です。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VG     #PV #LV #SN Attr   VSize   VFree</span><br><span class="line">rootvg   1   5   0 wz--n- &lt;99.02g &lt;76.02g</span><br></pre></td></tr></table></figure></li><li><code>lvextend</code> コマンドで、LV を拡張します。<br>今回は、空き容量を全て使って <code>rootlv</code> を拡張します。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lvextend -l +100%FREE /dev/rootvg/rootlv</span><br></pre></td></tr></table></figure>成功すると、以下のような出力が得られます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Size of logical volume rootvg&#x2F;rootlv changed from 2.00 GiB (512 extents) to &lt;78.02 GiB (19973 extents).</span><br><span class="line">Logical volume rootvg&#x2F;rootlv successfully resized.</span><br></pre></td></tr></table></figure></li><li>ファイルシステムを拡張します。xfs の場合は、xfs_growfs, ext4 の場合は、resize2fs コマンドを使います。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xfs_growfs /</span><br></pre></td></tr></table></figure>成功すると、以下のような出力が得られます。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meta-data&#x3D;&#x2F;dev&#x2F;mapper&#x2F;rootvg-rootlv isize&#x3D;512    agcount&#x3D;4, agsize&#x3D;131072 blks</span><br><span class="line">         &#x3D;                       sectsz&#x3D;4096  attr&#x3D;2, projid32bit&#x3D;1</span><br><span class="line">         &#x3D;                       crc&#x3D;1        finobt&#x3D;1, sparse&#x3D;1, rmapbt&#x3D;0</span><br><span class="line">         &#x3D;                       reflink&#x3D;1</span><br><span class="line">data     &#x3D;                       bsize&#x3D;4096   blocks&#x3D;524288, imaxpct&#x3D;25</span><br><span class="line">         &#x3D;                       sunit&#x3D;0      swidth&#x3D;0 blks</span><br><span class="line">naming   &#x3D;version 2              bsize&#x3D;4096   ascii-ci&#x3D;0, ftype&#x3D;1</span><br><span class="line">log      &#x3D;internal log           bsize&#x3D;4096   blocks&#x3D;2560, version&#x3D;2</span><br><span class="line">         &#x3D;                       sectsz&#x3D;4096  sunit&#x3D;1 blks, lazy-count&#x3D;1</span><br><span class="line">realtime &#x3D;none                   extsz&#x3D;4096   blocks&#x3D;0, rtextents&#x3D;0</span><br><span class="line">data blocks changed from 524288 to 20452352</span><br></pre></td></tr></table></figure></li><li>最後に、df コマンドで / のサイズを確認してみましょう。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -hT /</span><br></pre></td></tr></table></figure>目的のサイズになっていれば無事成功です。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem                Type  Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;rootvg-rootlv xfs    79G  625M   78G   1% &#x2F;</span><br></pre></td></tr></table></figure></li></ol><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの青山です。&lt;/p&gt;
&lt;p&gt;Azure Marketplace のイメージからデプロイしたほとんどの Linux VM は、OS ディスクサイズが 30GB となります。VM の用途次第では、このサイズでは &lt;code&gt;/
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
      <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure Load Balancer のトラブルシューティング: スコーピング編</title>
    <link href="https://jpaztech.github.io/blog/network/tsg-azure-load-balancer-scoping/"/>
    <id>https://jpaztech.github.io/blog/network/tsg-azure-load-balancer-scoping/</id>
    <published>2020-06-17T01:00:00.000Z</published>
    <updated>2020-11-30T09:42:06.498Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure Load Balancer (ALB) はワークロードを複数の Azure VM / VMSS に負荷分散するサービスで、最も利用されている Azure サービスの一つです。利用数が多い分、ALB を経由するエンドノード間の通信に問題が生じたといったトラブルもよくお問い合わせいただきます。そこで、そうしたトラブルにおいて、ALB の観点で原因箇所を切り分けるスコーピングの方法についてご紹介したいと思います。</p><a id="more"></a><h2 id="要約"><a href="#要約" class="headerlink" title="要約"></a>要約</h2><ul><li>トランスポート層 (L4) レベルで接続性が確保できていれば Auzre Load Balancer として問題はありません。</li><li>例えば TCP の負荷分散規則であれば <code>nc</code>、<code>telnet</code>、<code>PsPing</code>、<code>Test-NetConnection</code> 等で TCP コネクションが確立出来るかみれば十分です。</li><li>L4 の接続性が確認できない場合は、Azure Load Balancer の構成状況に問題があります。次の公式ドキュメントやブログ記事等を参考に原因箇所を特定してください。<ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/loadbalancer-troubleshooting" target="_blank" rel="noopener">ロードバランサー経由での通信ができない場合のチェックポイント | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/azurelb-tips" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 | Microsoft Docs</a></li></ul></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p> Azure Load Balancer に関わるトラブルを解決する際には、<strong>Azure Load Balancer は L4 ロードバランサーである</strong>ということを意識しておく必要があります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-overview" target="_blank" rel="noopener">Azure Load Balancer の概要 - Azure Load Balancer | Microsoft Docs</a></li></ul><blockquote><p>Azure Load Balancer は、開放型システム間相互接続 (OSI) モデルのレイヤー 4 で動作します。 </p></blockquote><p>立ち位置を明確にする為に他の負荷分散サービスと比べてみると、Azure の負荷分散サービスで関与できるネットワーク レイヤーは、それぞれ以下の通りです。</p><ul><li><strong>Trarffic Manager</strong>: DNS レベルの負荷分散装置。DNS による名前解決時に負荷分散に関与できる。</li><li><strong>Azure Load Balancer</strong>: トランスポート層 (L4) の負荷分散装置。UDP または TCP のフローを、適当なバックエンド サーバーに分散するのが仕事。</li><li><strong>Application Gateway</strong>: アプリケーション層 (L7) の負荷分散装置。HTTP/S のセッションを、適当なバックエンド サーバーに分散するのが仕事。</li></ul><p>なお、負荷分散サービスの比較は、以下のドキュメントでより詳しく説明されています。これらのサービスの比較にご興味があれば、併せてご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-load-balancing-azure" target="_blank" rel="noopener">Azure で負荷分散サービスを使用する | Microsoft Docs</a></li></ul><p>「503 エラーが表示されるが、Azure Load Balancer に問題はないか調査してほしい」といったお問い合わせをいただくことがありますが、<span style="color: #d00000">Azure Load Balancer はあくまで L4 の接続性を担保するのが責務であり、その上のレイヤーである HTTP の応答に関与することはありません</span>。</p><p>Azure Load Balancer は TCP ペイロードに関与しないため、例えば HTTP の 50* 系ステータス コードのレスポンスを返すことも、<code>X-forwarded-for</code> ヘッダを書き換えることもありません。HTTP (アプリケーション層) で何か不具合が出ている場合は、バックエンド サーバーより後段のエンティティを対象に原因調査するのが良いでしょう。</p><h2 id="スコーピング-問題の切り分け"><a href="#スコーピング-問題の切り分け" class="headerlink" title="スコーピング: 問題の切り分け"></a>スコーピング: 問題の切り分け</h2><p>この記事の最大の目的です。Azure Load Balancer を経由するシステムに問題がある場合の <strong>切り分け (スコーピング) 方法</strong>について紹介していきたいと思います。具体的には「Azure Load Balancer に関連する箇所で問題があるか」を切り分けます。</p><p>答えを言ってしまうと、Azure Load Balancer に問題があるか切り分けるには <strong>L4 の接続性 (connectivity)</strong> を確認するだけで十分です。</p><p>切り分けのフローチャートを作成したので、まずは下図を基に全体像を把握していただければ幸いです。</p><p><img src="/blog/network/tsg-azure-load-balancer-scoping/scoping-flowchart.png" alt="tsg-flowchart"></p><h3 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h3><p>切り分けに必要な情報は以下の通りです。</p><ul><li><code>&lt;vip&gt;</code>: フロントエンドで待ち受ける仮想 IP アドレス</li><li><code>&lt;protocol&gt;</code>: VIP で待ち受ける L4 プロトコル (TCP/UDP)</li><li><code>&lt;port&gt;</code>: VIP で待ち受けるポート番号</li><li><code>&lt;backend-port&gt;</code>: 負荷分散された後、バックエンド サーバーが受け取る (NAPT 後の) ポート番号</li></ul><p>加えて、テストパケットを送信するクライアントも用意する必要がありますが、クライアントと Azure Load Balancer の間には余計なネットワーク装置 (e.g. Firewall) を置かないことが鉄則です。どうしてもそのようなクライアントが準備出来ない場合は、被疑箇所は Azure Load Balancer だけではなく、中間のネットワーク装置まで含めた検証となることを必ず意識してください。</p><p>なお、クライアントには対象の Azure Load Balancer のバックエンド サーバーではないものを選択してください。というのも、内部ロードバランサーは自分自身に負荷分散されたパケットはドロップされる動作となっている為です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot#cause-4-accessing-the-internal-load-balancer-frontend-from-the-participating-load-balancer-backend-pool-vm" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li></ul><blockquote><p>副作用として、バックエンド プール内の VM からの送信フローが、そのプール内の内部ロード バランサーのフロントエンドへのフローを試み、”かつ”、それ自体にマップバックされている場合、フローの 2 つのレッグは一致しません。 これらは一致しないため、フローは失敗します。 フローが、フロントエンドへのフローを作成したバックエンド プール内の同じ VM にマップバックしなかった場合、フローは成功します。</p></blockquote><h3 id="TCP-の負荷分散規則"><a href="#TCP-の負荷分散規則" class="headerlink" title="TCP の負荷分散規則"></a>TCP の負荷分散規則</h3><p>負荷分散プロトコルが TCP の場合、3-way handshaking が確認できれば疎通できていると見なせるので、切り分けはクライアントで完結します。</p><p>例えば次のコマンドを実行して、TCP コネクションが確立できるか確認します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[client]# telnet &lt;vip&gt; &lt;port&gt;</span><br><span class="line">[client]# curl -v telnet:&#x2F;&#x2F;&lt;vip&gt;:&lt;port&gt;</span><br><span class="line">[client]# nc -v &lt;vip&gt; &lt;port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell)</span><br><span class="line">PS C:\client&gt; Test-NetConnection &lt;vip&gt; -Port &lt;port&gt;</span><br><span class="line">PS C:\client&gt; PsPing -t &lt;vip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><ul><li><a href="https://Linux.die.net/man/1/telnet" target="_blank" rel="noopener">telnet(1): user interface to TELNET protocol - Linux man page</a></li><li><a href="https://Linux.die.net/man/1/nc" target="_blank" rel="noopener">nc(1): arbitrary TCP/UDP connections/listens - Linux man page</a></li><li><a href="https://docs.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=win10-ps" target="_blank" rel="noopener">Test-NetConnection | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psping" target="_blank" rel="noopener">PsPing - Windows Sysinternals | Microsoft Docs</a></li></ul><p>Linux と Windows のいずれの場合でも、TCP コネクションが connected になれば L4 の疎通性に問題はありません。</p><h3 id="UDP-の負荷分散規則"><a href="#UDP-の負荷分散規則" class="headerlink" title="UDP の負荷分散規則"></a>UDP の負荷分散規則</h3><p>一方で、UDP の場合は、クライアントからの通信に必ずしも応答 (ACK) が返されるとは限らないため、サーバー側で着信を確認する必要があります。</p><p>クライアント側では例えば以下のようなコマンドで、テスト パケットを送信出来ます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">[client]# echo -n &quot;test message&quot; | nc -u &lt;vip&gt; &lt;port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell)</span><br><span class="line">PS C:\client&gt;</span><br><span class="line">function Test-Udp($vip, $port) &#123;</span><br><span class="line">    $client &#x3D; New-Object System.Net.Sockets.UdpClient</span><br><span class="line">    $client.Connect($vip, $port)</span><br><span class="line">    $encoding &#x3D; New-Object System.Text.ASCIIEncoding</span><br><span class="line">    $bytes &#x3D; $encoding.GetBytes(&quot;test message&quot;)</span><br><span class="line">    $client.Send($bytes, $bytes.Length)</span><br><span class="line">    $client.Close()</span><br><span class="line">&#125;</span><br><span class="line">Test-Udp &lt;vip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><p>サーバー側でテスト パケットが着信していることを確認するには、アクセスログを確認する、モックサーバーを利用する、パケットをキャプチャする、といった選択肢が選べます。ここでは、最も汎用性の高いパケット キャプチャによる確認方法を簡単に紹介します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">[server]# sudo tcpdump -i any -nN udp and port &lt;backend-port&gt;</span><br><span class="line"></span><br><span class="line"># Windows (powershell with administrator mode)</span><br><span class="line">PS C:\server&gt; netsh trace start report&#x3D;no capture&#x3D;yes tracefile&#x3D;%USERPROFILE%\Desktop\trace.etl</span><br><span class="line">PS C:\server&gt; netsh trace stop</span><br></pre></td></tr></table></figure><p><code>tcpdump</code> の場合は、標準出力に対象のパケットが表示できれば L4 疎通性は問題ありません。また、<code>netsh</code> の場合は、採取したトレース ファイル (デスクトップに生成される <code>trace.etl</code>) に対象のパケットが含まれていたら L4 疎通性に問題ありません。</p><h2 id="ネクスト-アクション"><a href="#ネクスト-アクション" class="headerlink" title="ネクスト アクション"></a>ネクスト アクション</h2><p>上記の切り分けで L4 の疎通性が得られない場合、Azure Load Balancer の構成状況に問題があります。次に紹介するブログ記事や公式ドキュメントを参考に、原因箇所の特定をご実施ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-troubleshoot" target="_blank" rel="noopener">Azure Load Balancer のトラブルシューティング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/loadbalancer-troubleshooting" target="_blank" rel="noopener">ロードバランサー経由での通信ができない場合のチェックポイント | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/azurelb-tips" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 | Microsoft Docs</a></li></ul><p>一方で、Azure Load Balancer に問題がなければ、多くの状況でサーバーで動作しているアプリケーションがエラー原因です。正確に言えば、OS のネットワーク スタック以上のレイヤーで、構成が間違っているか予期しない問題が起きている可能性があります。</p><p>本切り分けの検証結果や、現在の状況、目標とする状態などを OS やミドルウェア/アプリケーションのベンダー様とご共有いただき、さらに原因調査を進めてください。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure Load Balancer (ALB) はワークロードを複数の Azure VM / VMSS に負荷分散するサービスで、最も利用されている Azure サービスの一つです。利用数が多い分、ALB を経由するエンドノード間の通信に問題が生じたといったトラブルもよくお問い合わせいただきます。そこで、そうしたトラブルにおいて、ALB の観点で原因箇所を切り分けるスコーピングの方法についてご紹介したいと思います。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
      <category term="TSG" scheme="https://jpaztech.github.io/blog/tags/TSG/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の外部接続 (SNAT) オプション まとめ</title>
    <link href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/"/>
    <id>https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/</id>
    <published>2020-06-16T04:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.498Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure VM がインターネットに接続する際には、パブリック IP アドレスでの送信元 NAT (SNAT) が必要です。Azure は、外部接続の SNAT に関して多くのオプションを提供していますが、オプションが多くて便利な反面、全オプションの列挙やオプション間の比較が難しいのも事実です。そうした難しさを少しでも緩和できるよう、本稿では外部接続の SNAT オプションを様々な角度から網羅的に紹介いたします。</p><a id="more"></a><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p><strong>仮定する知識</strong></p><p>この記事では、一般的なネットワーク用語としてのネットワーク アドレス変換 (NAT) や NAPT について、ある程度知識があることを前提としています。これらの言葉に馴染みがなければ、以下の公式ドキュメントを参考に、まずは NAT についての技術背景を確認してみてください。インターネットを活用すれば、さらに多くの技術解説を見つけることが出来るはずです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#understanding-snat-and-pat" target="_blank" rel="noopener">Azure の Outbound connections &gt; SNAT と PAT の理解 | Microsoft Docs</a></li></ul><p><strong>外部接続と SNAT</strong></p><p>Azure 仮想マシン (VM) がインターネット等のグローバル IP アドレス帯のサーバーと通信することを、<strong>外部接続 (outbound connection)</strong> と呼びます。外部接続では、仮想ネットワークで設定したプライベート IP アドレスから、グローバル IP アドレスに送信元 NAT (SNAT) する必要があります。この記事で取り扱うのは、外部接続の為に Azure が提供している SNAT のオプションについてです。</p><p>結論から書くと、2020 年 6 月現在、Azure で利用できる SNAT のオプションは以下の 5 つ存在します。</p><ul><li>ユーザー定義ルートと仮想アプライアンス (e.g. Azure Firewall) による SNAT</li><li>NAT Gateway</li><li>パブリック Azure Load Balancer (外部ロードバランサー)</li><li>パブリック IP アドレス</li><li>Azure 既定の SNAT</li></ul><p>「ユーザー定義ルート (UDR) と仮想アプライアンス (NVA) による SNAT」に関しては、SNAT 可否やその動作仕様が NVA 製品に依存しますので、今回は残る 4 つの「Azure プラットフォームそのものが提供する SNAT」についてお話します (UDR+NVA で SNAT する場合も、結局 NVA 上では残りのいずれかの方法で SNAT する必要があります)。</p><h2 id="判定フローチャート"><a href="#判定フローチャート" class="headerlink" title="判定フローチャート"></a>判定フローチャート</h2><p>個々の詳細を見る前に、SNAT オプション同士の依存関係を把握し、全体感を捉えておきましょう。</p><p>というのも、環境によっては複数の SNAT オプションが構成されている可能性がある為です。例えば、NAT Gateway を関連付けたサブネットの中に、パブリック IP アドレスを付与した VM をデプロイするとどうなるでしょうか?</p><p>そのような状況で役に立つフローチャートを作図しました。以下のフローに従えば、<strong>ある Azure VM のある NIC</strong> がどのように SNAT されるか判定できます。VM ではなく、<span style="color: #c00000">NIC に関する SNAT 方法判定</span>である点に注意してください。</p><p><img src="/blog/network/snat-options-for-azure-vm/flowchart-to-determine-snat-scenario.png" alt="flowchar"></p><p>なお、フローチャートに脚注で記載されているシナリオ {1, 2, 3} は、以下の公式ドキュメントのシナリオ番号に対応しています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-overview" target="_blank" rel="noopener">Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</a></li></ul><p><strong>フローチャートの使い方</strong></p><p>先程挙げた NAT Gateway とパブリック IP アドレスの共存環境の例を使って、フローチャートの使い方を説明します。</p><ol><li>左上の丸からスタートします。</li><li>まずはじめに、UDR で宛先が NVA に向いているか確認します。この情報は、NIC の [有効なルート] から確認することが出来ます。この例では NVA もルート テーブルもデプロイしておらず、判定は “NO” だったとして次の条件文に進みます。</li><li>サブネットに NAT Gateway が関連付けられているか確認します。この情報は、仮想ネットワークの [サブネット] から確認することが出来ます。この例では NAT Gateway が関連付けられています! 条件文の答えは “YES” なので、フローチャートはここで終了します。</li></ol><p>最終的に、パブリック IP アドレスではなく NAT Gateway が優先されて SNAT される動作であることが、このフローチャートから判定出来ました。</p><p><strong>Standard SKU の外部接続構成か?</strong></p><p>最後の「Standard SKU の外部接続構成か?」と記載された条件ボックスは、次のいずれか一つを満たす場合に “YES” と判定されます。</p><ul><li>VM には可用性セットが構成されていて、一つ以上の可用性セット内 VM が「Standard SKU の外部接続リソース」に関連付けられている。</li><li>VM は仮想マシン スケール セット (VMSS) であり、一つ以上の VMSS 内 VM が「Standard SKU の外部接続リソース」に関連付けられている。</li><li>複数の NIC が VM に関連付けられていて、一つ以上の NIC が「Standard SKU の外部接続リソース」に関連付けられている。</li></ul><p>ここで、Standard SKU の外部接続リソースとは、以下の Azure リソースを表します。</p><ul><li>Standard SKU のパブリック IP アドレス</li><li>Standard SKU の Azure Load Balancer</li></ul><p>上記の通り、NAT Gateway は “Standard SKU の外部接続リソース” に該当しないため、可用性セットの一部 VM にだけ外部接続を構成したい場合や、複数 NIC を持つ VM の一部 NIC に外部接続を構成したい場合に使えます。</p><p>このあたりの条件式を把握するのは難しく、個人的にも理解するのに最も時間がかかった部分ですが、 <strong>Standard SKU ではリソースの保護が強化されていて、明示的に通信設定をするまでは許可されない</strong> と理解すれば多少は飲み込みやすいと思います。同じ内容は、以下の公式ドキュメントにも記載されています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener">Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</a></li></ul><blockquote><p>重要<br>…<br>アウトバウンド接続のコンテキストでは、単一スタンドアロン VM、可用性セット内のすべての VM、VMSS のすべてのインスタンスがグループとして動作します。 つまり、可用性セット内の単一 VM が Standard SKU に関連付けられている場合、この可用性セット内のすべての VM インスタンスが、Standard SKU に関連付けられている場合と同じ規則に従って動作するようになります。個々のインスタンスが直接関連付けられていない場合でも同様です。 この動作は、ロード バランサーに複数のネットワーク インターフェイスカードが接続されているスタンドアロン VM の場合にも見られます。 1 つの NIC をスタンドアロンとして追加された場合、同じ動作が行われます。</p></blockquote><p><strong>外部接続不可</strong></p><p>最後に、フローチャートの中で赤色で記された<span style="color: #c00000;">「外部接続不可」</span>のシナリオについて補足しておきます。</p><p>フローチャートからもわかるように、Azure では多くの SNAT オプションがあり、ほとんどの状況で外部接続が可能です。特に、NAT 装置を意識せずに VM をデプロイするだけでも (デフォルトゲートウェイが) SNAT を実施してくれる「Azure 既定の SNAT」のシナリオに関しては、特筆すべきポイントです。</p><p>しかしながら、一つだけ SNAT 出来ないシナリオがあります。それが<span style="color: #c00000;">「外部接続不可」</span>のシナリオです。具体的には、Standard SKU の外部接続構成の NIC に、明示的に外部接続リソースを関連付けない場合に該当します (こうして言葉で説明するより、フローチャートを見てもらうほうが早いと思います)。</p><p>「VM が外部接続できない、できなくなった」というお問い合わせは多数いただきますが、殆どの場合の根本原因は、単に<span style="color: #c00000;">「外部接続不可」</span>のシナリオに該当していたというものです。このため、過去にもブログ記事として紹介しています。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/Azure%E3%83%AD%E3%83%BC%E3%83%89%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B5%E3%83%BC%E5%88%A9%E7%94%A8%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9.html#outbound-cannot-connect" target="_blank" rel="noopener">Azure ロードバランサー利用時の注意点 &gt; ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった</a></li></ul><blockquote><p>ロードバランサーのバックエンドプールに追加したら外部へ接続できなくなった<br>こちらの事象についてよくある原因としては以下があります。</p><ol><li>Standard SKU の内部ロードバランサーのバックエンドプールに所属している</li></ol></blockquote><p>上記ブログ記事は少し情報が古く (というより Azure の進化のスピードが本当にはやく)、現在はこのシナリオのワークアラウンドは以下の 4 つとなっていますが、<strong>明示的に外部接続のポリシーを構成する</strong> という根本的な考え方は変わりません。</p><ul><li>NVA (e.g. Azure Firewall) をデプロイし、0.0.0.0/0 のネクストホップを NVA に向ける UDR を構成する</li><li>NAT Gateway をデプロイし、VM が配置されているサブネットに関連付ける</li><li>Standard SKU のパブリック IP アドレスをデプロイし、VM に関連付ける</li><li>Standard SKU の外部ロードバランサーをデプロイし、そのバックエンド プールに VM を配置する</li></ul><h2 id="機能比較"><a href="#機能比較" class="headerlink" title="機能比較"></a>機能比較</h2><p>フローチャートの他に、幾つかの機能項目をピックアップし SNAT オプション間で比較した表も用意しました。俯瞰的に機能を比べる目的でご利用ください。</p><table><thead><tr><th align="center"></th><th align="center">AzFW/NVA + UDR</th><th align="center">NAT GW</th><th align="center">Public IP</th><th align="center">Public Azure Load Balancer</th><th align="center">Default SNAT</th></tr></thead><tbody><tr><td align="center">関連付け単位</td><td align="center">サブネット[^1]</td><td align="center">サブネット</td><td align="center">NIC</td><td align="center">バックエンド プール</td><td align="center">NIC</td></tr><tr><td align="center">送信元を固定出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">はい</td><td align="center">はい</td><td align="center">はい</td><td align="center">いいえ</td></tr><tr><td align="center">SNAT ポート数を拡張出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">はい</td><td align="center">いいえ</td><td align="center">はい</td><td align="center">いいえ</td></tr><tr><td align="center">SNAT ポート数が VM に静的割り当てされるか</td><td align="center">NVA 依存[^2]</td><td align="center">いいえ (動的確保)</td><td align="center">はい (64000 個)</td><td align="center">はい (数は構成依存)</td><td align="center">はい (1024 個)</td></tr><tr><td align="center">TCP アイドルタイムアウト</td><td align="center">NVA 依存[^2]</td><td align="center">4 ～ 120 分</td><td align="center">4 分</td><td align="center">4 ～ 120 分</td><td align="center">4 分</td></tr><tr><td align="center">利用可能なプロトコル</td><td align="center">NVA 依存[^2]</td><td align="center">TCP/UDP</td><td align="center">TCP/UDP/ICMP/ESP</td><td align="center">TCP/UDP</td><td align="center">TCP/UDP/ICMP</td></tr><tr><td align="center">インバウンド接続性も確保出来るか</td><td align="center">NVA 依存[^2]</td><td align="center">いいえ</td><td align="center">はい</td><td align="center">はい</td><td align="center">いいえ</td></tr></tbody></table><p>それぞれの行で意図している内容は、以下の通りです。</p><ul><li><strong>関連付け単位</strong>: SNAT のポリシーを適用する単位です。例えばサブネットが SNAT ポリシーの単位である場合、サブネット内のすべての VM は同じ方法で SNAT が実施されます。</li><li><strong>送信元を固定出来るか</strong>: この項目が “はい” の SNAT オプションでは、特定の SNAT アドレス プールから送信元の IP アドレスを払い出す事ができます。”いいえ” の SNAT オプションでは、時間経過や VM の先道など、あるイベントをトリガーとして SNAT プールが変更される可能性があります。</li><li><strong>SNAT ポート数を拡張出来るか</strong>: この項目が “はい” の SNAT オプションでは、構成状況を変更することで、ユーザーが各 VM に割り当てる SNAT ポート数を変動させることが出来ます。”いいえ” のオプションでは、予め定められた値のポート数が各 VM に割り当てられます。</li><li><strong>SNAT ポート数が VM に静的割り当てされるか</strong>: この項目が “はい” の SNAT オプションでは、予め各 VM には最大の SNAT ポート数が定められます。基本的に SNAT ポート数は固定ですが、唯一の例外は NAT Gateway です。NAT Gateway では、利用状況に応じて SNAT ポート数は動的に VM に割り当てられます。</li><li><strong>TCP アイドルタイムアウト</strong>: 外部接続の TCP 接続に関するタイムアウト値 (分) です。範囲が記載されている SNAT オプションに関しては、ユーザーが定めることが出来ます。</li><li><strong>利用可能なプロトコル</strong>: 外部接続でサポートされているプロトコルです。すべての SNAT オプションで TCP/UDP はサポートされているものの、ICMP が利用できないオプションもあるので注意してください。</li><li><strong>インバウンド接続性も確保出来るか</strong>: この項目が “はい” の SNAT オプションでは、Azure リソースを追加でデプロイすることなく、インバウンドの接続ポリシーも構成することが出来ます。</li></ul><p>[^1]: UDR の関連付け単位がサブネットであることに起因しています<br>[^2]: NVA による SNAT も結局は NAT Gateway、パブリック IP アドレス、外部 Azure Load Balancer、Azure 既定の SNAT のいずれかのオプションを NVA で利用しています。したがって、NVA の動作制限に加えて、これらの制限も当然加わります。</p><h2 id="SNAT-オプションの詳細"><a href="#SNAT-オプションの詳細" class="headerlink" title="SNAT オプションの詳細"></a>SNAT オプションの詳細</h2><p>このセクションでは、各 SNAT オプションについて少し深堀りして説明します。</p><p>主な特徴やユースケース、注意事項等を記載しますので、ここまでの内容を踏まえて興味の湧いた SNAT オプションについて、詳しく確認してみてください。</p><h3 id="NAT-Gateway"><a href="#NAT-Gateway" class="headerlink" title="NAT Gateway"></a>NAT Gateway</h3><p><img src="/blog/network/snat-options-for-azure-vm/nat-gateway-snat.png" alt="nat-gateway"></p><p><em>NAT ゲートウェイ (NAT Gateway)</em> は、複数ある SNAT オプションの中で唯一「外部接続だけを目的とした」専用サービスです。専用サービスとだけあって、SNAT プールの固定化はもちろん、動的なポート確保など、他の SNAT オプションにはない機能を有します。</p><p><strong>特徴</strong></p><ul><li>フルマネージドな PaaS サービスで、高い可用性を有します。</li><li>動的に SNAT ポートを確保できるのは NAT Gateway だけです[^3]。</li><li>Public IP や Azure Load Balancer の SNAT よりも、NAT Gateway が優先されます[^4]。</li><li>外部接続の TCP アイドル タイムアウトを最大 120 分に伸ばせます。</li><li>NAT Gateway に追加できるパブリック IP アドレスの最大数は 16 個です。つまり、一つの NAT Gateway あたり、最大 64,000 * 16 = 1,024,000 ポートが SNAT ポートに使えます。</li></ul><p>[^3]: NAT Gateway の動的な SNAT ポート確保動作の詳細は、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource#on-demand" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 &gt; オンデマンド</a> をご覧ください。<br>[^4]: NAT Gateway と Public IP/Azure Load Balancer の共存環境における動作については、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource#nat-and-vm-with-instance-level-public-ip-and-public-load-balancer" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 &gt; インスタンスレベル パブリック IP とパブリック Load Balancer を使用した VM と NAT</a> をご覧ください。</p><p><strong>基本的な構成方法</strong></p><ol><li>NAT Gateway リソースを作成する。</li><li>対象のサブネットに NAT Gateway を関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>一般的な SNAT のシナリオ全般。</li><li>大量に SNAT ポートが必要となる場合。</li><li>複数の VM で SNAT プールを共有したいが、各 VM が消費する SNAT ポート数にばらつきがある場合。</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway では、インバウンドの接続性は提供されません。</li><li>UDR で特定の経路のネクスト ホップを NVA や仮想ネットワーク ゲートウェイに向けている場合、それらを宛先とする通信は NAT Gateway を利用して SNAT されません。</li><li>他の外部接続のサービスで言えば Standard SKU の扱いのサービスなので、Basic のサービスと共存出来ません (e.g. Basic SKU の Public IP が付与された VM がサブネットに存在すれば、NAT Gateway は関連付けできない)。</li><li>ICMP プロトコルはサポートされません。</li><li>その他の制限事項について、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-overview#limitations" target="_blank" rel="noopener">公式ドキュメント</a> をご確認ください。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-overview" target="_blank" rel="noopener">Azure Virtual Network NAT とは | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/nat-gateway-resource" target="_blank" rel="noopener">NAT ゲートウェイ リソースを使用した仮想ネットワークの設計 - Azure Virtual Network NAT | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/troubleshoot-nat" target="_blank" rel="noopener">Azure Virtual Network NAT 接続のトラブルシューティング - Azure Virtual Network | Microsoft Docs</a></li></ul><h3 id="パブリック-IP-アドレス"><a href="#パブリック-IP-アドレス" class="headerlink" title="パブリック IP アドレス"></a>パブリック IP アドレス</h3><p><img src="/blog/network/snat-options-for-azure-vm/public-ip-address-snat.png" alt="public-ip-address"></p><p>Azure VM のネットワーク インターフェイス (NIC) にパブリック IP アドレス (Public IP) を関連付けると、その NIC からの外部接続は Public IP によって SNAT される動作となります。</p><p><strong>特徴</strong></p><ul><li>SNAT に利用される IP アドレスは必ず Public IP なので、送信元を固定することが出来ます。</li><li>割り当てられるポート数は、Public IP が利用できるエフェメラル ポートの最大数 64,000 で固定されます。この 64,000 という数字は、もちろん用途にもよりますが、多くのワークロードで十分な SNAT ポート数です。</li></ul><p><strong>基本的な構成方法</strong></p><ol><li>パブリック IP アドレス リソースを作成する。</li><li>対象の VM の NIC に関連付ける。</li></ol><p><strong>ユースケース</strong></p><ul><li>エフェメラル ポートを一つの VM で専有したい場合 (e.g. 多くの SNAT ポートを消費するフォワード プロキシ)。</li><li>外部接続だけでなく VM 単位でのインバウンド接続も確保したい場合 (e.g. 特定拠点からリモート アクセスされる踏み台サーバー)。</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway による SNAT が実施されていないことが前提条件です。</li><li>Basic SKU だと NAT Gateway と共存出来ない等、SKU 依存の制限が存在します。可用性ゾーンへの対応も考慮すると、基本的には Standard SKU の使用が推奨されます。</li></ul><p><strong>参考文献</strong></p><ul><li>[Azure の Outbound connections &gt; シナリオ 1:パブリック IP アドレスありの VM | Microsoft Docs](<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilPublic" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilPublic</a> IP)</li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/virtual-network-public-ip-address" target="_blank" rel="noopener">Azure パブリック IP アドレスの作成、変更、削除 | Microsoft Docs</a></li></ul><h3 id="Azure-Load-Balancer"><a href="#Azure-Load-Balancer" class="headerlink" title="Azure Load Balancer"></a>Azure Load Balancer</h3><p><img src="/blog/network/snat-options-for-azure-vm/auzre-load-balancer-snat.png" alt="auzre-load-balancer-snat"></p><p>外部ロードバランサーのバックエンド プールに Azure VM を配置すると、構成した規則に応じて、フロントエンドの Public IP で SNAT される動作となります。</p><!-- [^Azure Load Balancer-snat-trigger]: 厳密にはバックエンド プールに VM を配置するだけでは不十分で、規則 (送信規則、負荷分散規則、インバウンド NAT 規則) を作るまでは SNAT されません。 --><p>このシナリオでは、特に Azure Load Balancer の Standard SKU でのみ利用可能な <strong>送信規則 (outbound rule)</strong> が効果的に活用できます。送信規則を使うと、SNAT ポート割り当てのカスタマイズや、TCP アイドルタイムアウトの調節が柔軟に構成出来ます。</p><p><strong>特徴</strong></p><ul><li>バックエンド プール単位で SNAT ポリシーが構成されるため、サブネットにとらわれずに複数 VM を同じ方法で SNAT できる。</li><li>Standard SKU で利用可能な送信規則を使って、より仔細に SNAt ポリシーが構成できる。</li><li>送信規則で制御できるパラメータは、以下の通り。<ul><li>バックエンド プール (どの仮想マシンに SNAT ポリシーを適用するか)</li><li>SNAT ポート数の割り当てかた (各仮想マシンに何ポートずつ割り当てるか)</li><li>SNAT の対象とするプロトコル (TCP、UDP、または両方)</li><li>TCP アイドルタイムアウト (4 分から最大 120 分まで)</li><li>タイムアウト時の TCP リセット送信の有無</li></ul></li></ul><p><strong>基本的な構成方法</strong></p><ol><li>パブリック IP アドレスをフロントエンドに付与した Azure Load Balancer (外部ロードバランサー) をデプロイする。</li><li>バックエンド プールを作成し、SNAT ポリシーを適用したい VM を複数追加する。</li><li>送信規則、インバウンド NAT 規則、あるいは送信規則 (Standard SKU のみ) を構成する。</li></ol><p><strong>ユースケース</strong></p><ul><li>SNAT と同時に、インバウンド方向の負荷分散も同時に構成したい場合 (e.g. 処理の一部で外部送信が必要となる WEB サーバー)。</li><li>サブネット以外の単位で、複数 VM を同一 SNAT ポリシー下としたい場合 (e.g. サブネットの一部の VM にのみインターネット接続を許可する)</li></ul><p><strong>注意事項</strong></p><ul><li>NAT Gateway、Public IP による SNAT が実施されていないことが前提条件です。</li><li>Basic SKU と Standard SKU で、SNAT の動作が大きく異なります。これは、Standard SKU で送信規則が追加され、高い自由度で SNAT ポリシーを構成できるようになった為です。</li><li>Basic SKU の場合、SNAT ポート数はバックエンド プールの VM の台数に依存して、Azure 基盤が自動で割り当てます。<ul><li>具体的な対応表は、以下の公式ドキュメントに記載がある通りです。<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ephemeral-port-preallocation-for-port-masquerading-snat-pat" target="_blank" rel="noopener">Azure の Outbound connections &gt; ポート マスカレード SNAT (PAT) 用のエフェメラル ポートの事前割り当て | Microsoft Docs</a></li></ul></li><li>Standard SKU の場合、Basic SKU での自動割り当ての方法に加えて、送信規則を使って手動のポート数割り当てが行えます。<ul><li>送信規則によるポート数の調節については、以下の公式ドキュメントを参考にしてください。<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#azure-load-balancer-outbound-rules" target="_blank" rel="noopener">Azure の Outbound connections &gt; Azure Load Balancer のアウトバウンド規則 | Microsoft Docs</a></li></ul></li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-load-balanced-vm-without-a-public-ip-address" target="_blank" rel="noopener">Azure の Outbound connections &gt; シナリオ 2:パブリック IP アドレスなしの負荷分散 VM | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/configure-load-balancer-outbound-portal" target="_blank" rel="noopener">Azure portal を使用して負荷分散規則とアウトバウンド規則を構成する - Azure Load Balancer | Microsoft Docs</a></li></ul><h3 id="Azure-既定の-SNAT"><a href="#Azure-既定の-SNAT" class="headerlink" title="Azure 既定の SNAT"></a>Azure 既定の SNAT</h3><p><img src="/blog/network/snat-options-for-azure-vm/azure-default-snat.png" alt="azure-default-snat"></p><p>パブリック IP アドレスや外部ロードバランサーにも関連づいていない状態でも、Azure VM は既定で外部接続できるようになっています。特に SNAT の構成をしていないのにも関わらず、外部接続ができることで驚いた経験をした方もいらっしゃるのではないでしょうか。</p><p>特にパブリック IP アドレスをユーザーが確保しているわけではないため、SNAT プールはオンザフライでの提供となります。具体的には、VM がデプロイされている Azure リージョンで使用されるグローバル IP アドレスのうち、未使用なものがランダムに割り当てられます。そのため、VM を再起動するたびに、SNAT に利用される NAT アドレスは変動します。</p><p>なお、各 Azure リージョンで使用されるグローバル IP アドレスは、以下ページからダウンロードできる JSON ファイルに定義されています。</p><ul><li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" target="_blank" rel="noopener">Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center</a></li></ul><p><strong>特徴</strong></p><ul><li>唯一パブリック IP アドレス リソースを作らずに SNAT が出来るシナリオ。</li><li>未使用な IP アドレスがランダムで割り当てられるため、VM が起動するたびに SNAT アドレスが変動する。</li><li>確保される SNAT ポート数は VM あたり 1024 で固定。</li></ul><p><strong>基本的な構成方法</strong></p><p>以下のいずれかの環境で、VM は「Azure 既定の SNAT」で外部接続されます。</p><ul><li>VM を Basic SKU の内部 Azure Load Balancer のバックエンド プールに配置する</li><li>NAT Gateway、パブリック IP アドレス、Azure Load Balancer と関係ないスタンドアロンな VM を構成する</li></ul><p><strong>ユースケース</strong></p><ul><li>テスト/開発用 VM で外部送信が必要になる場合 (e.g. ひとまずインターネットに通信できていれば特に問題ない開発マシン)</li></ul><p><strong>注意事項</strong></p><ul><li>パブリック IP アドレスを付与しなくても外部接続できるという利便性がある一方で、予期せず外部送信を許可していますケースもあります。外部接続を許可しない場合、VM を Standard SKU の内部ロードバランサー配下として意図的に「外部接続不可」環境にするか、NSG で外部送信を拒否する対策等を実施してください。</li><li>SNAT プールが固定出来ないため、外部接続の接続先となるサーバーで ACL を実施するのが難しくなります。</li><li>あくまでテスト目的か、インターネットとの接続性だけ得られていれば後は気にしないようなワークロードでのみご利用いただくことを推奨いたします。</li></ul><p><strong>参考文献</strong></p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-3-standalone-vm-without-a-public-ip-address" target="_blank" rel="noopener">Azure の Outbound connections &gt; シナリオ 3:パブリック IP アドレスなしのスタンドアロン VM | Microsoft Docs</a></li><li><a href="https://www.syuheiuda.com/?p=5074" target="_blank" rel="noopener">Azure VM の SNAT の話 – Made in container</a></li></ul><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>記事のボリュームからも推察できる通り、Azure では SNAT のオプションが多く用意されています。</p><p>ただ、自由度が上がる副作用として、どうしてもすべてのシナリオを網羅的に把握することが難しくなっています。外部接続できない時のトラブルシューティングや、他にどんな選択肢があるのかの確認に、ぜひ冒頭で紹介したフローチャートを活用していただければと思います。</p><p>また、SNAT オプションの比較には、機能比較のセクションで示した比較表もご活用ください。当該の比較表は、各 SNAT オプションのすべての側面を映し出しているわけではありませんが、大まかにどのような違いがあるのかを知るには十分の情報を記載してあります。ファーストステップとしては丁度よい情報量だと思いますので、参考にしていただければ幸いです。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure VM がインターネットに接続する際には、パブリック IP アドレスでの送信元 NAT (SNAT) が必要です。Azure は、外部接続の SNAT に関して多くのオプションを提供していますが、オプションが多くて便利な反面、全オプションの列挙やオプション間の比較が難しいのも事実です。そうした難しさを少しでも緩和できるよう、本稿では外部接続の SNAT オプションを様々な角度から網羅的に紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="NAT Gateway" scheme="https://jpaztech.github.io/blog/tags/NAT-Gateway/"/>
    
      <category term="Azure Load Balancer" scheme="https://jpaztech.github.io/blog/tags/Azure-Load-Balancer/"/>
    
      <category term="Public IP Address" scheme="https://jpaztech.github.io/blog/tags/Public-IP-Address/"/>
    
      <category term="SNAT" scheme="https://jpaztech.github.io/blog/tags/SNAT/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Peering 導入時の注意事項</title>
    <link href="https://jpaztech.github.io/blog/network/considerations-of-microsoft-peering/"/>
    <id>https://jpaztech.github.io/blog/network/considerations-of-microsoft-peering/</id>
    <published>2020-06-15T01:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.494Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Networking テクニカル サポートの山口です。</p><p>Azure のネットワークとオンプレミス拠点ネットワークを直接接続する ExpressRoute と呼ばれるサービスがあります。ExpressRoute では利用目的に応じた複数のピアリング方法が用意されているのですが、今回は Microsoft Peering と呼ばれるピアリング サービスについて注目して、その構築時に留意いただく必要のあるポイントをいくつかご紹介したいと思います。</p><a id="more"></a><h2 id="Microsoft-Peering-とは何か"><a href="#Microsoft-Peering-とは何か" class="headerlink" title="Microsoft Peering とは何か"></a>Microsoft Peering とは何か</h2><p>ExpressRoute は、オンプレミスと Azure のネットワークをインターネットを介さずに直接接続するためのサービスです。ExpressRoute 回線と呼ばれる Azure リソースを作成し、その中にピアリング情報を構成することで利用できます。</p><p>接続先に応じて下記 2 種類のピアリング種類が用意されており、ひとつの ExpressRoute 回線上に両ピアリングを同時に構成することもできます。</p><ul><li><strong>Private Peering</strong>: 仮想ネットワークとの接続 (Azure 上の Private IP 帯との接続)</li><li><strong>Microsoft Peering</strong>: Azure のパブリック サービス / O365 との接続 (Azure のパブリック IP 帯との接続)</li></ul><p>※ 以前はこの他に Public Peering と呼ばれる種別もありましたが、現在は Microsoft Peering に統合されています。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/ExpressRoute%E3%81%AEPublicPeering%E3%81%A8MicrosoftPeering%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%A2%E3%83%8A%E3%82%A6%E3%83%B3%E3%82%B9.html" target="_blank" rel="noopener">ExpressRouteのPublicPeeringとMicrosoftPeeringに関するアナウンス</a></li></ul><p>今回の記事では、<strong>Microsoft Peering</strong> と呼ばれるピアリング種別についてお話します。ExpressRoute 回線で Microsoft Peering を構成すると、オンプレミス拠点から Azure 上のパブリックなサービスに回線経由で接続できます。</p><p>例えば、BLOB ストレージへのバックアップ通信を ExpressRoute 回線経由とすることが出来ます。</p><h2 id="物理的レイヤー"><a href="#物理的レイヤー" class="headerlink" title="物理的レイヤー"></a>物理的レイヤー</h2><p>高レベルな概念としては、オンプレミス拠点と Azure のネットワークを接続するイメージで間違いないのですが、具体的にルーターのレベルで何をやっているか落とし込むと下図のようになります。</p><p><img src="/blog/network/considerations-of-microsoft-peering/microsoft-peering-overview.png" alt="microsoft-peering-overview"></p><p>まず用語を整理すると、次の通りです。</p><ul><li>Microsoft Enterprise Edge (MSEE): Azure 側のエッジ ルーター</li><li>Privider Edge (PE): プロバイダー側のエッジ ルーター</li><li>Customer Edge (CE): お客様拠点のエッジ ルーター</li></ul><p>Azure リソース上で 1 つの ExpressRoute 回線を作成すると、物理的には Azure 側のルーター (MSEE) が 2 つ確保される動作となっています。MSEE は Active/Active で動作するため、万が一片系に障害が発生しても引き続き通信が可能となります。</p><p>なお、ExpressRoute 回線の契約時に選択いただく帯域幅は、各 MSEE で同じだけ確保されます。例えば、200 Mbps を選択頂いた場合、プライマリ側の MSEE でもセカンダリ側の MSEE でも、それぞれ 200 Mbps が確保されます。</p><h3 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h3><p>PE と MSEE の間では、インターネットで一般的に用いられている動的な経路交換プロトコルの <strong>BGPv4</strong> (RFC4271) を利用して、お互いのネットワークの経路情報を交換、学習します。</p><p>BGP でピア (ネイバー) を張るには、PE と MSEE のそれぞれのインターフェイスに IP アドレスを割り当てる必要があり、Microsoft Peering ではこのアドレスをお客様側で準備いただく必要があります。PE と MSEE に払い出す IP アドレスが、セカンダリ/プライマリのそれぞれで必要な為、/30 のグローバル IP アドレスのプレフィクスが 2 つ必要です。</p><p>例えば、203.0.113.0/30 と 203.0.113.4/30 をサブネットに利用する場合は、先の図の通りに IP アドレスが払い出されます。つまり、予約済みでない利用可能 IP アドレスのうち、若番が PE 側に、老番が MSEE 側に払い出されます。<code>traceroute</code> を実行したときに MSEE が応答する IP アドレスの参考としていただければ幸いです。</p><h3 id="経路広報"><a href="#経路広報" class="headerlink" title="経路広報"></a>経路広報</h3><p>オンプレミス側から広報する経路情報は、基本的に、PE ルーターで NAT 用に確保しているアドレス プレフィクスです。後述の通り、この経路情報は <code>Advertised public prefixes</code> のパラメータで指定します。</p><p>例えば 203.0.113.0/28 をオンプレミス/プロバイダー側から広報すれば、Microsoft のパブリック サービスから 203.0.113.0/28 に宛てたパケットは、この ExprsesRoute 回線を経由してフォワーディングされる動作となります。このため、オンプレミス側から Azure への通信を 203.0.113.0/28 を SNAT することで、戻り通信が対称的に返ってくるようになります。</p><p>一方で、Azure 側から広報する経路情報は、<strong>ルート フィルター (route filter)</strong> と呼ばれる Azure リソースを利用で指定することが出来ます。逆に言えば、ルート フィルターで広報するまで、Azure 側からは一切経路が広報されません。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/how-to-routefilter-portal" target="_blank" rel="noopener">ExpressRoute:ルート フィルター - Microsoft ピアリング:Azure portal | Microsoft Docs</a></li></ul><h3 id="BGP-コミュニティ"><a href="#BGP-コミュニティ" class="headerlink" title="BGP コミュニティ"></a>BGP コミュニティ</h3><p>ルート フィルターでは、<strong>BGP コミュニティ (BGP Community)</strong> と呼ばれるアドレス プレフィクスの集合を単位として、目的のサービスに適したアドレス帯を Azure 側から広報することが出来ます。</p><p>選択できる BGP コミュニティの一覧は、以下の公式ドキュメントにまとまっています。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#support-for-bgp-communities" target="_blank" rel="noopener">Azure ExpressRoute: ルーティングの要件 | Microsoft Docs</a></li></ul><p>簡単に例を挙げると、東日本リージョンのリージョン BGP コミュニティ (12076:51012) をルートフィルターで選択すれば、東日本リージョンで利用しているすべてのパブリック IP アドレスとの通信が ExpressRoute 回線を経由するようになります。</p><h3 id="その他の参考情報"><a href="#その他の参考情報" class="headerlink" title="その他の参考情報"></a>その他の参考情報</h3><p>より詳細については、以下の公式ドキュメントやブログ等をご参考にしていただければ幸いです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-circuit-peerings#expressroute-peering" target="_blank" rel="noopener">Azure ExpressRoute: 回線とピアリング | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-faqs#microsoft-peering" target="_blank" rel="noopener">よくあるご質問 (FAQ) - Azure ExpressRoute | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/expressroute-deep-dive-part1" target="_blank" rel="noopener">詳説 Azure ExpressRoute - Part1: ExpressRoute を導入する前に | Microsoft Docs</a></li></ul><h2 id="導入手順"><a href="#導入手順" class="headerlink" title="導入手順"></a>導入手順</h2><p>Microsoft Peering は、大まかに以下の手順で構成いただけます。</p><ol><li>ExpressRoute 回線リソースを作成</li><li>プロバイダー側でプロビジョニング作業を実施</li><li>Microsoft Peeirng の構成を実施</li><li>NAT アドレス利用の承認を待機</li><li>ルートフィルターを構成</li></ol><p>Azure Portal 上での操作方法等は公式ドキュメントに記載されておりますので、詳細はこちらをご覧ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><p>続くセクションでは、導入に際してご留意いただく必要がある点を幾つかご紹介します。</p><h3 id="注意点-プロビジョニング作業の要不要"><a href="#注意点-プロビジョニング作業の要不要" class="headerlink" title="注意点: プロビジョニング作業の要不要"></a>注意点: プロビジョニング作業の要不要</h3><p>まずはじめに注意が必要なのは、手順 2. のプロビジョニング作業です。多くの ExpressRoute 回線プロバイダーでは、回線のプロビジョニング作業を代行して実施するサービスを提供しており、その場合はお客様側で実際に作業が必要となる工程は存在いたしません (このような回線プロバイダーは、L3 プロバイダーと呼ばれることもあります)。</p><p>一方で、お客様側でルーターの管理/構成を実施する必要のある回線プロバイダー (L2 プロバイダーと呼ばれます) も存在します。L2 プロバイダーの場合は、インターフェイスへの IP の割り当て、BGP、経路広報の設定といったルーターの構成を、お客様ご自身で実施して頂く必要があります。お客様の所有するルーターの構成方法については弊サポートでご支援することが叶わない為、プロビジョニング時の技術支援に関しては、別途ベンダー様にお問い合わせいただく必要があります。</p><p>以下の弊社エンジニアによる発表スライド (p10–12) でも L2 / L3 プロバイダーの違いを簡単にご説明をしていますので、こちらも併せてご参考ください。</p><ul><li><a href="https://eventmarketing.blob.core.windows.net/mstechsummit2018-after/CI27_PDF_TS18.pdf" target="_blank" rel="noopener">詳説 Azure ExpressRoute | 発表スライド</a></li><li><a href="https://www.youtube.com/watch?v=xBI-RA8wLqc" target="_blank" rel="noopener">[TS18] CI27 | 詳説 Azure ExpressRoute</a></li></ul><h3 id="注意点-Microsoft-Peering-構成時のパラメータ"><a href="#注意点-Microsoft-Peering-構成時のパラメータ" class="headerlink" title="注意点: Microsoft Peering 構成時のパラメータ"></a>注意点: Microsoft Peering 構成時のパラメータ</h3><p>次に、手順 3. で Microsoft Peering 構成時に入力する項目 (パラメータ) についてです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#to-create-microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><p>基本的な説明は上記ドキュメント内に記載されていますが、特にご質問をいただくことが多いパラメータについて以下で簡単に説明させていただきます。</p><p><strong>アドバタイズされたパブリック プレフィクス (Advertised public prefixes)</strong>:</p><p>オンプレミス側のルーターから広報するプレフィックスをご設定ください。10.x.x.x/28 等のプライベート IP アドレス (RFC 1918) は利用できず、ICANN や RIR から分配されたグローバル IP アドレスを利用する必要があります。<br>Microsoft Peering は、グローバル IP アドレス (いわゆるインターネット) の世界でルーティングを変更するサービスです。一般に、オンプレミス拠点のプライベート ネットワークからインターネットに出ていく際は、グローバル IP アドレスで SNAT する必要がありますが、その NAT アドレスのプールが <code>Advertised public prefixes</code> に該当することが一般的です。</p><p><strong>顧客 ASN (Customer ASN)</strong>:</p><p>前述の <code>Advertised public prefixes</code> として設定されるパブリック IP アドレスが、Peer AS と異なる AS に所属している場合に設定が必要となる場合があります。例えば、PE ルーターではプロバイダーの AS 番号 (これは <code>Peer AS</code> と呼ばれるパラメータです) を利用し、<code>Advertised public prefixes</code> はお客様所有の AS (これが <code>Customer AS</code> です) のパブリック IP アドレスを利用する場合などが該当します。</p><p><strong>ルーティング レジストリ名 (Routing registry name)</strong>:</p><p>BGP ハイジャッキングを防止する目的で、<code>Advertised public prefixes</code> がお客様所有のパブリック IP アドレスかを確認・検証しております。この検証時に RIR / IRR のデータベースを参照しますので、当該アドレスの割り当て元にあたる機関をご選択ください。</p><h3 id="注意点-Advertised-public-prefixes-の手動検証"><a href="#注意点-Advertised-public-prefixes-の手動検証" class="headerlink" title="注意点: Advertised public prefixes の手動検証"></a>注意点: Advertised public prefixes の手動検証</h3><p>選択したルーティング レジストリ (RIR/IRR) のデータベースに <code>Advertised public prefixes</code> が存在しない場合、システムによる自動検証が失敗します。この場合、サポート窓口お問い合わせをいただくことで、担当部門で手動の検証を実施することが出来ます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-routing-portal-resource-manager#to-create-microsoft-peering" target="_blank" rel="noopener">Azure ExpressRoute: ピアリングの構成 | Microsoft Docs</a></li></ul><blockquote><p>‘検証が必要です’ というメッセージが表示された場合は、ルーティング レジストリにプレフィックスの所有者として一覧表示されているエンティティによって組織にパブリック プレフィックスが割り当てられていることを示すドキュメントを収集し、下に示すようにサポート チケットを開くことにより、これらのドキュメントを手動検証のために送信してください。</p></blockquote><p>お問い合わせの際には、承認を受ける ExpressRoute 回線を対象製品としてご選択ください。また、手動検証には以下の 5 つの情報が必要となりますので、こちらの情報を含めてご起票いただければスムーズに手動検証が実施出来ます。</p><ul><li>ExpressRoute 回線のサービス キー</li><li>ExpressRoute 回線をデプロイしたリージョン</li><li><code>Advertised public prefixes</code> (オンプレミス拠点から広報するパブリック IP アドレス)</li><li><code>Peer ASN</code> (MSEE と BGP ピアを張る AS 番号。<code>Customer ASN</code> ではありません)</li><li><code>Advertised public prefixes</code> を <code>Peer ASN</code> で利用出来ることを示す証跡。例えば、他社様から借り受けたグローバル IP アドレスであれば、借り受けたことを示すメールの文面や pdf の文書等が該当します</li></ul><h3 id="注意点-O365-利用時の承認について"><a href="#注意点-O365-利用時の承認について" class="headerlink" title="注意点: O365 利用時の承認について"></a>注意点: O365 利用時の承認について</h3><p>BGP コミュニティのうち、”その他の Office 365 Online サービス” (12076:5100) を選択するには、事前に Microsoft から承認を受ける必要があります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#service-to-bgp-community-value" target="_blank" rel="noopener">Azure ExpressRoute: ルーティングの要件 | Microsoft Docs</a></li></ul><blockquote><p>** Microsoft からの承認が必要です。「Microsoft ピアリングにルート フィルターを構成する\」を参照してください</p></blockquote><p>承認のフォームは以下のリンクから提供しておりますが、フォーム冒頭にも記載がある通り、法的規制などにより閉域網接続の正当性が認められる金融機関などのお客様を除いては、原則申請は承認されない点については予めご留意ください。</p><ul><li><a href="https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRyOZxByRF1dLgv7k6ye5z8pUQkdLRTQ5QkcyOTU3VkNEOFdOWk9IRDZTUy4u" target="_blank" rel="noopener">ExpressRoute for Office 365 Request Form</a></li></ul><blockquote><p>Microsoft authorization is required to use ExpressRoute for Office 365. Microsoft reviews every customer request and authorizes ExpressRoute for Office 365 usage when a customer’s regulatory requirement mandates direct connectivity. If you have such requirements, please provide the text excerpt and web link to the regulation which you interpret to mean that direct connectivity is required in the ExpressRoute for Office 365 Request Form to begin a Microsoft review. </p><p>(抄訳)<br>ExpressRoute for Office 365 のご利用には Microsoft による承認が必要です。<br>Microsoft では、お客様の申請を検証して、閉域網での接続がお客様の規制要件によって義務付けられていると判断した場合に限り、ExpressRoute for Office 365 の使用を承認しています。<br>そのような要件がある場合は、ExpressRoute for Office 365 リクエスト フォームにて、閉域網接続が必要であることを示す規制文章の抜粋や Web リンクを提供してください。</p></blockquote><h2 id="Microsoft-Peering-に関する-FAQ"><a href="#Microsoft-Peering-に関する-FAQ" class="headerlink" title="Microsoft Peering に関する FAQ"></a>Microsoft Peering に関する FAQ</h2><p>最後に、頻繁にお問い合わせをいただくものの、公式ドキュメントには掲載のないご質問について簡単に回答を掲載させていただきます。</p><p>公式ドキュメントの FAQ ページは以下からアクセス出来ますので、こちらも併せてご参考としていただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/expressroute-faqs" target="_blank" rel="noopener">よくあるご質問 (FAQ) - Azure ExpressRoute | Microsoft Docs</a></li></ul><p>以下でも解決できないご不明点等がありましたら、ご利用の ExpressRoute 回線を対象製品として選択いただき、弊社技術サポートまでお問い合わせいただければ幸いです。</p><h3 id="Q-選択すべき-BGP-コミュニティはどれですか"><a href="#Q-選択すべき-BGP-コミュニティはどれですか" class="headerlink" title="Q. 選択すべき BGP コミュニティはどれですか?"></a>Q. 選択すべき BGP コミュニティはどれですか?</h3><p>BGP コミュニティでは、サービス カットで IP アドレスを集約していません。そのため、ある 1 つのサービス (製品) を利用する為に、複数 BGP コミュニティの広報が必要となる場合があります。</p><p>必要な BGP コミュニティはサービスの通信要件に依存しますので、通信要件が不明であれば、Azure Portal から技術サポートを起票する際の製品選択において該当するサービス名を選択し、弊社の技術サポートまでお問い合わせください。</p><h3 id="Q-ルート-フィルターで広報経路を追加した際の影響はありますか"><a href="#Q-ルート-フィルターで広報経路を追加した際の影響はありますか" class="headerlink" title="Q. ルート フィルターで広報経路を追加した際の影響はありますか?"></a>Q. ルート フィルターで広報経路を追加した際の影響はありますか?</h3><p>基本的には、新たに経路を追加しても既存の通信に関して影響が出ることはありません。</p><p>ただ、SLA で無影響 (ダウンタイムが発生しないこと) を保証している訳ではなく、さらにプロバイダー側やお客様でご利用されているルーターの動作については保証いたしかねます。少しでも影響が懸念される場合は、夜間帯等での作業実施を推奨させていただきます。</p><h3 id="Q-回線の切り替え時にはダウンタイムは発生しますか"><a href="#Q-回線の切り替え時にはダウンタイムは発生しますか" class="headerlink" title="Q. 回線の切り替え時にはダウンタイムは発生しますか?"></a>Q. 回線の切り替え時にはダウンタイムは発生しますか?</h3><p>はい。別の回線に切り替える際には NAT アドレス (Advertised public prefixes) も変わることが一般的ですので、既存回線の PE で NAT されている既存セッションは切断されることが期待されます。</p><h3 id="Q-Azure-から広報する経路をフィルターできますか"><a href="#Q-Azure-から広報する経路をフィルターできますか" class="headerlink" title="Q. Azure から広報する経路をフィルターできますか?"></a>Q. Azure から広報する経路をフィルターできますか?</h3><p>恐れ入りますが、現時点 (2020/06/13) では Azure から広報する経路を ExpressRoute 回線でフィルタリングする機能は提供がございません。別の言い方をすれば、BGP コミュニティよりも小さい単位で経路を広報することが出来ません。<br>PE ルーター、あるいはお客様拠点のルーターで経路のフィルタリングをご実施ください。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure Networking テクニカル サポートの山口です。&lt;/p&gt;
&lt;p&gt;Azure のネットワークとオンプレミス拠点ネットワークを直接接続する ExpressRoute と呼ばれるサービスがあります。ExpressRoute では利用目的に応じた複数のピアリング方法が用意されているのですが、今回は Microsoft Peering と呼ばれるピアリング サービスについて注目して、その構築時に留意いただく必要のあるポイントをいくつかご紹介したいと思います。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
      <category term="Microsoft Peering" scheme="https://jpaztech.github.io/blog/tags/Microsoft-Peering/"/>
    
  </entry>
  
  <entry>
    <title>Azure 環境における Windows Server 2019 の日本語の言語パック適用手順について</title>
    <link href="https://jpaztech.github.io/blog/vm/win2019-jp-lpk/"/>
    <id>https://jpaztech.github.io/blog/vm/win2019-jp-lpk/</id>
    <published>2020-06-10T08:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.522Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの山下です。</p><p>Azure Marketplace における Windows Server イメージは、基本的に英語版をベースとしたものが公開されておりますが、言語パックをインストールいただくことで、表示言語を日本語に変更してご利用いただくことが可能でございます。しかしながら、現在の Windows Server 2019 においては、Windows Server 2016 とは手順が異なることから、下記画像の赤枠のように日本語を追加したにも関わらず、表示言語に日本語を設定できないというお問い合わせをよくいただきます。<br><img src="/blog/vm/win2019-jp-lpk/1-issue.png" alt="">  </p><p>そこで今回は Windows Server 2019 における日本語の言語パックの適用手順についてご紹介させていただきます。</p><p>なお、Windows Server 2016 以前の手順については、以下の Blog 記事をご参照いただけますと幸いです。</p><blockquote><p>Azure 環境における Windows Server の日本語環境化について<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc</a>  </p></blockquote><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>言語パックのインストールは、更新プログラムやアプリをインストールする前に実施いただく必要があります。詳細は以下の弊社公開情報をご確認くださいますと幸いです。</p><blockquote><p>Windows イメージへの言語の追加 - 考慮事項<br><a href="https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/add-language-packs-to-windows#considerations" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/add-language-packs-to-windows#considerations</a>  </p><blockquote><p>言語をインストールしてから、更新プログラムとアプリをインストールします。 アプリまたは更新プログラム (サービス スタック更新プログラム (SSU) または累積更新プログラム (CU) など) を既に含むイメージに言語を追加する場合は、アプリと更新プログラムを再インストールします。</p></blockquote></blockquote><h2 id="適用手順"><a href="#適用手順" class="headerlink" title="適用手順"></a>適用手順</h2><p>以下の操作は Windows Server 2019 の Azure VM 上で行います。  </p><ol><li><p>下記より言語パックの iso ファイルをダウンロードします。  </p><blockquote><p>Windows Server 2019 デスクトップ エクスペリエンスの言語パックを構成できない<br><a href="https://support.microsoft.com/ja-jp/help/4466511/cannot-configure-language-pack-for-windows-server-2019" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/4466511/cannot-configure-language-pack-for-windows-server-2019</a><br>※ 方法 2: LPKSetupを使用 の手順 1 の [ここ] をクリックすることでダウンロードが可能です。<br>※ ダウンロード先の URL が変更される可能性もございますので、本記事では公開情報へのリンクを紹介しております。<br><img src="/blog/vm/win2019-jp-lpk/2-lpk-dl.png" alt="">  </p></blockquote></li><li><p>ダウンロードした言語パックをマウントします。下記画像では、E ドライブにマウントしています。<br><img src="/blog/vm/win2019-jp-lpk/3-mount.png" alt="">  </p></li><li><p>Windows キー を押下、”lpksetup.exe” と入力し、検索結果から起動します。<br><img src="/blog/vm/win2019-jp-lpk/4-lpksetup.png" alt="">  </p></li><li><p>“Install display languages” をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/5-install.png" alt="">  </p></li><li><p>[Browse…] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/6-browse.png" alt="">  </p></li><li><p>“マウントされている言語パックのドライブ” &gt; “x64” &gt;  “langpacks” &gt; “Microsoft-Windows-Server-LanguagePack_x64_ja-jp” を選択し、[OK] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/7-select-ja-jp.png" alt="">  </p></li><li><p>Language 欄に「Japanese(日本語)」が表示されたことを確認し、[Next] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/8-select2.png" alt="">  </p></li><li><p>「マイクロソフト ソフトウェア追加ライセンス契約」の内容をご確認いただき、問題がなければ、”I accept the license terms. (同意する)” ラジオボタンにチェックを入れ、[Next] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/9-license.png" alt="">  </p></li><li><p>「Japanese(日本語)」のインストールが完了しましたら、[Close] をクリックします。<br><img src="/blog/vm/win2019-jp-lpk/10-completed.png" alt="">  </p></li><li><p>“Setting”  &gt; ”Time &amp; Language” &gt; “Language” を開き、[Language pack installed] が表示されていることを確認し、プルダウンより [日本語] を選択します。<br><img src="/blog/vm/win2019-jp-lpk/11-language.png" alt="">  </p></li><li><p>Windows display language に [日本語] が表示され、次回サインイン時に表示言語が切り替わることを示す [Will be display language after next sign-in] が表示されていることを確認し、一度サインアウトします。<br><img src="/blog/vm/win2019-jp-lpk/12-select-jp.png" alt="">  </p></li><li><p>サインインしなおすことで、表示言語が日本語になったことをご確認ください。下記画像はサーバー マネージャー の表示例です。<br><img src="/blog/vm/win2019-jp-lpk/13-servermanager-jp.png" alt="">  </p></li></ol><p>表示言語の切り替え後、更新プログラムやアプリのインストールをご実施ください。<br>タイムゾーンの変更等の手順は Windows Server 2016 と同様となりますので、再掲となりますが、以下の Blog 記事をご参照いただきますようお願い申し上げます。</p><blockquote><p>Azure 環境における Windows Server の日本語環境化について<br><a href="https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/japanese_langpack_etc</a></p></blockquote><p>こちらの情報が、少しでも皆様のご参考となれば幸いでございます。</p><style>#article-entry img{  border: 1px royalblue solid !important;}</style>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの山下です。&lt;/p&gt;
&lt;p&gt;Azure Marketplace における Windows Server イメージは、基本的に英語版をベースとしたものが公開されておりますが、言語パックをインストールいただくことで、表示言語を
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway の証明書関連のトラブルシューティング</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-troubleshooting-cert/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-troubleshooting-cert/</id>
    <published>2020-05-11T03:30:00.000Z</published>
    <updated>2020-11-30T09:42:06.490Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム檜山です。</p><p>今回は Application Gateway の証明書まわりについてよくお問い合わせをいただくものをご紹介させていただきます。</p><hr><p>Application Gateway をご利用時に証明書が関連する設定としては、リスナーと HTTP 設定があります。<br>リスナーはクライアントからのアクセスを受け付ける部分で、HTTP 設定はバックエンドの Web サーバーへ接続するための定義を行う部分となります。Application Gateway の設定や構成例については以下もご参照ください。</p><ul><li><a href="https://jpaztech1.z11.web.core.windows.net/ApplicationGateway%E3%81%AE%E6%A7%8B%E6%88%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6.html" target="_blank" rel="noopener">Application Gateway の構成について</a></li></ul><p>Application Gateway にて End to End の TLS (クライアントからバックエンドまですべて HTTPS による通信) を構成する場合、リスナーとバックエンドの Web サーバーにて証明書を構成する必要があります (HTTP 設定も構成により証明書の設定が必要)。</p><p><img src="/blog/network/appgw-troubleshooting-cert/TLS-End2End.png" alt="TLS-End2End"></p><p>End to End の TLS にはせずに、クライアントと Application Gateway の間だけを TLS 化する場合は、バックエンドのサーバーや HTTP 設定に対する証明書の設定は必要ありません。Application Gateway に証明書を設定したり、証明書の更新などを行う場合、どちらの証明書が必要か、どの証明書の更新が必要かなどを区別して考える必要があります。</p><p><img src="/blog/network/appgw-troubleshooting-cert/TLS-Offload.png" alt="TLS-Offload"></p><p><span id="application-gateway-error"></span></p><h2 id="Application-Gateway-へアクセスした際の証明書エラー"><a href="#Application-Gateway-へアクセスした際の証明書エラー" class="headerlink" title="Application Gateway へアクセスした際の証明書エラー"></a><a href="#application-gateway-error">Application Gateway へアクセスした際の証明書エラー</a></h2><p>FQDN を使用して Application Gateway のフロントエンド IP アドレスにアクセスした際に証明書のエラーが出る場合、リスナーの証明書に問題がある可能性があります。ブラウザ/ OS により動作が変わる場合があるので、念のため、複数のブラウザ/ OS にてご確認いただくことをお勧めいたします。</p><h4 id="出力例"><a href="#出力例" class="headerlink" title="出力例"></a>出力例</h4><p>Windows の Firefox ブラウザ<br><img src="/blog/network/appgw-troubleshooting-cert/Windows-FireFox.jpg" alt="Windows-Firefox"></p><p>Windows の Chrome ブラウザ<br><img src="/blog/network/appgw-troubleshooting-cert/Windows-Chrome.png" alt="Windows-Chrome"></p><p>Linux の curl コマンド</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;xxxxx.com</span><br><span class="line">curl: (60) SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">More details here: https:&#x2F;&#x2F;curl.haxx.se&#x2F;docs&#x2F;sslcerts.html</span><br><span class="line"></span><br><span class="line">curl failed to verify the legitimacy of the server and therefore could not</span><br><span class="line">establish a secure connection to it. To learn more about this situation and</span><br><span class="line">how to fix it, please visit the web page mentioned above.</span><br></pre></td></tr></table></figure><p>念のため、以下の点についてもご確認ください。</p><ul><li>証明書の CN (Common Name) と URL で指定した FQDN があってない</li><li>証明書の有効期限が切れている</li><li>自己証明書を使用しており、ルート証明書とのチェーンの検証で失敗している</li><li>リスナーに登録した証明書に中間証明書が含まれていない</li></ul><p>4 点目の中間証明書についてですが、リスナーに登録した証明書に中間証明書が含まれていない場合、証明書の検証に失敗し、エラーになる場合があることを確認しております。(クライアントやブラウザによって動作が異なりますが、特に Linux 系のクライアントにて失敗することを確認済)<br>そのため、Application Gateway のリスナーに登録する PFX 形式の証明書は中間証明書を含む形で構成いただく必要がございます。</p><p>Edge や Chrome ブラウザの場合、クライアント側で中間証明書を補完するため、中間証明書に起因する問題が発生しているかがわからないことがあります。その場合、下記に記載の openssl コマンドにて証明書の状態を確認することが可能ですので、念のためご確認いただくことをお勧めいたします。</p><p><span id="probe-error"></span></p><h2 id="正常性プローブのエラー"><a href="#正常性プローブのエラー" class="headerlink" title="正常性プローブのエラー"></a><a href="#probe-error">正常性プローブのエラー</a></h2><p>Application Gateway V2 のバックエンドプールにて証明書が正しく構成されていない場合、バックエンド正常性の画面に以下のエラーが出ることがあります。</p><p><img src="/blog/network/appgw-troubleshooting-cert/RootCert.png" alt="RootCert"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The root certificate of the server certificate used by the backend does not match the trusted root certificate added to the application gateway.</span><br><span class="line">Ensure that you add the correct root certificate to whitelist the backend</span><br><span class="line">(バックエンドによって使用されるサーバー証明書のルート証明書が、アプリケーション ゲートウェイに追加されている信頼されたルート証明書と一致しません。バックエンドをホワイトリストに登録するために適切なルート証明書を追加していることを確認してください。)</span><br></pre></td></tr></table></figure><p>以下は SNI が不一致している場合の例。<br><img src="/blog/network/appgw-troubleshooting-cert/SNI-error.png" alt="SNI-Error"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The Common Name (CN) of the backend certificate does not match the host header of the probe. </span><br><span class="line">(バックエンド証明書の共通名 (CN) が probe のホスト ヘッダーと一致しません。)</span><br></pre></td></tr></table></figure><p>原因としては以下が考えられます。</p><ul><li>証明書の CN (Common Name) と 正常性プローブの SNI が一致していない</li><li>証明書の有効期限が切れている</li><li>自己証明書を使用しており、ルート証明書とのチェーンの検証で失敗している</li><li>証明書に中間証明書が含まれていない</li></ul><p>バックエンド側にバインドされている証明書の構成が正しいかどうかについても、下記に記載の openssl コマンドにて証明書の状態を確認することが可能ですので、念のためご確認いただくことをお勧めいたします。</p><p><span id="openssl-command"></span></p><h2 id="openssl-コマンドによる確認方法"><a href="#openssl-コマンドによる確認方法" class="headerlink" title="openssl コマンドによる確認方法"></a><a href="#openssl-command">openssl コマンドによる確認方法</a></h2><p>openssl はオープンソースのソフトウェアで Linux 系の OS で利用することができます。<br>Windows OS (Windows 10) の場合でも Windows Subsystem for Linux (WSL) を導入することで利用可能となります。</p><p>以下のコマンドを実行し、実行結果の CN が正しいか、エラーが表示されていないかを等を確認します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Application Gateway への接続確認]</span><br><span class="line">openssl s_client -connect &lt;Application Gateway の IP アドレス&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">[バックエンドへの接続確認]</span><br><span class="line">openssl s_client -connect &lt;バックエンドの IP アドレス&gt;:443 -servername &lt;FQDN&gt; -showcerts</span><br><span class="line"></span><br><span class="line">※バックエンドが内部 IP の場合は同一 VNET 上の VM からコマンドの実施を行ってください。</span><br></pre></td></tr></table></figure><p>以下の例の赤字部分のようなエラーが表示された場合、使用している証明書に中間証明書が含まれていない可能性がありますので、証明書の構成をご確認ください。</p><p>例 )<br>openssl s_client -connect 52.224.201.173:443 -servername azurecerttest.testacert.com -showcerts</p><p>CONNECTED(00000003)</p><p>depth=0 OU = Domain Control Validated, CN = azurecerttest.testacert.com</p><p><span style="color: red">verify error:num=20:unable to get local issuer certificate</span></p><p>verify return:1</p><p>depth=0 OU = Domain Control Validated, CN = azurecerttest.testacert.com</p><p><span style="color: red">verify error:num=21:unable to verify the first certificate</span></p><p>verify return:1</p><p>～省略～</p><p>Timeout   : 7200 (sec)</p><p><span style="color: red">Verify return code: 21 (unable to verify the first certificate)</span></p><p><span id="intermediate-cert"></span></p><h2 id="中間証明書の構成方法"><a href="#中間証明書の構成方法" class="headerlink" title="中間証明書の構成方法"></a><a href="#intermediate-cert">中間証明書の構成方法</a></h2><p>AppService 証明書を Powershell で Export した場合は中間証明書が含まれていない構成となり、別途、中間証明書を含む形で構成する必要があります。</p><p>AppService 証明書を Azure Portal, Azure CLI でエクスポートした場合、中間証明書は含まれた状態となりますので問題ありませんが、証明書のパスワードを明示的に設定する必要があります。その場合も以下の手順を実施することでパスワードを設定できますのでご利用ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/app-service/configure-ssl-certificate#export-certificate" target="_blank" rel="noopener">App Service 証明書を管理する (証明書をエクスポートします。)</a></li></ul><p>他の証明書においても PFX 形式の証明書に中間証明書が含まれていない場合、Windows 端末にて以下の手順を実施することで中間証明書を含む形で PFX 形式の証明書を構成可能ですので、お試しください。</p><p>※ 以下は Windows 10 の手順ですので、OS によっては少し手順が異なる場合がございます。</p><p>【証明書のインポート &amp; エクスポート】</p><ol><li><p>Azure ポータルから Export した証明書 (PFX) を Windows 端末の任意の場所に配置します。</p></li><li><p>証明書をダブルクリックし、”現在のユーザー” を選択し、”次へ” をクリックします。 </p></li><li><p>インポートするファイルが選択されていることを確認し、”次へ” をクリックします。</p></li><li><p>証明書の“パスワード” を入力し、”このキーをエクスポート可能にする” にチェックをいれ “次へ” をクリックします。<br>※証明書の ”パスワード” が空の場合は ”パスワード” を空にしたまま、”次へ” をクリックします。</p></li><li><p>“証明書の種類に基づいて、自動的に証明書ストアを選択する” を選択し、”次へ” をクリックします。</p></li><li><p>“完了” をクリックします。</p></li><li><p>Windows 端末の左下の Windows マークをクリックし、”certmgr.msc” と入力し、Enter キーを押します。</p></li><li><p>“個人” &gt; “証明書” をクリックし、Import した証明書を右クリックし、”すべてのタスク” &gt; “エクスポート” をクリックします。</p></li><li><p>最初の画面で “次へ” をクリックします。</p></li><li><p>秘密キーのエクスポート画面で “はい、秘密キーをエクスポートします” を選択肢、”次へ” をクリックします。</p></li><li><p>“証明のパスにある証明書を可能であればすべて含む” にチェックが入っていることを確認し、”次へ” をクリックします。</p></li><li><p>証明書の “パスワード” を設定して、”暗号化” が ”TripleDES-SHA1” であることを確認し、”次へ” をクリックします。</p></li><li><p>配置場所を選択して、証明書のファイル名を入力し、”次へ” をクリックします。</p></li><li><p>“完了” をクリックします。</p></li></ol><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="リスナーに設定した証明書の更新時に切断は発生しますか？"><a href="#リスナーに設定した証明書の更新時に切断は発生しますか？" class="headerlink" title="- リスナーに設定した証明書の更新時に切断は発生しますか？"></a>- リスナーに設定した証明書の更新時に切断は発生しますか？</h4><p>現時点で確認できている動作として V1, V2 共に証明書の更新時に数秒程度の切断が発生することを確認できております。そのため、少しの切断も許容されない環境である場合は、メンテナンス期間等の影響が少ないタイミングで更新いただくことをご検討ください。</p><h4 id="PFX-証明書の中身を確認する方法はありますか？"><a href="#PFX-証明書の中身を確認する方法はありますか？" class="headerlink" title="- PFX 証明書の中身を確認する方法はありますか？"></a>- PFX 証明書の中身を確認する方法はありますか？</h4><p>以下のコマンドを実施することで証明書の構成を確認することができます。</p><p>【Windows】</p><p>コマンドプロンプトで以下を実施します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -dump &quot;ファイルのパス&#x2F;xxxxx.pfx&quot;</span><br></pre></td></tr></table></figure><p>【Linux】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -info -in &lt;ファイルのパス&#x2F;xxxxx.pfx&gt;</span><br></pre></td></tr></table></figure><h4 id="利用可能な証明書の一覧はありますか？"><a href="#利用可能な証明書の一覧はありますか？" class="headerlink" title="- 利用可能な証明書の一覧はありますか？"></a>- 利用可能な証明書の一覧はありますか？</h4><p>公開情報として利用可能な証明書の情報はありません。<br>公開情報の要件を満たす証明書であれば利用可能です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview#certificates-supported-for-tls-termination" target="_blank" rel="noopener">TLS 終了でサポートされる証明書</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits" target="_blank" rel="noopener">Application Gateway の制限</a></li></ul><h4 id="ポータルから証明書を削除する方法はありますか？"><a href="#ポータルから証明書を削除する方法はありますか？" class="headerlink" title="- ポータルから証明書を削除する方法はありますか？"></a>- ポータルから証明書を削除する方法はありますか？</h4><p>現状、ポータルから証明書を削除する方法は提供されておりません。以下の Powershell or Azure CLI のコマンドにて削除可能ですので、ご確認ください。使用中の証明書は削除できませんので、証明書が利用されていないことを事前にご確認ください。<br>また、HTTP 設定用の証明書削除手順は V1, V2 SKU でコマンドが異なりますので、ご留意ください。</p><ul><li>証明書削除 (リスナー用)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. Application Gateway の情報を取得します。</span><br><span class="line">$appgw &#x3D; Get-AzApplicationGateway -Name &quot;アプリケーション ゲートウェイ名&quot; -ResourceGroupName &quot;リソース グループ名&quot;</span><br><span class="line"> </span><br><span class="line">2. 削除したい SSL サーバー証明書の名前を指定します。</span><br><span class="line">Remove-AzApplicationGatewaySslCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"> </span><br><span class="line">3. Application Gateway に設定を反映します。</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway ssl-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><ul><li>証明書削除 (HTTP 設定用 [V1 のバックエンド認証用証明書])</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. 対象の Application Gateway を取得します。</span><br><span class="line">$appgw &#x3D; Get-AzApplicationGateway -Name &quot;Application Gateway 名&quot; -ResourceGroupName &quot;ResourceGroup 名&quot;</span><br><span class="line"> </span><br><span class="line">2. 既存のサーバ証明書を削除します。※現在登録されている証明書名を指定します。</span><br><span class="line">Remove-AzApplicationGatewayAuthenticationCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"></span><br><span class="line">3. Application Gateway に設定を反映します</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway auth-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><ul><li>証明書削除 (HTTP 設定用 [V2 のルート証明書])</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Powershell】</span><br><span class="line">1. 対象の Application Gateway を取得します。</span><br><span class="line">$appgw &#x3D; Get-AzApplicationGateway -Name &quot;Application Gateway 名&quot; -ResourceGroupName &quot;ResourceGroup 名&quot;</span><br><span class="line"></span><br><span class="line">2. 既存のルート証明書を削除します。※現在登録されている証明書名を指定します。</span><br><span class="line">Remove-AzApplicationGatewayTrustedRootCertificate -ApplicationGateway $appgw -Name &quot;証明書名&quot;</span><br><span class="line"></span><br><span class="line">3. Application Gateway に設定を反映します</span><br><span class="line">Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">【Azure CLI】</span><br><span class="line">az network application-gateway root-cert delete -g &lt;リソースグループ名&gt; --gateway-name &lt;Application Gateway 名&gt; -n &lt;証明書名&gt;</span><br></pre></td></tr></table></figure><p><span id="reference"></span></p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference">参考情報</a></h2><p>Application Gateway のトラブルシューティングについては以下にも情報がございますので、ご参照ください。</p><ul><li><a href="./application-gateway-troubleshooting-502">Application Gateway での無効なゲートウェイによるエラーのトラブルシューティング</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting" target="_blank" rel="noopener">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></li></ul><p>証明書の要件については以下にも記載がありますので、ご参照ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/ssl-overview" target="_blank" rel="noopener">Application Gateway での TLS 終了とエンド ツー エンド TLS の概要</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Application Gateway の証明書まわりについてよくお問い合わせをいただくものをご紹介させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Application Gateway を
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="ApplicationGateway" scheme="https://jpaztech.github.io/blog/tags/ApplicationGateway/"/>
    
      <category term="Certficate" scheme="https://jpaztech.github.io/blog/tags/Certficate/"/>
    
      <category term="SSL" scheme="https://jpaztech.github.io/blog/tags/SSL/"/>
    
  </entry>
  
</feed>
